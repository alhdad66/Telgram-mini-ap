<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="app_title">Pepe Coin XO Competition</title>
    
    <!-- Adsgram SDK -->
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            /* Changed primary and secondary colors to vibrant green shades */
            --primary: #00BF63; /* Vibrant Green */
            --primary-dark: #008C4A; /* Darker shade for shadows */
            --secondary: #32CD32; /* Lime Green, for a more vibrant accent */
            --secondary-dark: #28A745; /* Darker shade of secondary */
            
            --dark: #121212;
            --darker: #0a0a0a;
            --light: #f5f5f5;
            --gray: #2a2a2a;
            --card-bg: #1f1f1f;
            --gold: #ffd700;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--darker), #1a1a2e);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow-x: hidden;
            flex-direction: column; /* Allow content and debug log to stack */
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(0, 191, 99, 0.1) 0%, transparent 20%), /* Adjusted for green */
                radial-gradient(circle at 90% 80%, rgba(50, 205, 50, 0.1) 0%, transparent 20%); /* Adjusted for green */
            z-index: -1;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background: var(--card-bg);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 20px; /* Space for the debug log */
        }
        
        .header {
            /* Header gradient adjusted for green */
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            padding: 25px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, 
                rgba(255,255,255,0.1) 0%,
                rgba(255,255,255,0) 50%,
                rgba(255,255,255,0.1) 100%);
            z-index: 1;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
        }
        
        .content {
            padding: 25px;
        }
        
        .user-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .user-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        /* Updated .stats to center the single card */
        .stats {
            display: flex;
            justify-content: center; /* Center the single card */
            margin: 20px 0;
            text-align: center;
        }
        
        /* Enlarged stat-card for earned points */
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px 30px; /* Increased padding */
            width: 80%; /* Made it wider */
            max-width: 300px; /* Max width to keep it reasonable */
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            margin-bottom: 20px; /* Space between points card and ad container */
        }
        
        .stat-card h3 {
            font-size: 18px; /* Larger font for title */
            margin-bottom: 10px; /* More space */
            color: #aaa;
        }
        
        .stat-card .value {
            font-size: 36px; /* Significantly larger font for value */
            font-weight: 700;
            color: var(--primary); 
        }
        
        .progress-container {
            margin: 25px 0;
            text-align: center;
        }
        
        .progress-label {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            /* Progress bar fill adjusted for green */
            background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            border-radius: 10px;
            width: 30%;
            transition: width 0.5s ease;
        }
        
        .buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 25px 0;
        }
        
        /* 3D Button Styles - Adjusted for green */
        .btn-3d {
            position: relative;
            padding: 16px 20px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: white;
            text-align: center;
            transition: all 0.2s ease;
            transform-style: preserve-3d;
            perspective: 500px;
            /* Box shadow uses primary-dark for depth */
            box-shadow: 
                0 8px 0 var(--primary-dark), 
                0 15px 20px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            z-index: 1;
        }
        
        .btn-3d::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Gradient background for button surface */
            background: linear-gradient(45deg, var(--primary), var(--secondary)); 
            z-index: -1;
            transition: all 0.3s ease;
        }
        
        .btn-3d::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            /* Shiny effect on hover */
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.2), 
                transparent);
            transition: all 0.5s ease;
            z-index: -1;
        }
        
        .btn-3d:hover {
            transform: translateY(4px);
            /* Adjust shadow on hover */
            box-shadow: 
                0 4px 0 var(--primary-dark),
                0 8px 10px rgba(0, 0, 0, 0.3);
        }
        
        .btn-3d:hover::after {
            left: 100%;
        }
        
        .btn-3d:active {
            transform: translateY(8px);
            /* Flatten shadow on click */
            box-shadow: 
                0 0 0 var(--primary-dark),
                0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .btn-secondary {
            /* Secondary button uses secondary-dark for shadow */
            box-shadow: 
                0 8px 0 var(--secondary-dark), 
                0 15px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn-secondary::before {
            /* Secondary button background gradient */
            background: linear-gradient(45deg, var(--secondary), var(--primary-dark)); 
        }
        
        .btn-blue { /* This class is now essentially the same as btn-3d due to shared primary/secondary colors */
            box-shadow: 
                0 8px 0 var(--primary-dark), 
                0 15px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn-blue::before {
            background: linear-gradient(45deg, var(--primary), var(--secondary)); 
        }
        
        .website-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        
        .website-section h3 {
            color: var(--secondary); 
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .footer {
            text-align: center;
            padding: 15px;
            color: #777;
            font-size: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .firebase-logo {
            display: inline-block;
            margin-top: 10px;
            font-size: 10px;
            background: rgba(255, 152, 0, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            color: #ffa726;
        }
        
        .ad-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .ad-label {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 10px;
        }
        
        /* Animation for ad watching */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 0.5s ease;
        }
        
        .ad-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        /* Responsive design */
        @media (max-width: 480px) {
            .container {
                border-radius: 15px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .content {
                padding: 20px;
            }
            .tap-area {
                width: 180px; /* Adjust size for smaller screens */
                height: 180px;
            }
            .tap-area img {
                width: 100%; /* Make image fill for smaller screens */
                height: 100%;
            }
            .tap-area h2 {
                font-size: 36px;
            }
            .tap-area p {
                font-size: 16px;
            }
            .stat-card { /* Adjust for smaller screens */
                width: 95%;
                padding: 15px 20px;
            }
            .stat-card h3 {
                font-size: 16px;
            }
            .stat-card .value {
                font-size: 30px;
            }
        }
        
        /* Language Selector Styles - Active button gradient adjusted for green */
        .language-selector {
            position: absolute;
            top: 15px; 
            right: 15px; 
            display: flex;
            gap: 5px;
            z-index: 999; 
            background-color: rgba(0, 0, 0, 0.3); 
            border-radius: 10px; 
            padding: 5px; 
            backdrop-filter: blur(5px); 
        }
        .language-selector button {
            width: auto;
            padding: 5px 10px;
            font-size: 13px;
            background-color: rgba(255, 255, 255, 0.1); 
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px; 
            cursor: pointer;
            min-width: 30px;
            transition: all 0.2s ease; 
        }
        .language-selector button.active {
            background: linear-gradient(45deg, var(--primary), var(--secondary)); 
            border-color: var(--primary); 
        }
        .language-selector button:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.2); 
        }

        /* Withdrawal Section Styles - Adapted to be integrated */
        .withdraw-section {
            margin-top: 20px;
            display: none; /* Hidden by default, shown by JS */
            padding: 25px; 
            background-color: rgba(255, 255, 255, 0.05); 
            border-radius: 15px; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .withdraw-section h3 {
            color: var(--secondary); 
            margin-bottom: 5px; 
            font-size: 20px;
            font-weight: 600;
        }
        .withdraw-section .warning-message { 
            font-size: 13px;
            color: #FFC107; 
            margin-bottom: 15px;
            line-height: 1.4;
            white-space: pre-wrap; 
            background: rgba(255, 215, 0, 0.1); /* Light gold background for warning */
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #FFD700;
        }
        .withdraw-section input, 
        .withdraw-section select { 
            width: 100%;
            padding: 12px;
            margin: 10px 0; 
            border-radius: 10px; 
            border: 1px solid var(--primary); 
            background-color: var(--dark); 
            color: var(--light);
            font-size: 14px;
        }
        .withdraw-section input::placeholder {
            color: #aaa;
        }
        .withdraw-section input:focus, 
        .withdraw-section select:focus {
            border-color: var(--gold); 
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
        }
        .withdraw-section button {
            background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            width: 100%;
            padding: 14px; 
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px; 
            border-radius: 15px; 
            cursor: pointer;
            color: white; 
            border: none; 
            box-shadow: 0 8px 0 var(--primary-dark), 0 15px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }
        .withdraw-section button:hover {
            transform: translateY(4px);
            box-shadow: 0 4px 0 var(--primary-dark), 0 8px 10px rgba(0, 0, 0, 0.3);
            background: linear-gradient(90deg, var(--secondary), var(--primary)); 
        }
        .withdraw-section button:active {
            transform: translateY(8px);
            box-shadow: 
                0 0 0 var(--primary-dark),
                0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .withdraw-section p.current-balance {
            font-size: 18px;
            color: var(--gold);
            margin-bottom: 25px;
            font-weight: 600;
        }

        .back-button-container {
            margin-top: 25px;
            text-align: center;
        }
        .back-button {
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            padding: 10px 20px;
            border-radius: 10px;
            text-decoration: none;
            font-size: 14px;
            transition: background-color 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: inline-block; /* Make it a block for centering */
        }
        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Hamster Kombat Style Tap Area */
        .tap-area {
            background: radial-gradient(circle at center, #2e2e2e 0%, #1a1a1a 100%);
            border-radius: 50%; /* Make it circular */
            margin: 20px auto; /* Center the circular area */
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            position: relative;
            width: 220px; /* Set fixed width and height for a perfect circle */
            height: 220px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5), inset 0 0 20px rgba(0,0,0,0.5); /* Added outer shadow */
            animation: backgroundPulse 5s infinite alternate;
            user-select: none; /* Prevent text selection on tap */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE10+ */
        }

        /* Image inside the tap area */
        .tap-area img {
            width: 100%; /* Make image fill the circle's width */
            height: 100%; /* Make image fill the circle's height */
            object-fit: cover; /* Make image cover the area, cropping if necessary */
            border-radius: 50%; /* Ensure image itself is circular */
            position: absolute; /* Position image absolutely within the tap-area */
            top: 0;
            left: 0;
            z-index: 5; /* Place image behind text but above background pulse */
            transition: transform 0.1s ease;
        }

        .tap-area.active img {
            transform: scale(0.95); /* Shrink image on tap */
        }

        @keyframes backgroundPulse {
            0% { background: radial-gradient(circle at center, #2e2e2e 0%, #1a1a1a 100%); }
            100% { background: radial-gradient(circle at center, #3a3a3a 0%, #2a3a3a 100%); }
        }

        .tap-area h2 {
            font-size: 48px;
            font-weight: 800;
            color: var(--gold);
            margin-bottom: 5px; /* Adjusted margin */
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
            transition: transform 0.1s ease;
            position: relative;
            z-index: 10; /* Ensure text is above image */
        }

        .tap-area p {
            font-size: 18px;
            color: #ccc;
            margin-top: 0; /* Adjusted margin */
            position: relative;
            z-index: 10; /* Ensure text is above image */
        }

        .tap-feedback {
            position: absolute;
            font-size: 40px;
            font-weight: bold;
            color: var(--gold);
            opacity: 0;
            pointer-events: none;
            animation: fadeOutUp 1s forwards;
            text-shadow: 0 0 5px rgba(255,215,0,0.8);
            z-index: 20;
        }

        @keyframes fadeOutUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }

        .tap-button-container {
            margin-top: 20px;
            text-align: center;
        }

        .tap-claim-btn {
            display: none; /* Hidden by default */
            position: relative;
            padding: 16px 30px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            color: white;
            background: linear-gradient(90deg, #28a745, #218838); /* Green gradient */
            box-shadow: 
                0 8px 0 #1e7e34, 
                0 15px 20px rgba(0, 0, 0, 0.4);
            transition: all 0.2s ease;
            transform-style: preserve-3d;
            perspective: 500px;
            overflow: hidden;
            z-index: 1;
        }

        .tap-claim-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #28a745, #218838); 
            z-index: -1;
            transition: all 0.3s ease;
        }
        
        .tap-claim-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            /* Shiny effect on hover */
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.2), 
                transparent);
            transition: all 0.5s ease;
            z-index: -1;
        }
        
        .tap-claim-btn:hover {
            transform: translateY(4px);
            box-shadow: 
                0 4px 0 #1e7e34,
                0 8px 10px rgba(0, 0, 0, 0.3);
        }
        
        .tap-claim-btn:hover::after {
            left: 100%;
        }
        
        .tap-claim-btn:active {
            transform: translateY(8px);
            box-shadow: 
                0 0 0 #1e7e34,
                0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .tap-claim-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 8px 0 #1e7e34, 
                        0 15px 20px rgba(0, 0, 0, 0.4);
        }

        .points-per-tap-message {
            font-size: 16px;
            color: var(--light);
            margin-top: 15px; /* Spacing below the circle/claim button */
            font-weight: 500;
        }

        /* Referral Section Styles */
        .referral-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            display: none; /* Hidden by default */
        }

        .referral-section h3 {
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .referral-link-container {
            display: flex;
            margin-bottom: 15px;
            background-color: var(--dark);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--primary);
        }

        .referral-link-container input {
            flex-grow: 1;
            padding: 10px 15px;
            border: none;
            background: transparent;
            color: var(--light);
            font-size: 14px;
            outline: none;
            cursor: text;
        }

        .referral-link-container button {
            background: var(--primary);
            color: white;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .referral-link-container button:hover {
            background: var(--primary-dark);
        }

        .referral-stats p {
            margin: 5px 0;
            font-size: 14px;
            color: #ccc;
        }

        .referral-stats span {
            font-weight: bold;
            color: var(--gold);
        }

        /* Withdrawal History Styles */
        .withdrawal-history-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none; /* Hidden by default */
        }

        .withdrawal-history-section h3 {
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 18px;
            text-align: center;
        }

        .withdrawal-history-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .withdrawal-item {
            background-color: rgba(255, 255, 255, 0.03);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 13px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .withdrawal-item p {
            margin: 3px 0;
        }

        .withdrawal-item .status-pending {
            color: #FFC107; /* Amber */
            font-weight: bold;
        }

        .withdrawal-item .status-approved {
            color: #00BF63; /* Primary Green */
            font-weight: bold;
        }

        .withdrawal-item .status-rejected {
            color: #DC3545; /* Red */
            font-weight: bold;
        }

        .withdrawal-item .withdrawal-date {
            color: #aaa;
            font-size: 11px;
            margin-top: 5px;
        }

        .no-withdrawals-message {
            text-align: center;
            color: #ccc;
            font-style: italic;
            padding: 20px;
        }


        /* Debug Log Styles */
        #debug-log {
            background-color: rgba(0, 0, 0, 0.7);
            color: #00FF00; /* Green text for logs */
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 10px;
            padding: 10px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            max-width: 500px; /* Match container width */
            margin-top: 10px; /* Space from main container */
            border: 1px solid rgba(0, 255, 0, 0.2);
            white-space: pre-wrap; /* Preserve line breaks */
            word-wrap: break-word; /* Break long words */
        }

        /* XO Game Specific Styles */
        .game-section {
            display: none; /* Hidden by default, shown by JS */
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .game-section h3 {
            color: var(--secondary);
            margin-bottom: 20px;
            font-size: 20px;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(3, 80px);
            grid-template-rows: repeat(3, 80px);
            gap: 5px;
            width: 255px; /* 3*80 + 2*5 */
            height: 255px;
            margin: 0 auto 20px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 5px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .cell {
            width: 80px;
            height: 80px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 48px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            transition: background-color 0.2s ease, transform 0.1s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .cell.x {
            color: #E74C3C; /* Reddish for X */
        }
        .cell.o {
            color: #3498DB; /* Blueish for O */
        }
        .cell:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .cell.win {
            background-color: var(--primary); /* Green for winning cells */
            color: white;
        }
        .game-info {
            margin-bottom: 20px;
        }
        .game-info p {
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--gold);
        }
        #earn-1-point-btn, #earn-5-points-btn {
            margin: 10px;
        }

        /* Leaderboard Section Styles */
        .leaderboard-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none; /* Hidden by default */
        }
        .leaderboard-section h3 {
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 18px;
            text-align: center;
        }
        .leaderboard-section p {
            font-size: 14px;
            color: #ccc;
            text-align: center;
            margin-bottom: 10px;
        }
        .leaderboard-section .competition-info {
            font-size: 15px;
            color: var(--gold);
            margin-bottom: 20px;
            line-height: 1.4;
        }
        .leaderboard-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 10px;
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            margin-bottom: 5px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 14px;
            align-items: center;
        }
        .leaderboard-item:nth-child(odd) {
            background-color: rgba(255, 255, 255, 0.03);
        }
        .leaderboard-item .rank {
            font-weight: bold;
            color: var(--gold);
            min-width: 30px;
        }
        .leaderboard-item .username {
            flex-grow: 1;
            margin-left: 10px;
            text-align: left;
        }
        .leaderboard-item .points {
            font-weight: bold;
            color: var(--primary);
        }
        .your-rank, .your-daily-points {
            font-size: 16px;
            font-weight: bold;
            color: var(--light);
            margin-top: 15px;
        }
        .your-rank span, .your-daily-points span {
            color: var(--gold);
        }
    </style>
</head>
<body>
    <div class="ad-notification" id="ad-notification"></div>
    
    <div class="container">
        <!-- Language Selector -->
        <div class="language-selector">
            <button data-lang="ar" onclick="setLanguage('ar')">AR</button>
            <button data-lang="en" onclick="setLanguage('en')">EN</button>
            <button data-lang="ru" onclick="setLanguage('ru')">RU</button>
        </div>

        <div class="header">
            <h1 data-key="app_title">مسابقة Pepe Coin XO</h1>
        </div>
        
        <div class="content">
            <div class="user-info">
                <p data-key="min_withdrawal_message_static_general">السحب عن طريق FaucetPay من 10 عملات فقط ✅<br>السحب إلى أي محفظة أخرى من 100 عملة فقط ✅</p>
                <p class="user-id-display" data-key="your_user_id">معرف المستخدم: <span id="display-user-id">جار التحميل...</span></p>
            </div>
            
            <!-- Display current Pepe coins (withdrawable) -->
            <div class="stats"> 
                <div class="stat-card">
                    <h3 data-key="earned_pepe_label">عملات Pepe المكتسبة</h3>
                    <div class="value" id="earned-points">0.00</div>
                </div>
            </div>
            
            <!-- Main Game Section (replacing ad-container logic) -->
            <div class="game-section" id="game-section">
                <h3 data-key="xo_game_title">لعبة XO (Tic-Tac-Toe)</h3>
                <div id="board" class="board">
                    <!-- Cells will be generated by JS -->
                </div>
                <div class="game-info">
                    <p id="game-status" data-key="game_status_turn">دور اللاعب: X</p>
                    <button id="reset-game-btn" class="btn-3d btn-secondary" data-key="reset_game_btn" onclick="resetGame()">إعادة اللعبة</button>
                </div>
                <div id="win-options" style="display:none; text-align: center; margin-top: 20px;">
                    <p data-key="choose_reward">لقد فزت! اختر مكافأتك:</p>
                    <button class="btn-3d" id="earn-1-point-btn" data-key="earn_1_point_btn" onclick="earnCompetitionPoints(1)">احصل على 1 نقطة (بدون إعلان)</button>
                    <button class="btn-3d btn-blue" id="earn-5-points-btn" data-key="earn_5_points_btn" onclick="earnCompetitionPoints(5)">احصل على 5 نقاط (مع إعلان)</button>
                </div>
            </div>
            
            <div class="website-section">
                <h3 data-key="visit_channel_title">قم بزيارة قناتنا على تيليجرام</h3>
                <button class="btn-3d btn-blue" onclick="window.open('https://t.me/dogsarn', '_blank')" data-key="visit_channel_button">زيارة القناة</button>
            </div>

            <div class="buttons">
                <!-- Button to show the integrated withdrawal form -->
                <button class="btn-3d btn-blue" id="show-withdraw-btn" onclick="showWithdrawForm()" data-key="withdraw_points_btn">سحب عملات Pepe</button>
                 <!-- Button to show the referral section -->
                <button class="btn-3d btn-blue" id="show-referral-btn" onclick="showReferralSection()" data-key="referral_program_btn">برنامج الإحالة</button>
                 <!-- New: Button to show withdrawal history -->
                 <button class="btn-3d btn-blue" id="show-withdrawal-history-btn" onclick="showWithdrawalHistorySection()" data-key="withdrawal_history_btn">سجل السحوبات</button>
                 <!-- New: Button to show leaderboard -->
                 <button class="btn-3d btn-blue" id="show-leaderboard-btn" onclick="showLeaderboardSection()" data-key="leaderboard_btn">لوحة المتصدرين</button>
            </div>

            <!-- Withdraw Section - Now integrated back into the main page -->
            <div class="withdraw-section" id="withdraw-section">
                <h3 data-key="withdrawal_request_title">طلب السحب</h3>
                <p class="current-balance" data-key="current_balance_label">رصيدك الحالي: <span id="current-earned-points">0.00</span> عملة Pepe</p>
                <p class="warning-message" data-key="withdrawal_warning">تنبيه 🙋🏻‍♂️
الحد الأدنى للسحب عن طريق FaucetPay هو 10 عملات pepe.
الحد الأدنى للسحب إلى أي محفظة أخرى هو 100 عملة pepe.
يرجى التأكد من إدخال عنوان محفظة صحيح لتلقي السحب بدون مشاكل (◍•ᴗ•◍)</p>
                <input type="number" id="withdraw-amount" data-key-placeholder="enter_points_placeholder" placeholder="أدخل الكمية لسحب عملات Pepe" />
                <select id="payment-method"> 
                    <option value="faucetpay" data-key="faucetpay_option">FaucetPay</option>
                    <option value="other_wallet" data-key="other_wallet_option">السحب إلى أي محفظة أخرى</option>
                </select>
                <input type="text" id="wallet-address" data-key-placeholder="wallet_address_placeholder" placeholder="أدخل عنوان المحفظة" /> 
                <button onclick="withdrawPoints()" data-key="withdraw_button">سحب</button>
                <p id="withdraw-status"></p>

                <div class="back-button-container">
                    <!-- Button to hide the withdrawal form -->
                    <a href="#" class="back-button" onclick="hideWithdrawForm(); return false;" data-key="back_to_main_page">العودة إلى الواجهة الرئيسية</a>
                </div>
            </div>

            <!-- Referral Section -->
            <div class="referral-section" id="referral-section">
                <h3 data-key="referral_title">برنامج الإحالة</h3>
                <p data-key="referral_description">ادعُ أصدقائك واكسب 10% من أرباحهم!</p>
                <div class="referral-link-container">
                    <input type="text" id="referral-link" readonly />
                    <button onclick="copyReferralLink()" data-key="copy_link_btn">نسخ الرابط</button>
                </div>
                <div class="referral-stats">
                    <!-- These p elements will be targeted by querySelector to update innerHTML -->
                    <p data-key="total_referrals">الإحالات الكلية: <span id="total-referrals">0</span></p>
                    <p data-key="earned_from_referrals">الربح من الإحالات: <span id="earned-from-referrals">0.00</span> Pepe</p>
                </div>
                <div class="back-button-container">
                    <a href="#" class="back-button" onclick="hideReferralSection(); return false;" data-key="back_to_main_page">العودة إلى الواجهة الرئيسية</a>
                </div>
            </div>

            <!-- Withdrawal History Section -->
            <div class="withdrawal-history-section" id="withdrawal-history-section">
                <h3 data-key="withdrawal_history_title">سجل السحوبات</h3>
                <div id="withdrawal-history-list" class="withdrawal-history-list">
                    <!-- Withdrawal items will be loaded here by JavaScript -->
                    <p class="no-withdrawals-message" data-key="no_withdrawals_yet">لا توجد طلبات سحب حتى الآن.</p>
                </div>
                <div class="back-button-container">
                    <a href="#" class="back-button" onclick="hideWithdrawalHistorySection(); return false;" data-key="back_to_main_page">العودة إلى الواجهة الرئيسية</a>
                </div>
            </div>

            <!-- Leaderboard Section -->
            <div class="leaderboard-section" id="leaderboard-section">
                <h3 data-key="leaderboard_title">لوحة المتصدرين اليومية</h3>
                <p class="competition-info" data-key="competition_info">أفضل 100 مستخدم يجمعون نقاط XP اليومية سيحصلون على مكافآت Pepe! يتم تصفير النقاط يومياً.</p>
                <div class="leaderboard-list" id="leaderboard-list">
                    <!-- Leaderboard items will be loaded here -->
                    <p class="no-leaders-message" data-key="no_leaders_yet">لا توجد نقاط منافسة بعد.</p>
                </div>
                <p class="your-rank" data-key="your_current_rank">ترتيبك الحالي: <span id="current-rank">N/A</span></p>
                <p class="your-daily-points" data-key="your_daily_points">نقاطك اليومية: <span id="current-daily-points">0</span> XP</p>
                <div class="back-button-container">
                    <a href="#" class="back-button" onclick="hideLeaderboardSection(); return false;" data-key="back_to_main_page">العودة إلى الواجهة الرئيسية</a>
                </div>
            </div>

        </div>
        
        <div class="footer">
            <p data-key="footer_text">مؤمن بواسطة Firebase • جميع المعاملات محمية</p>
            <div class="firebase-logo">Firebase</div>
        </div>
    </div>

    <!-- Debug Log Display -->
    <div id="debug-log">
        <h3>سجل التصحيح (Debug Log)</h3>
        <pre id="log-content"></pre>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, onSnapshot, collection, addDoc, query, where, orderBy, limit, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyAOf0KsfC9HlOa7z1VdR31DBcYcJAynrnA",
          authDomain: "adrewardapp-e2755.firebaseapp.com",
          projectId: "adrewardapp-e2755",
          storageBucket: "adrewardapp-e2755.firebasestorage.app",
          messagingSenderId: "978106558327",
          appId: "1:978106558327:web:b567f8c72beb0113e2a372"
        };

        // Global variables for Firebase and Telegram Mini App
        window.firebaseApp = null;
        window.db = null;
        window.telegramUserId = null; 
        window.telegramUsername = null; 
        let isAppReady = false; 

        // Constants
        const POINTS_PER_AD = 1000.00; // This might become deprecated, keeping for now
        const TAPS_REQUIRED = 10; // Deprecated, replaced by XO game
        const ADS_FOR_BONUS = 10; // Deprecated
        const MIN_WITHDRAW_POINTS = 100;
        const MIN_WITHDRAW_POINTS_FAUCETPAY = 10;
        const ADMIN_USER_ID = "-1002705355317"; // Telegram chat ID for the admin
        const BOT_TOKEN = "7380785513:AAFiREK1NUI9kzlFRJwTGP6fVhyw43iBhmk"; 
        const REFERRAL_PERCENTAGE = 0.10;

        // XO Game Specific Constants
        const XO_BOARD_SIZE = 3;
        const PLAYER_X = 'X';
        const PLAYER_O = 'O';
        const WINNING_COMBINATIONS = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
            [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
            [0, 4, 8], [2, 4, 6]             // Diagonals
        ];

        // State variables (controlled by Firestore)
        let earnedPoints = 0.00; // Pepe coins, withdrawable
        let competitionPoints = 0; // Points for daily competition (XP)
        let lastCompetitionDate = ""; // To track last day competition points were earned
        let referrerId = null; 
        let totalReferrals = 0; 
        let earnedFromReferrals = 0.00; 

        // XO Game State
        let board = ['', '', '', '', '', '', '', '', ''];
        let currentPlayer = PLAYER_X;
        let gameActive = true;

        // DOM elements (re-initialized if needed after innerHTML updates)
        const earnedPointsEl = document.getElementById('earned-points');
        const adNotificationEl = document.getElementById('ad-notification');
        
        const withdrawSectionEl = document.getElementById('withdraw-section');
        const withdrawStatusEl = document.getElementById('withdraw-status');
        const currentEarnedPointsEl = document.getElementById('current-earned-points');

        const referralSectionEl = document.getElementById('referral-section');
        const referralLinkInput = document.getElementById('referral-link');
        const totalReferralsParentEl = document.querySelector('p[data-key="total_referrals"]');
        const earnedFromReferralsParentEl = document.querySelector('p[data-key="earned_from_referrals"]');
        let totalReferralsEl = document.getElementById('total-referrals');
        let earnedFromReferralsEl = document.getElementById('earned-from-referrals');

        // New DOM elements for Withdrawal History
        const withdrawalHistorySectionEl = document.getElementById('withdrawal-history-section');
        const withdrawalHistoryListEl = document.getElementById('withdrawal-history-list');

        // New DOM elements for XO Game
        const gameSectionEl = document.getElementById('game-section');
        const boardEl = document.getElementById('board');
        const gameStatusEl = document.getElementById('game-status');
        const resetGameBtn = document.getElementById('reset-game-btn');
        const winOptionsEl = document.getElementById('win-options');
        const earn1PointBtn = document.getElementById('earn-1-point-btn');
        const earn5PointsBtn = document.getElementById('earn-5-points-btn');

        // New DOM elements for Leaderboard
        const leaderboardSectionEl = document.getElementById('leaderboard-section');
        const leaderboardListEl = document.getElementById('leaderboard-list');
        const currentRankEl = document.getElementById('current-rank');
        const currentDailyPointsEl = document.getElementById('current-daily-points');


        const displayUserIdEl = document.getElementById('display-user-id'); 
        const logContentEl = document.getElementById('log-content'); // Debug Log DOM element

        // Custom log function to display messages on screen and console
        function logMessage(message, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            if (isError) {
                logEntry.style.color = 'red';
            }
            logContentEl.appendChild(logEntry);
            logContentEl.scrollTop = logContentEl.scrollHeight; // Auto-scroll to bottom

            if (isError) {
                console.error(message);
            } else {
                console.log(message);
            }
        }

        // Translation logic
        const translations = {
            ar: {
                app_title: "مسابقة Pepe Coin XO",
                min_withdrawal_message_static_general: `السحب عن طريق FaucetPay من ${MIN_WITHDRAW_POINTS_FAUCETPAY} عملات فقط ✅\nالسحب إلى أي محفظة أخرى من ${MIN_WITHDRAW_POINTS} عملة فقط ✅`, 
                earned_pepe_label: "عملات Pepe المكتسبة", 
                footer_text: "مؤمن بواسطة Firebase • جميع المعاملات محمية",
                withdrawal_request_title: "طلب السحب", 
                current_balance_label: "رصيدك الحالي:", 
                withdrawal_warning: `تنبيه 🙋🏻‍♂️\nالحد الأدنى للسحب عن طريق FaucetPay هو ${MIN_WITHDRAW_POINTS_FAUCETPAY} عملات pepe.\nالحد الأدنى للسحب إلى أي محفظة أخرى هو ${MIN_WITHDRAW_POINTS} عملة pepe.\nيرجى التأكد من إدخال عنوان محفظة صحيح لتلقي السحب بدون مشاكل (◍•ᴗ•◍)`, 
                enter_points_placeholder: "أدخل الكمية لسحب عملات Pepe", 
                faucetpay_option: "FaucetPay", 
                other_wallet_option: "السحب إلى أي محفظة أخرى", 
                wallet_address_placeholder: "أدخل عنوان المحفظة", 
                withdraw_button: "سحب", 
                ad_loading: "جاري تحميل الإعلان... يرجى الانتظار",
                ad_completed_success: `اكتمل الإعلان! تمت إضافة {POINTS} نقطة XP إلى حسابك.`, // Updated for XP
                ad_failed: "فشل عرض الإعلان. يرجى المحاولة مرة أخرى.",
                min_withdraw_message: `الحد الأدنى للسحب عن طريق {methodName} هو {minAmount} عملة pepe.`, 
                insufficient_balance: `رصيدك غير كافٍ. لديك {earnedPoints} عملة pepe.`, 
                enter_wallet_address: "يرجى إدخال عنوان المحفظة.", 
                withdrawal_success_message: 'تم إرسال طلب السحب بنجاح!', 
                telegram_send_fail: `فشل إرسال الطلب: {error}`, 
                telegram_connect_error: `خطأ في الاتصال بخدمة تيليجرام: {error}`, 
                unknown_method: "طريقة غير معروفة:", 
                back_to_main_page: "العودة إلى الواجهة الرئيسية", 
                withdraw_points_btn: "سحب عملات Pepe", 
                referral_program_btn: "برنامج الإحالة",
                referral_title: "برنامج الإحالة",
                referral_description: `ادعُ أصدقائك واكسب ${REFERRAL_PERCENTAGE * 100}% من أرباحهم!`,
                copy_link_btn: "نسخ الرابط",
                total_referrals: "الإحالات الكلية:",
                earned_from_referrals: "الربح من الإحالات:",
                link_copied_success: "تم نسخ رابط الإحالة بنجاح!",
                your_user_id: "معرف المستخدم:",
                loading_app: "جاري تحميل التطبيق...", 
                not_mini_app: "لم يتم تشغيل التطبيق كتطبيق تيليجرام مصغر.",
                error_loading_user: "خطأ في تحميل بيانات المستخدم.",
                telegram_id_missing: "معرف تيليجرام مفقود.", 
                withdrawal_history_btn: "سجل السحوبات",
                withdrawal_history_title: "سجل السحوبات",
                withdrawal_status_pending: "معلق",
                withdrawal_status_approved: "تمت الموافقة",
                withdrawal_status_rejected: "مرفوض",
                no_withdrawals_yet: "لا توجد طلبات سحب حتى الآن.",
                withdrawal_details: "المبلغ: {amount} | الطريقة: {method} | العنوان: {address} | الحالة: {status}",
                withdrawal_date: "التاريخ: {date}",
                
                // New XO Game Translations
                xo_game_title: "لعبة XO (Tic-Tac-Toe)",
                game_status_turn: "دور اللاعب: {player}",
                game_status_win: "اللاعب {player} فاز!",
                game_status_draw: "تعادل!",
                reset_game_btn: "إعادة اللعبة",
                choose_reward: "لقد فزت! اختر مكافأتك:",
                earn_1_point_btn: "احصل على 1 نقطة (بدون إعلان)",
                earn_5_points_btn: "احصل على 5 نقاط (مع إعلان)",
                game_not_active: "اللعبة غير نشطة، أعد تعيينها لبدء اللعب.",

                // New Leaderboard Translations
                leaderboard_btn: "لوحة المتصدرين",
                leaderboard_title: "لوحة المتصدرين اليومية",
                competition_info: "أفضل 100 مستخدم يجمعون نقاط XP اليومية سيحصلون على مكافآت Pepe! يتم تصفير النقاط يومياً.",
                your_current_rank: "ترتيبك الحالي:",
                your_daily_points: "نقاطك اليومية:",
                no_leaders_yet: "لا توجد نقاط منافسة بعد.",
                leaderboard_item_format: "#{rank} {username}: {points} XP"
            },
            en: {
                app_title: "Pepe Coin XO Competition", 
                min_withdrawal_message_static_general: `Withdrawal via FaucetPay from ${MIN_WITHDRAW_POINTS_FAUCETPAY} pepe coins only ✅\nWithdrawal to Any Other Wallet from ${MIN_WITHDRAW_POINTS} pepe coins only ✅`, 
                earned_pepe_label: "Earned Pepe Coins", 
                footer_text: "Secured by Firebase • All transactions are protected",
                withdrawal_request_title: "Withdrawal Request", 
                current_balance_label: "Your Current Balance:", 
                withdrawal_warning: `Warning 🙋🏻‍♂️\nMinimum withdrawal for FaucetPay is ${MIN_WITHDRAW_POINTS_FAUCETPAY} pepe coins.\nMinimum withdrawal for Any Other Wallet is ${MIN_WITHDRAW_POINTS} pepe coins.\nPlease ensure you enter a correct wallet address for smooth withdrawals (◍•ᴗ•◍)`, 
                enter_points_placeholder: "Enter Amount to Withdraw Pepe Coins", 
                faucetpay_option: "FaucetPay", 
                other_wallet_option: "Withdraw to Any Other Wallet", 
                wallet_address_placeholder: "Enter Wallet Address", 
                withdraw_button: "Withdraw", 
                ad_loading: "Loading ad... Please wait",
                ad_completed_success: `Ad completed! +{POINTS} XP points added to your account.`, // Updated for XP
                ad_failed: "Failed to show ad. Please try again.",
                min_withdraw_message: `Minimum withdrawal for {methodName} is {minAmount} pepe coins.`, 
                insufficient_balance: `Insufficient balance. You have {earnedPoints} Pepe Coins.`, 
                enter_wallet_address: "Please enter the wallet address.", 
                withdrawal_success_message: 'Withdrawal request sent successfully!', 
                telegram_send_fail: `Failed to send request: {error}`, 
                telegram_connect_error: `Error connecting to Telegram service: {error}`, 
                unknown_method: "Unknown Method:", 
                back_to_main_page: "Back to Main Page", 
                withdraw_points_btn: "Withdraw Pepe Coins", 
                referral_program_btn: "Referral Program",
                referral_title: "Referral Program",
                referral_description: `Invite your friends and earn ${REFERRAL_PERCENTAGE * 100}% of their earnings!`,
                copy_link_btn: "Copy Link",
                total_referrals: "Total Referrals:",
                earned_from_referrals: "Earned from Referrals:",
                link_copied_success: "Referral link copied successfully!",
                your_user_id: "User ID:",
                loading_app: "Loading App...", 
                not_mini_app: "App not launched as Telegram Mini App.",
                error_loading_user: "Error loading user data.",
                telegram_id_missing: "Telegram ID missing.", 
                withdrawal_history_btn: "Withdrawal History",
                withdrawal_history_title: "Withdrawal History",
                withdrawal_status_pending: "Pending",
                withdrawal_status_approved: "Approved",
                withdrawal_status_rejected: "Rejected",
                no_withdrawals_yet: "No withdrawal requests yet.",
                withdrawal_details: "Amount: {amount} | Method: {method} | Address: {address} | Status: {status}",
                withdrawal_date: "Date: {date}",

                // New XO Game Translations
                xo_game_title: "XO Game (Tic-Tac-Toe)",
                game_status_turn: "Player {player}'s Turn",
                game_status_win: "Player {player} Wins!",
                game_status_draw: "Draw!",
                reset_game_btn: "Reset Game",
                choose_reward: "You won! Choose your reward:",
                earn_1_point_btn: "Earn 1 Point (No Ad)",
                earn_5_points_btn: "Earn 5 Points (With Ad)",
                game_not_active: "Game not active, reset to play.",

                // New Leaderboard Translations
                leaderboard_btn: "Leaderboard",
                leaderboard_title: "Daily Leaderboard",
                competition_info: "Top 100 users with daily XP will receive Pepe rewards! Points reset daily.",
                your_current_rank: "Your Current Rank:",
                your_daily_points: "Your Daily Points:",
                no_leaders_yet: "No competition points yet.",
                leaderboard_item_format: "#{rank} {username}: {points} XP"
            },
            ru: {
                app_title: "Конкурс Pepe Coin XO", 
                min_withdrawal_message_static_general: `Вывод через FaucetPay от ${MIN_WITHDRAW_POINTS_FAUCETPAY} монет pepe только ✅\nВывод на любой другой кошелек от ${MIN_WITHDRAW_POINTS} монет pepe только ✅`, 
                earned_pepe_label: "Заработано монет Pepe", 
                footer_text: "Защищено Firebase • Все транзакции защищены",
                withdrawal_request_title: "Запрос на вывод", 
                current_balance_label: "Ваш текущий баланс:", 
                withdrawal_warning: `Внимание 🙋🏻‍♂️\nМинимальная сумма вывода для FaucetPay составляет ${MIN_WITHDRAW_POINTS_FAUCETPAY} монет pepe.\nМинимальная сумма вывода для любого другого кошелька составляет ${MIN_WITHDRAW_POINTS} монет pepe.\nПожалуйста, убедитесь, что вы ввели правильный адрес кошелька для беспроблемного вывода средств (◍•ᴗ•◍)`, 
                enter_points_placeholder: "Введите сумму для вывода монет Pepe", 
                faucetpay_option: "FaucetPay", 
                other_wallet_option: "Вывод на любой другой кошелек", 
                wallet_address_placeholder: "Введите адрес кошелька", 
                withdraw_button: "Вывести", 
                ad_loading: "Загрузка рекламы... Пожалуйста, подождите",
                ad_completed_success: `Реклама завершена! +{POINTS} XP очков добавлено на ваш счет.`, // Updated for XP
                ad_failed: "Не удалось показать рекламу. Пожалуйста, попробуйте еще раз.",
                min_withdraw_message: `Минимальная сумма вывода для {methodName} составляет {minAmount} монет pepe.`, 
                insufficient_balance: `Недостаточный баланс. У вас {earnedPoints} монет pepe.`, 
                enter_wallet_address: "Пожалуйста, введите адрес кошелька.", 
                withdrawal_success_message: 'Запрос на вывод успешно отправлен!', 
                telegram_send_fail: `Не удалось отправить запрос: {error}`, 
                telegram_connect_error: `Ошибка подключения к службе Telegram: {error}`, 
                unknown_method: "Неизвестный метод:", 
                back_to_main_page: "Вернуться на главную страницу", 
                withdraw_points_btn: "Вывести монеты Pepe", 
                referral_program_btn: "Реферальная программа",
                referral_title: "Реферальная программа",
                referral_description: `Приглашайте друзей и зарабатывайте ${REFERRAL_PERCENTAGE * 100}% от их заработка!`,
                copy_link_btn: "Копировать ссылку",
                total_referrals: "Всего рефералов:",
                earned_from_referrals: "Заработано с рефералов:",
                link_copied_success: "Реферальная ссылка успешно скопирована!",
                your_user_id: "ID пользователя:",
                loading_app: "Загрузка приложения...", 
                not_mini_app: "Приложение запущено не как мини-приложение Telegram.",
                error_loading_user: "Ошибка загрузки пользовательских данных.",
                telegram_id_missing: "Telegram ID отсутствует.", 
                withdrawal_history_btn: "История вывода",
                withdrawal_history_title: "История вывода",
                withdrawal_status_pending: "В ожидании",
                withdrawal_status_approved: "Одобрено",
                withdrawal_status_rejected: "Отклонено",
                no_withdrawals_yet: "Пока нет запросов на вывод.",
                withdrawal_details: "Сумма: {amount} | Метод: {method} | Адрес: {address} | Статус: {status}",
                withdrawal_date: "Дата: {date}",

                // New XO Game Translations
                xo_game_title: "Игра XO (Крестики-нолики)",
                game_status_turn: "Ход игрока: {player}",
                game_status_win: "Игрок {player} победил!",
                game_status_draw: "Ничья!",
                reset_game_btn: "Начать заново",
                choose_reward: "Вы выиграли! Выберите свою награду:",
                earn_1_point_btn: "Получить 1 очко (без рекламы)",
                earn_5_points_btn: "Получить 5 очков (с рекламой)",
                game_not_active: "Игра не активна, перезапустите, чтобы начать играть.",

                // New Leaderboard Translations
                leaderboard_btn: "Таблица лидеров",
                leaderboard_title: "Ежедневная таблица лидеров",
                competition_info: "100 лучших пользователей, набравших ежедневные очки XP, получат награды Pepe! Очки сбрасываются ежедневно.",
                your_current_rank: "Ваш текущий ранг:",
                your_daily_points: "Ваши ежедневные очки:",
                no_leaders_yet: "Пока нет очков соревнований.",
                leaderboard_item_format: "#{rank} {username}: {points} XP"
            }
        };

        let currentLanguage = localStorage.getItem('appLanguage') || 'ar'; 
        let currentSection = 'main'; 

        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); 
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            let date;
            if (timestamp.toDate) { // Firestore Timestamp object
                date = timestamp.toDate();
            } else if (typeof timestamp === 'number') { // JavaScript timestamp
                date = new Date(timestamp);
            } else { // Assume it's an ISO string or similar
                date = new Date(timestamp);
            }

            if (isNaN(date.getTime())) {
                logMessage("Invalid date format for timestamp: " + timestamp, true);
                return '';
            }

            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleDateString(currentLanguage, options);
        }


        window.setLanguage = function(lang) {
            currentLanguage = lang;
            localStorage.setItem('appLanguage', lang);
            document.documentElement.lang = lang; 

            document.querySelectorAll('.language-selector button').forEach(button => {
                if (button.dataset.lang === lang) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.dataset.key;
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'INPUT' && element.hasAttribute('data-key-placeholder')) {
                        element.placeholder = translations[lang][key];
                    } else if (key === 'ad_completed_success') {
                        // This translation now expects {POINTS} for XP
                        // It will be handled when calling showAdNotification
                    } else if (key.startsWith('game_status_')) {
                        // Handled by updateGameStatus()
                    }
                    else {
                        element.textContent = translations[lang][key];
                    }
                }
            });

            document.querySelectorAll('[data-key-placeholder]').forEach(element => {
                const placeholderKey = element.dataset.keyPlaceholder;
                if (translations[lang] && translations[lang][placeholderKey]) {
                    element.placeholder = translations[lang][placeholderKey];
                }
            });

            document.querySelectorAll('#payment-method option').forEach(option => {
                const key = option.dataset.key;
                if (translations[lang] && translations[lang][key]) {
                    option.textContent = translations[lang][key];
                }
            });

            earnedPointsEl.textContent = earnedPoints.toFixed(2); 
            // Update daily competition points display
            currentDailyPointsEl.textContent = `${competitionPoints} XP`;

            // Update game status translation
            updateGameStatus();
            updateReferralUI();
            updateLeaderboardUI(); // Update leaderboard UI for language

            if (window.telegramUserId) {
                displayUserIdEl.textContent = window.telegramUserId;
            } else if (!isAppReady) {
                displayUserIdEl.textContent = translations[currentLanguage].loading_app;
            } else { 
                 displayUserIdEl.textContent = translations[currentLanguage].telegram_id_missing;
            }
        };

        async function initApp() {
            logMessage("initApp: Starting app initialization.");
            displayUserIdEl.textContent = translations[currentLanguage].loading_app; 

            setTimeout(async () => {
                try {
                    logMessage("Telegram.WebApp object check: window.Telegram exists: " + (typeof window.Telegram !== 'undefined'));
                    logMessage("Telegram.WebApp object check: window.Telegram.WebApp exists: " + (typeof window.Telegram.WebApp !== 'undefined'));
                    
                    if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp) {
                        window.Telegram.WebApp.ready();
                        window.Telegram.WebApp.expand();
                        document.body.style.backgroundColor = window.Telegram.WebApp.themeParams.bg_color || '#1a1a2e';
                        document.body.style.color = window.Telegram.WebApp.themeParams.text_color || '#f5f5f5';
                        logMessage("Telegram.WebApp initialized and expanded.");

                        logMessage("Full Telegram.WebApp.initData: " + window.Telegram.WebApp.initData);
                        try {
                            const parsedInitData = new URLSearchParams(window.Telegram.WebApp.initData);
                            logMessage("Parsed initData parameters:");
                            for (const [key, value] of parsedInitData.entries()) {
                                logMessage(`  Param: ${key}, Value: ${value}`);
                            }
                        } catch (parseError) {
                            logMessage("Error parsing Telegram.WebApp.initData: " + parseError.message, true);
                        }
                        
                        logMessage("Telegram.WebApp.initDataUnsafe: " + JSON.stringify(window.Telegram.WebApp.initDataUnsafe));
                        logMessage("Telegram.WebApp.initDataUnsafe.user: " + (window.Telegram.WebApp.initDataUnsafe ? JSON.stringify(window.Telegram.WebApp.initDataUnsafe.user) : 'undefined/null user object'));

                        if (window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user && window.Telegram.WebApp.initDataUnsafe.user.id) {
                            window.telegramUserId = window.Telegram.WebApp.initDataUnsafe.user.id.toString();
                            window.telegramUsername = window.Telegram.WebApp.initDataUnsafe.user.username || ''; 
                            logMessage("SUCCESS: Telegram User ID obtained: " + window.telegramUserId);
                            logMessage("SUCCESS: Telegram Username obtained: " + (window.telegramUsername || 'N/A (No username set)'));

                            displayUserIdEl.textContent = window.telegramUserId; 
                        } else {
                            logMessage("FAILURE: Telegram User ID NOT available. initDataUnsafe.user.id is missing.", true);
                            displayUserIdEl.textContent = translations[currentLanguage].telegram_id_missing; 
                            isAppReady = false; 
                            updateButtonStates(); 
                            return; 
                        }

                        // Initialize Firebase
                        if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                            logMessage("Firebase config is missing or incomplete.", true);
                            showAdNotification(translations[currentLanguage].error_loading_user + " (Firebase config missing)");
                            isAppReady = false;
                            updateButtonStates();
                            return;
                        }
                        
                        const appId = firebaseConfig.projectId; 
                        window.firebaseApp = initializeApp(firebaseConfig);
                        window.db = getFirestore(window.firebaseApp);
                        logMessage("Firebase initialized.");

                        // Load user data using Telegram User ID
                        await loadUserDataFromFirestore(appId, window.telegramUserId); 
                        logMessage("User data load initiated and Firestore listener set up.");

                        // Handle Back Button in Telegram Mini App
                        window.Telegram.WebApp.onEvent('backButtonClicked', handleBackButtonClick);
                        updateBackButtonVisibility(); 

                        isAppReady = true; 
                        logMessage("App is now fully ready (isAppReady = true).");

                        // Process startapp parameter from Telegram initData - REFERRAL LOGIC FIX
                        const urlParams = new URLSearchParams(window.Telegram.WebApp.initData); 
                        const ref = urlParams.get('start_param'); 
                        logMessage("REFERRAL LOGIC: start_param from WebApp.initData: " + (ref || 'Not found')); 

                        if (ref && ref.startsWith('ref_')) {
                            const foundReferrerId = ref.substring(4); 
                            logMessage("REFERRAL LOGIC: Extracted referrerId from start_param: " + foundReferrerId);
                            logMessage("REFERRAL LOGIC: Current user ID (telegramUserId): " + window.telegramUserId);
                            
                            if (foundReferrerId !== window.telegramUserId) { 
                                logMessage("REFERRAL LOGIC: Referrer ID is different from current user ID. Proceeding to check/set referrer and increment counts.");
                                referrerId = foundReferrerId; // Store it globally for Firestore listener
                                
                                const userDocRef = doc(window.db, `artifacts/${appId}/users`, window.telegramUserId);
                                
                                const userDocSnap = await getDoc(userDocRef);

                                if (userDocSnap.exists()) {
                                    if (!userDocSnap.data().referrerId) {
                                        logMessage(`REFERRAL LOGIC: User ${window.telegramUserId} exists but has no referrer. Setting referrerId: ${referrerId}`);
                                        await updateDoc(userDocRef, { referrerId: referrerId }, { merge: true });
                                        logMessage(`REFERRAL LOGIC: Successfully set referrerId ${referrerId} for user ${window.telegramUserId}.`);

                                        const referrerRef = doc(window.db, `artifacts/${appId}/users`, referrerId);
                                        logMessage("REFERRAL LOGIC: Attempting to increment totalReferrals for referrer: " + referrerId);
                                        const referrerDocSnap = await getDoc(referrerRef);
                                        if (referrerDocSnap.exists()) {
                                            await updateDoc(referrerRef, { totalReferrals: increment(1) });
                                            logMessage(`REFERRAL LOGIC: Successfully incremented totalReferrals for ${referrerId}.`);
                                        } else {
                                            logMessage(`REFERRAL LOGIC WARNING: Referrer document for ${referrerId} does not exist. Cannot increment totalReferrals. (Maybe referrer needs to open app first?).`, true);
                                        }
                                    } else {
                                        logMessage(`REFERRAL LOGIC: User ${window.telegramUserId} already has referrerId: ${userDocSnap.data().referrerId}. Skipping new referrer assignment and totalReferrals increment.`);
                                    }
                                } else {
                                    logMessage(`REFERRAL LOGIC: User document for ${window.telegramUserId} doesn't exist yet. ReferrerId ${referrerId} will be set upon doc creation.`);
                                }
                            } else {
                                logMessage("REFERRAL LOGIC: Current user ID is the same as referrer ID. Self-referral attempt detected and ignored for stat increment.");
                            }
                        } else {
                            logMessage("REFERRAL LOGIC: No valid 'ref_' start_param found in initData.");
                        }

                    } else {
                        logMessage("FAILURE: Telegram WebApp SDK not found or not ready. App not running as a Mini App.", true);
                        showAdNotification(translations[currentLanguage].not_mini_app);
                        displayUserIdEl.textContent = translations[currentLanguage].not_mini_app;
                        isAppReady = false;
                    }

                } catch (error) {
                    logMessage("FATAL ERROR during app initialization (caught by setTimeout): " + error.message, true);
                    showAdNotification(translations[currentLanguage].error_loading_user);
                    displayUserIdEl.textContent = translations[currentLanguage].error_loading_user; 
                    isAppReady = false; 
                } finally {
                    updateButtonStates(); 
                    setLanguage(currentLanguage); 
                }
            }, 100); 
        }

        async function loadUserDataFromFirestore(appId, userId) {
            logMessage("loadUserDataFromFirestore: Attempting to load data for user: " + userId);
            if (!window.db || !userId || !appId) {
                logMessage("loadUserDataFromFirestore: Firestore, User ID, or App ID not ready (or Telegram ID missing). Skipping data load.", true);
                return;
            }

            const userDocRef = doc(window.db, `artifacts/${appId}/users`, userId);

            onSnapshot(userDocRef, (docSnap) => {
                logMessage("Firestore onSnapshot: Data received for user: " + userId);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    earnedPoints = data.earnedPoints || 0.00;
                    referrerId = data.referrerId || null; 
                    totalReferrals = data.totalReferrals || 0;
                    earnedFromReferrals = data.earnedFromReferrals || 0.00;
                    competitionPoints = data.competitionPoints || 0; // Load new competition points
                    lastCompetitionDate = data.lastCompetitionDate || ""; // Load last competition date

                    logMessage(`CURRENT ACCOUNT ${userId} DATA: Main Balance (earnedPoints): ${earnedPoints.toFixed(2)}, Daily XP (competitionPoints): ${competitionPoints}, Total Referrals: ${totalReferrals}, Earned from Referrals: ${earnedFromReferrals.toFixed(2)}`);

                    const todayDate = getTodayDate();
                    // Reset daily competition points if it's a new day
                    if (lastCompetitionDate !== todayDate) {
                        competitionPoints = 0;
                        logMessage("Firestore onSnapshot: New day detected, resetting daily competition points.");
                        // Use a transaction to safely reset if a win happens concurrently
                        runTransaction(window.db, async (transaction) => {
                            const sfDoc = await transaction.get(userDocRef);
                            if (sfDoc.exists) {
                                transaction.update(userDocRef, { competitionPoints: 0, lastCompetitionDate: todayDate });
                            }
                        }).then(() => {
                            logMessage("Firestore: Daily competition points reset for new day successfully.");
                        }).catch((error) => {
                            logMessage("Firestore Error: transaction for resetting daily competition points: " + error.message, true);
                        });
                    }
                    logMessage("User data loaded/updated from Firestore via onSnapshot: " + JSON.stringify(data));
                } else {
                    logMessage("Firestore onSnapshot: User document not found, creating new one for user: " + userId);
                    earnedPoints = 0.00;
                    competitionPoints = 0;
                    lastCompetitionDate = getTodayDate();
                    totalReferrals = 0;
                    earnedFromReferrals = 0.00;
                    
                    setDoc(userDocRef, {
                        earnedPoints: earnedPoints,
                        competitionPoints: competitionPoints,
                        lastCompetitionDate: lastCompetitionDate,
                        referrerId: referrerId, 
                        totalReferrals: totalReferrals,
                        earnedFromReferrals: earnedFromReferrals
                    })
                    .then(async () => {
                        logMessage("Firestore: New user document created successfully. Now checking to increment referrer's count.");
                        if (referrerId) {
                            const referrerRef = doc(window.db, `artifacts/${appId}/users`, referrerId);
                            logMessage(`Firestore: Attempting to increment totalReferrals for newly referred user's referrer (${referrerId}).`);
                            const referrerDocSnap = await getDoc(referrerRef);
                            if (referrerDocSnap.exists()) {
                                await updateDoc(referrerRef, { totalReferrals: increment(1) });
                                logMessage(`Firestore: Successfully incremented totalReferrals for ${referrerId}.`);
                            } else {
                                logMessage(`Firestore Warning: Referrer document for ${referrerId} does not exist. Cannot increment totalReferrals.`, true);
                            }
                        }
                    })
                    .catch(e => logMessage("Firestore Error: creating user document: " + e.message, true));
                }
                updateUI(); 
                updateReferralUI();
                updateLeaderboardUI(); // Update leaderboard UI on user data change
                updateButtonStates(); 
            }, (error) => {
                logMessage("Firestore Error: listening to user document in Firestore: " + error.message, true);
                showAdNotification(translations[currentLanguage].error_loading_user);
            });
        }
        
        function updateUI() {
            earnedPointsEl.textContent = earnedPoints.toFixed(2); 
            currentDailyPointsEl.textContent = `${competitionPoints} XP`;
            updateGameStatus(); // Update game status to ensure player turn is translated

            earnedPointsEl.classList.remove('pulse');
            void earnedPointsEl.offsetWidth; 
            earnedPointsEl.classList.add('pulse');

            updateButtonStates(); 
        }

        function updateButtonStates() {
            const disableButtons = !isAppReady || !window.telegramUserId;

            // Enable/disable navigation buttons
            document.getElementById('show-withdraw-btn').disabled = disableButtons;
            document.getElementById('show-referral-btn').disabled = disableButtons;
            document.getElementById('show-withdrawal-history-btn').disabled = disableButtons; 
            document.getElementById('show-leaderboard-btn').disabled = disableButtons; // New leaderboard button

            // Game specific buttons/elements
            if (currentSection === 'main') {
                gameSectionEl.style.pointerEvents = gameActive ? 'auto' : 'none';
                resetGameBtn.disabled = !isAppReady; // Always allow reset if app is ready
            }

            earn1PointBtn.disabled = disableButtons;
            earn5PointsBtn.disabled = disableButtons;
        }
        
        function showAdNotification(message, pointsAwarded = null) {
            let finalMessage = message;
            if (pointsAwarded !== null && message.includes('{POINTS}')) {
                finalMessage = message.replace('{POINTS}', pointsAwarded);
            }
            adNotificationEl.textContent = finalMessage;
            adNotificationEl.style.display = 'block';
            logMessage(`Ad Notification: ${finalMessage}`);
            
            setTimeout(() => {
                adNotificationEl.style.display = 'none';
            }, 3000);
        }

        window.showWithdrawForm = function() {
            if (!isAppReady || !window.telegramUserId) { 
                showAdNotification(translations[currentLanguage].loading_app);
                logMessage("Show withdraw form blocked: App not ready or Telegram User ID missing.");
                return;
            }
            hideAllSections();
            withdrawSectionEl.style.display = 'block';
            currentEarnedPointsEl.textContent = earnedPoints.toFixed(2);
            currentSection = 'withdraw';
            updateBackButtonVisibility();
            logMessage("Withdrawal form displayed.");
        }

        window.hideWithdrawForm = function() {
            withdrawSectionEl.style.display = 'none';
            withdrawStatusEl.textContent = ''; 
            showMainContent(); 
            currentSection = 'main';
            updateBackButtonVisibility();
            logMessage("Withdrawal form hidden.");
        }

        window.withdrawPoints = async function() {
            if (!isAppReady || !window.telegramUserId) { 
                showTemporaryMessage(translations[currentLanguage].loading_app, 'red');
                logMessage("Withdrawal blocked: App not ready or Telegram User ID missing.", true);
                return;
            }

            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const paymentMethod = document.getElementById('payment-method').value; 
            const walletAddress = document.getElementById('wallet-address').value; 

            let minRequiredPoints;
            let methodNameDisplay; // For display purposes

            if (paymentMethod === 'faucetpay') {
                minRequiredPoints = MIN_WITHDRAW_POINTS_FAUCETPAY;
                methodNameDisplay = translations[currentLanguage].faucetpay_option;
            } else { 
                minRequiredPoints = MIN_WITHDRAW_POINTS;
                methodNameDisplay = translations[currentLanguage].other_wallet_option;
            }

            if (isNaN(amount) || amount < minRequiredPoints) {
                let message = translations[currentLanguage].min_withdraw_message
                    .replace('{methodName}', methodNameDisplay)
                    .replace('{minAmount}', minRequiredPoints);
                showTemporaryMessage(message, 'red');
                logMessage(`Withdrawal failed: Amount ${amount} is less than min ${minRequiredPoints} or not a number.`, true);
                return;
            }

            if (amount > earnedPoints) {
                let message = translations[currentLanguage].insufficient_balance.replace('{earnedPoints}', earnedPoints.toFixed(2));
                showTemporaryMessage(message, 'red');
                logMessage(`Withdrawal failed: Insufficient balance. Tried to withdraw ${amount}, current: ${earnedPoints}.`, true);
                return;
            }

            if (!walletAddress.trim()) { 
                showTemporaryMessage(translations[currentLanguage].enter_wallet_address, 'red');
                logMessage("Withdrawal failed: Wallet address is empty.", true);
                return;
            }

            try {
                const appId = firebaseConfig.projectId; 
                const userDocRef = doc(window.db, `artifacts/${appId}/users`, window.telegramUserId);
                
                // Use a transaction for safe point deduction
                await runTransaction(window.db, async (transaction) => {
                    const sfDoc = await transaction.get(userDocRef);
                    if (!sfDoc.exists) {
                        throw "User document does not exist!";
                    }
                    const currentEarnedPoints = sfDoc.data().earnedPoints || 0;
                    if (currentEarnedPoints < amount) {
                        throw translations[currentLanguage].insufficient_balance.replace('{earnedPoints}', currentEarnedPoints.toFixed(2));
                    }
                    transaction.update(userDocRef, { earnedPoints: increment(-amount) });
                });
                logMessage(`Firestore Update: Points deducted successfully for user ${window.telegramUserId}.`);

                // Create a new withdrawal request document in Firestore
                const withdrawalsCollectionRef = collection(window.db, `artifacts/${appId}/withdrawals`);
                const newWithdrawalDocRef = await addDoc(withdrawalsCollectionRef, {
                    userId: window.telegramUserId,
                    username: window.telegramUsername || 'N/A', // Store username for admin convenience
                    amount: amount,
                    paymentMethod: paymentMethod, // Store raw value
                    walletAddress: walletAddress,
                    status: 'pending', // Initial status
                    timestamp: new Date() 
                });
                const withdrawalId = newWithdrawalDocRef.id;
                logMessage(`Firestore: New withdrawal request created with ID: ${withdrawalId}`);


                let messageToAdmin = `New Withdrawal Request:\nUser ID: ${window.telegramUserId}`;
                if (window.telegramUsername) {
                    messageToAdmin += `\nUsername: @${window.telegramUsername}`;
                }
                messageToAdmin += `\nAmount: ${amount} pepe coins\nPayment Method: ${methodNameDisplay}\nWallet Address: ${walletAddress}`;
                
                logMessage("Telegram Bot API: Sending withdrawal request to admin with approval button.");
                sendWithdrawRequestToAdmin(messageToAdmin, withdrawalId);

                showTemporaryMessage(translations[currentLanguage].withdrawal_success_message, 'green');
                logMessage("Withdrawal request sent successfully.");

                document.getElementById('withdraw-amount').value = '';
                document.getElementById('wallet-address').value = '';

            } catch (error) {
                logMessage("Withdrawal Error: Failed to update Firestore or send Telegram message: " + error.message, true);
                showTemporaryMessage(error.message || "Withdrawal failed. Please try again.", 'red');
            }
        }

        // Modified sendWithdrawRequestToAdmin to include inline keyboard with withdrawalId
        function sendWithdrawRequestToAdmin(message, withdrawalId) {
            // Callback data format: approve_withdraw_<withdrawal_doc_id>
            const callbackData = `approve_withdraw_${withdrawalId}`;
            
            const inlineKeyboard = {
                inline_keyboard: [
                    [{ text: "✅ الموافقة على السحب", callback_data: callbackData }]
                ]
            };
            const replyMarkup = encodeURIComponent(JSON.stringify(inlineKeyboard));

            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${ADMIN_USER_ID}&text=${encodeURIComponent(message)}&reply_markup=${replyMarkup}`)
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        logMessage('Telegram Bot API: Message with approval button sent to admin successfully.');
                    } else {
                        logMessage('Telegram Bot API Error: Failed to send message to Telegram: ' + (data.description || JSON.stringify(data)), true);
                        let errorMessage = translations[currentLanguage].telegram_send_fail.replace('{error}', data.description || JSON.stringify(data));
                        showTemporaryMessage(errorMessage, 'red');
                    }
                })
                .catch(error => {
                    logMessage('Telegram Bot API Error: Network error during fetch to Telegram API: ' + error.message, true);
                    let errorMessage = translations[currentLanguage].telegram_connect_error.replace('{error}', error.message);
                    showTemporaryMessage(errorMessage, 'red');
                });
        }

        let messageTimeout;
        function showTemporaryMessage(msg, color) {
            withdrawStatusEl.textContent = msg;
            withdrawStatusEl.style.color = color;
            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                withdrawStatusEl.textContent = '';
            }, 5000); 
            logMessage(`Temporary Message: ${msg} (Color: ${color})`);
        }

        function generateReferralLink() {
            const botUsername = "ididkd46_bot"; 
            if (window.telegramUserId) {
                return `https://t.me/${botUsername}?startapp=ref_${window.telegramUserId}`;
            }
            return translations[currentLanguage].loading_app; 
        }

        window.showReferralSection = function() {
            if (!isAppReady || !window.telegramUserId) { 
                showAdNotification(translations[currentLanguage].loading_app);
                logMessage("Show referral section blocked: App not ready or Telegram User ID missing.");
                return;
            }
            hideAllSections();
            referralSectionEl.style.display = 'block';
            updateReferralUI(); // Ensure UI is updated when section is shown
            currentSection = 'referral';
            updateBackButtonVisibility();
            logMessage("Referral section displayed.");
        }

        window.hideReferralSection = function() {
            referralSectionEl.style.display = 'none';
            showMainContent(); 
            currentSection = 'main';
            updateBackButtonVisibility();
            logMessage("Referral section hidden.");
        }

        function updateReferralUI() {
            referralLinkInput.value = generateReferralLink();

            // Reconstruct the inner HTML of the parent p elements to force re-render
            totalReferralsParentEl.innerHTML = `${translations[currentLanguage].total_referrals} <span id="total-referrals">${totalReferrals}</span>`;
            earnedFromReferralsParentEl.innerHTML = `${translations[currentLanguage].earned_from_referrals} <span id="earned-from-referrals">${earnedFromReferrals.toFixed(2)}</span> Pepe`;

            // Re-get references to the span elements after their parent's innerHTML was rewritten
            // This is crucial because rewriting innerHTML destroys and recreates the spans
            totalReferralsEl = document.getElementById('total-referrals');
            earnedFromReferralsEl = document.getElementById('earned-from-referrals');

            logMessage(`Referral UI updated. Total Referrals: ${totalReferrals}, Earned from Referrals: ${earnedFromReferrals.toFixed(2)}`);
        }

        window.copyReferralLink = function() {
            if (!isAppReady || !window.telegramUserId) { 
                showTemporaryMessage(translations[currentLanguage].loading_app, 'red');
                logMessage("Copy referral link blocked: App not ready or Telegram User ID missing.");
                return;
            }
            referralLinkInput.select();
            document.execCommand('copy'); 
            showTemporaryMessage(translations[currentLanguage].link_copied_success, 'green');
            logMessage("Referral link copied.");
        }

        // New functions for Withdrawal History section
        window.showWithdrawalHistorySection = function() {
            if (!isAppReady || !window.telegramUserId) {
                showAdNotification(translations[currentLanguage].loading_app);
                logMessage("Show withdrawal history blocked: App not ready or Telegram User ID missing.");
                return;
            }
            hideAllSections();
            withdrawalHistorySectionEl.style.display = 'block';
            currentSection = 'withdrawal_history';
            updateBackButtonVisibility();
            loadWithdrawalHistory(); // Load history when section is shown
            logMessage("Withdrawal history section displayed.");
        };

        window.hideWithdrawalHistorySection = function() {
            withdrawalHistorySectionEl.style.display = 'none';
            showMainContent();
            currentSection = 'main';
            updateBackButtonVisibility();
            logMessage("Withdrawal history section hidden.");
        };

        let unsubscribeFromWithdrawals = null; // To store the unsubscribe function

        function loadWithdrawalHistory() {
            if (unsubscribeFromWithdrawals) {
                unsubscribeFromWithdrawals(); // Unsubscribe from previous listener if any
                logMessage("Unsubscribed from previous withdrawal history listener.");
            }

            if (!window.db || !window.telegramUserId) {
                logMessage("Cannot load withdrawal history: Firestore or User ID not available.", true);
                return;
            }

            const appId = firebaseConfig.projectId;
            const withdrawalsCollectionRef = collection(window.db, `artifacts/${appId}/withdrawals`);
            const q = query(withdrawalsCollectionRef, where("userId", "==", window.telegramUserId)); // Filter by current user ID

            logMessage(`Setting up Firestore listener for withdrawal history for user: ${window.telegramUserId}`);
            unsubscribeFromWithdrawals = onSnapshot(q, (snapshot) => {
                logMessage("Firestore onSnapshot: Withdrawal history data received.");
                withdrawalHistoryListEl.innerHTML = ''; // Clear previous entries
                const withdrawals = [];
                snapshot.forEach(doc => {
                    withdrawals.push({ id: doc.id, ...doc.data() });
                });

                if (withdrawals.length === 0) {
                    withdrawalHistoryListEl.innerHTML = `<p class="no-withdrawals-message" data-key="no_withdrawals_yet">${translations[currentLanguage].no_withdrawals_yet}</p>`;
                    logMessage("No withdrawal requests found for this user.");
                    return;
                }

                // Sort withdrawals by timestamp descending (newest first)
                withdrawals.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

                withdrawals.forEach(item => {
                    const withdrawalItemDiv = document.createElement('div');
                    withdrawalItemDiv.classList.add('withdrawal-item');

                    let statusClass = '';
                    let statusText = '';

                    switch (item.status) {
                        case 'pending':
                            statusClass = 'status-pending';
                            statusText = translations[currentLanguage].withdrawal_status_pending;
                            break;
                        case 'approved':
                            statusClass = 'status-approved';
                            statusText = translations[currentLanguage].withdrawal_status_approved;
                            break;
                        case 'rejected': // For future implementation
                            statusClass = 'status-rejected';
                            statusText = translations[currentLanguage].withdrawal_status_rejected;
                            break;
                        default:
                            statusClass = '';
                            statusText = item.status;
                    }
                    
                    const paymentMethodDisplay = translations[currentLanguage][`${item.paymentMethod}_option`] || item.paymentMethod;

                    const detailsHtml = `
                        <p><strong>${translations[currentLanguage].withdrawal_details
                            .replace('{amount}', item.amount.toFixed(2))
                            .replace('{method}', paymentMethodDisplay)
                            .replace('{address}', item.walletAddress)
                            .replace('{status}', `<span class="${statusClass}">${statusText}</span>`)}
                        </p>
                        <p class="withdrawal-date">${translations[currentLanguage].withdrawal_date.replace('{date}', formatTimestamp(item.timestamp))}</p>
                    `;
                    withdrawalItemDiv.innerHTML = detailsHtml;
                    withdrawalHistoryListEl.appendChild(withdrawalItemDiv);
                });
                logMessage(`Displayed ${withdrawals.length} withdrawal requests.`);
            }, (error) => {
                logMessage("Firestore Error: fetching withdrawal history: " + error.message, true);
                withdrawalHistoryListEl.innerHTML = `<p class="no-withdrawals-message" style="color:red;">Error loading history: ${error.message}</p>`;
            });
        }

        // --- XO Game Logic ---
        function initGame() {
            board = ['', '', '', '', '', '', '', '', ''];
            currentPlayer = PLAYER_X;
            gameActive = true;
            renderBoard();
            updateGameStatus();
            winOptionsEl.style.display = 'none'; // Hide reward options
            resetGameBtn.style.display = 'block'; // Show reset button
        }

        function renderBoard() {
            boardEl.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                cell.dataset.index = i;
                cell.textContent = board[i];
                if (board[i] === PLAYER_X) {
                    cell.classList.add('x');
                } else if (board[i] === PLAYER_O) {
                    cell.classList.add('o');
                }
                cell.addEventListener('click', handleCellClick);
                boardEl.appendChild(cell);
            }
        }

        function handleCellClick(event) {
            const clickedCell = event.target;
            const clickedCellIndex = parseInt(clickedCell.dataset.index);

            if (board[clickedCellIndex] !== '' || !gameActive) {
                logMessage(`Cell ${clickedCellIndex} click ignored. Already taken or game inactive.`);
                return;
            }

            board[clickedCellIndex] = currentPlayer;
            clickedCell.textContent = currentPlayer;
            clickedCell.classList.add(currentPlayer.toLowerCase()); // Add 'x' or 'o' class

            if (checkWin()) {
                gameActive = false;
                highlightWinningCells();
                gameStatusEl.textContent = translations[currentLanguage].game_status_win.replace('{player}', currentPlayer);
                winOptionsEl.style.display = 'block'; // Show reward options on win
                resetGameBtn.style.display = 'none'; // Hide reset button until reward is claimed or game is manually reset
                logMessage(`Player ${currentPlayer} won! Reward options displayed.`);
                return;
            }

            if (checkDraw()) {
                gameActive = false;
                gameStatusEl.textContent = translations[currentLanguage].game_status_draw;
                winOptionsEl.style.display = 'none'; // No reward options on draw (user request implies win only)
                resetGameBtn.style.display = 'block'; // Show reset button on draw
                logMessage("Game is a draw. No reward.");
                return;
            }

            currentPlayer = currentPlayer === PLAYER_X ? PLAYER_O : PLAYER_X;
            updateGameStatus();
            logMessage(`Current player: ${currentPlayer}`);
        }

        function checkWin() {
            for (let i = 0; i < WINNING_COMBINATIONS.length; i++) {
                const [a, b, c] = WINNING_COMBINATIONS[i];
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return true;
                }
            }
            return false;
        }

        function highlightWinningCells() {
            for (let i = 0; i < WINNING_COMBINATIONS.length; i++) {
                const [a, b, c] = WINNING_COMBINATIONS[i];
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    document.querySelector(`.cell[data-index="${a}"]`).classList.add('win');
                    document.querySelector(`.cell[data-index="${b}"]`).classList.add('win');
                    document.querySelector(`.cell[data-index="${c}"]`).classList.add('win');
                    break;
                }
            }
        }

        function checkDraw() {
            return board.every(cell => cell !== '');
        }

        function updateGameStatus() {
            if (gameActive) {
                gameStatusEl.textContent = translations[currentLanguage].game_status_turn.replace('{player}', currentPlayer);
            } else if (!gameActive && !winOptionsEl.style.display === 'block') { // If game not active and no win options (i.e. draw)
                // Status is already set to win/draw
            }
        }

        window.resetGame = function() {
            logMessage("Game reset initiated.");
            initGame(); // Re-initialize game state and UI
        };

        window.earnCompetitionPoints = async function(points) {
            if (!isAppReady || !window.telegramUserId) {
                showAdNotification(translations[currentLanguage].loading_app, points);
                logMessage("Earn points blocked: App not ready or Telegram User ID missing.");
                return;
            }
            if (!gameActive && winOptionsEl.style.display === 'none') { // Only allow if game was just won and options are visible
                 showAdNotification(translations[currentLanguage].game_not_active, points);
                 logMessage("Earn points blocked: Game is not in a 'won' state.");
                 return;
            }

            let actualPoints = points;

            if (points === 5) {
                showAdNotification(translations[currentLanguage].ad_loading, points);
                try {
                    if (typeof window.Adsgram !== 'undefined' && typeof window.Adsgram.init === 'function') {
                        logMessage("Adsgram Init: SDK available. Attempting to initialize and show ad with blockId: 12307");
                        await window.Adsgram.init({ blockId: "12307" }).show();
                        logMessage("Adsgram Show: Adsgram.show() call completed successfully.");
                    } else {
                        throw new Error("Adsgram SDK not available.");
                    }
                } catch (error) {
                    logMessage("Ad Display Error: Failed to show ad: " + error.message, true);
                    showAdNotification(translations[currentLanguage].ad_failed, points);
                    return; // Don't award points if ad fails
                }
            }

            try {
                const appId = firebaseConfig.projectId;
                const userDocRef = doc(window.db, `artifacts/${appId}/users`, window.telegramUserId);

                await runTransaction(window.db, async (transaction) => {
                    const sfDoc = await transaction.get(userDocRef);
                    if (!sfDoc.exists) {
                        throw "User document does not exist!";
                    }

                    const currentCompetitionPoints = sfDoc.data().competitionPoints || 0;
                    const lastDate = sfDoc.data().lastCompetitionDate || "";
                    const today = getTodayDate();

                    let newCompetitionPoints = currentCompetitionPoints;

                    // If it's a new day, reset daily points before adding
                    if (lastDate !== today) {
                        newCompetitionPoints = actualPoints;
                        logMessage("Daily competition points reset for new day during earn operation.");
                    } else {
                        newCompetitionPoints += actualPoints;
                    }

                    transaction.update(userDocRef, {
                        competitionPoints: newCompetitionPoints,
                        lastCompetitionDate: today,
                        // Optionally add some tiny Pepe coins for playing, or keep it only competition points
                        // earnedPoints: increment(actualPoints / 100) // Example: 0.01 Pepe per XP
                    });
                });
                logMessage(`Firestore Update: User ${window.telegramUserId} earned ${actualPoints} XP. New daily XP: ${competitionPoints + actualPoints}.`);
                showAdNotification(translations[currentLanguage].ad_completed_success, actualPoints); // Use ad_completed_success for both, just pass points
                
                winOptionsEl.style.display = 'none'; // Hide reward options after claiming
                resetGameBtn.style.display = 'block'; // Show reset button
                initGame(); // Reset game board after claiming reward
            } catch (error) {
                logMessage("Earn Points Error: Failed to update Firestore: " + error.message, true);
                showAdNotification(error.message || "Failed to add points. Please try again.", points);
            }
        };


        // --- UI Section Management ---
        function hideAllSections() {
            withdrawSectionEl.style.display = 'none';
            referralSectionEl.style.display = 'none';
            withdrawalHistorySectionEl.style.display = 'none'; 
            gameSectionEl.style.display = 'none'; // Hide game section
            leaderboardSectionEl.style.display = 'none'; // Hide leaderboard section

            document.querySelector('.website-section').style.display = 'none';
            document.querySelector('.buttons').style.display = 'none';
            logMessage("All auxiliary sections hidden.");
        }

        function showMainContent() {
            // Main content is now the game section and general buttons
            gameSectionEl.style.display = 'block'; // Show game section
            document.querySelector('.website-section').style.display = 'block';
            document.querySelector('.buttons').style.display = 'flex';
            logMessage("Main content (Game) displayed.");
        }

        // New functions for Leaderboard section
        window.showLeaderboardSection = function() {
            if (!isAppReady || !window.telegramUserId) {
                showAdNotification(translations[currentLanguage].loading_app);
                logMessage("Show leaderboard blocked: App not ready or Telegram User ID missing.");
                return;
            }
            hideAllSections();
            leaderboardSectionEl.style.display = 'block';
            currentSection = 'leaderboard';
            updateBackButtonVisibility();
            loadLeaderboard(); // Load leaderboard data when section is shown
            logMessage("Leaderboard section displayed.");
        };

        window.hideLeaderboardSection = function() {
            leaderboardSectionEl.style.display = 'none';
            showMainContent();
            currentSection = 'main';
            updateBackButtonVisibility();
            logMessage("Leaderboard section hidden.");
        };

        let unsubscribeFromLeaderboard = null;

        async function loadLeaderboard() {
            if (unsubscribeFromLeaderboard) {
                unsubscribeFromLeaderboard();
                logMessage("Unsubscribed from previous leaderboard listener.");
            }

            if (!window.db || !window.telegramUserId) {
                logMessage("Cannot load leaderboard: Firestore or User ID not available.", true);
                return;
            }

            const appId = firebaseConfig.projectId;
            const usersCollectionRef = collection(window.db, `artifacts/${appId}/users`);
            const q = query(
                usersCollectionRef,
                orderBy("competitionPoints", "desc"), // Sort by competition points descending
                limit(100) // Get top 100
            );

            logMessage("Setting up Firestore listener for leaderboard (top 100 users by competitionPoints).");
            unsubscribeFromLeaderboard = onSnapshot(q, async (snapshot) => {
                logMessage("Firestore onSnapshot: Leaderboard data received.");
                leaderboardListEl.innerHTML = ''; // Clear previous entries
                const leaderboardUsers = [];
                let userRank = 'N/A';

                // First pass: collect data and find current user's rank
                snapshot.forEach((doc, index) => {
                    const data = doc.data();
                    // Check if 'username' and 'competitionPoints' exist to avoid errors in display
                    if (data.username && typeof data.competitionPoints === 'number') {
                        leaderboardUsers.push({
                            id: doc.id,
                            username: data.username,
                            competitionPoints: data.competitionPoints,
                            rank: index + 1
                        });
                        if (doc.id === window.telegramUserId) {
                            userRank = index + 1;
                        }
                    }
                });

                // Update current user's rank display
                currentRankEl.textContent = userRank;
                currentDailyPointsEl.textContent = `${competitionPoints} XP`;

                if (leaderboardUsers.length === 0) {
                    leaderboardListEl.innerHTML = `<p class="no-leaders-message" data-key="no_leaders_yet">${translations[currentLanguage].no_leaders_yet}</p>`;
                    logMessage("No users found for leaderboard.");
                    return;
                }

                // Second pass: render leaderboard
                leaderboardUsers.forEach(user => {
                    const leaderboardItemDiv = document.createElement('div');
                    leaderboardItemDiv.classList.add('leaderboard-item');
                    leaderboardItemDiv.innerHTML = `
                        <span class="rank">${user.rank}</span>
                        <span class="username">${user.username}</span>
                        <span class="points">${user.competitionPoints} XP</span>
                    `;
                    leaderboardListEl.appendChild(leaderboardItemDiv);
                });
                logMessage(`Displayed ${leaderboardUsers.length} leaderboard entries.`);
            }, (error) => {
                logMessage("Firestore Error: fetching leaderboard: " + error.message, true);
                leaderboardListEl.innerHTML = `<p class="no-leaders-message" style="color:red;">Error loading leaderboard: ${error.message}</p>`;
            });
        }


        function updateBackButtonVisibility() {
            if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp && window.Telegram.WebApp.BackButton) {
                if (currentSection !== 'main') {
                    window.Telegram.WebApp.BackButton.show();
                    logMessage("Telegram BackButton shown.");
                } else {
                    window.Telegram.WebApp.BackButton.hide();
                    logMessage("Telegram BackButton hidden.");
                }
            }
        }

        function handleBackButtonClick() {
            logMessage("Telegram BackButton clicked.");
            if (currentSection === 'withdraw') {
                hideWithdrawForm();
            } else if (currentSection === 'referral') {
                hideReferralSection();
            } else if (currentSection === 'withdrawal_history') {
                hideWithdrawalHistorySection();
            } else if (currentSection === 'leaderboard') {
                hideLeaderboardSection();
            }
        }

        window.onload = async function() {
            logMessage("Window loaded. Starting app initialization sequence.");
            // Initial render of the game board
            initGame();
            setLanguage(currentLanguage); 
            updateButtonStates(); 
            await initApp(); 
        };
    </script>
</body>
</html>
