<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="app_title">Premium Ad Reward System</title>
    
    <!-- Adsgram SDK -->
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    
    <!-- Telegram Mini Apps SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase variables - DO NOT MODIFY. These are provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let currentFirebaseUserId = null; // Firebase Auth UID
        let telegramUser = null; // Stores Telegram user data from initDataUnsafe
        let isAuthReady = false; // Flag to indicate Firebase auth state is resolved

        // Initialize Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Listen for auth state changes
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentFirebaseUserId = user.uid;
                    console.log("Firebase Auth State Changed: User is signed in:", user.uid);
                } else {
                    currentFirebaseUserId = null;
                    console.log("Firebase Auth State Changed: No user is signed in.");
                }
                isAuthReady = true; // Auth state is resolved
                initApp(); // Call initApp after auth state is resolved
            });

            // Attempt to sign in with custom token if provided (from Telegram Mini App initData)
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken)
                    .then((userCredential) => {
                        console.log("Signed in with custom token:", userCredential.user.uid);
                    })
                    .catch((error) => {
                        console.error("Error signing in with custom token:", error);
                        // Fallback to anonymous sign-in if custom token fails
                        signInAnonymously(auth).then(userCredential => console.log("Signed in anonymously (fallback).", userCredential.user.uid)).catch(err => console.error("Anonymous sign-in failed:", err));
                    });
            } else {
                // If no custom token, sign in anonymously
                signInAnonymously(auth)
                    .then((userCredential) => {
                        console.log("Signed in anonymously.");
                    })
                    .catch((error) => {
                        console.error("Error signing in anonymously:", error);
                    });
            }
        } else {
            console.error("Firebase config not found. Firebase will not be initialized.");
            isAuthReady = true; // Still allow app to try initializing without Firebase
            initApp();
        }

        // Make Firebase instances globally accessible if needed by other scripts (or use them directly here)
        window.db = db;
        window.auth = auth;
        window.currentFirebaseUserId = currentFirebaseUserId; // Will be updated by onAuthStateChanged
    </script>


    <style>
        :root {
            /* Changed primary and secondary colors to vibrant green shades */
            --primary: #00BF63; /* Vibrant Green */
            --primary-dark: #008C4A; /* Darker shade for shadows */
            --secondary: #32CD32; /* Lime Green, for a more vibrant accent */
            --secondary-dark: #28A745; /* Darker shade of secondary */
            
            --dark: #121212;
            --darker: #0a0a0a;
            --light: #f5f5f5;
            --gray: #2a2a2a;
            --card-bg: #1f1f1f;
            --gold: #ffd700;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--darker), #1a1a2e);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(0, 191, 99, 0.1) 0%, transparent 20%), /* Adjusted for green */
                radial-gradient(circle at 90% 80%, rgba(50, 205, 50, 0.1) 0%, transparent 20%); /* Adjusted for green */
            z-index: -1;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background: var(--card-bg);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .header {
            /* Header gradient adjusted for green */
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            padding: 25px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, 
                rgba(255,255,255,0.1) 0%,
                rgba(255,255,255,0) 50%,
                rgba(255,255,255,0.1) 100%);
            z-index: 1;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
        }
        
        .content {
            padding: 25px;
        }
        
        .user-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .user-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            text-align: center;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px 10px;
            width: 45%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .stat-card h3 {
            font-size: 14px;
            margin-bottom: 5px;
            color: #aaa;
        }
        
        .stat-card .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary); 
        }
        
        .progress-container {
            margin: 25px 0;
            text-align: center;
        }
        
        .progress-label {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            /* Progress bar fill adjusted for green */
            background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            border-radius: 10px;
            width: 30%;
            transition: width 0.5s ease;
        }
        
        .buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 25px 0;
        }
        
        /* 3D Button Styles - Adjusted for green */
        .btn-3d {
            position: relative;
            padding: 16px 20px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: white;
            text-align: center;
            transition: all 0.2s ease;
            transform-style: preserve-3d;
            perspective: 500px;
            /* Box shadow uses primary-dark for depth */
            box-shadow: 
                0 8px 0 var(--primary-dark), 
                0 15px 20px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            z-index: 1;
        }
        
        .btn-3d::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Gradient background for button surface */
            background: linear-gradient(45deg, var(--primary), var(--secondary)); 
            z-index: -1;
            transition: all 0.3s ease;
        }
        
        .btn-3d::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            /* Shiny effect on hover */
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.2), 
                transparent);
            transition: all 0.5s ease;
            z-index: -1;
        }
        
        .btn-3d:hover {
            transform: translateY(4px);
            /* Adjust shadow on hover */
            box-shadow: 
                0 4px 0 var(--primary-dark),
                0 8px 10px rgba(0, 0, 0, 0.3);
        }
        
        .btn-3d:hover::after {
            left: 100%;
        }
        
        .btn-3d:active {
            transform: translateY(8px);
            /* Flatten shadow on click */
            box-shadow: 
                0 0 0 var(--primary-dark),
                0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .btn-secondary {
            /* Secondary button uses secondary-dark for shadow */
            box-shadow: 
                0 8px 0 var(--secondary-dark), 
                0 15px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn-secondary::before {
            /* Secondary button background gradient */
            background: linear-gradient(45deg, var(--secondary), var(--primary-dark)); 
        }
        
        .btn-blue { /* This class is now essentially the same as btn-3d due to shared primary/secondary colors */
            box-shadow: 
                0 8px 0 var(--primary-dark), 
                0 15px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn-blue::before {
            background: linear-gradient(45deg, var(--primary), var(--secondary)); 
        }
        
        .website-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        
        .website-section h3 {
            color: var(--secondary); 
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .footer {
            text-align: center;
            padding: 15px;
            color: #777;
            font-size: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .firebase-logo {
            display: inline-block;
            margin-top: 10px;
            font-size: 10px;
            background: rgba(255, 152, 0, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            color: #ffa726;
        }
        
        .ad-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .ad-label {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 10px;
        }
        
        /* Animation for ad watching */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 0.5s ease;
        }
        
        .ad-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        /* Responsive design */
        @media (max-width: 480px) {
            .container {
                border-radius: 15px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .content {
                padding: 20px;
            }
        }
        
        /* Language Selector Styles - Active button gradient adjusted for green */
        .language-selector {
            position: absolute;
            top: 15px; 
            right: 15px; 
            display: flex;
            gap: 5px;
            z-index: 999; 
            background-color: rgba(0, 0, 0, 0.3); 
            border-radius: 10px; 
            padding: 5px; 
            backdrop-filter: blur(5px); 
        }
        .language-selector button {
            width: auto;
            padding: 5px 10px;
            font-size: 13px;
            background-color: rgba(255, 255, 255, 0.1); 
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px; 
            cursor: pointer;
            min-width: 30px;
            transition: all 0.2s ease; 
        }
        .language-selector button.active {
            background: linear-gradient(45deg, var(--primary), var(--secondary)); 
            border-color: var(--primary); 
        }
        .language-selector button:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.2); 
        }

        /* Withdrawal Section Styles - Button gradient adjusted for green */
        .withdraw-section {
            margin-top: 20px;
            display: none;
            padding: 25px; 
            background-color: rgba(255, 255, 255, 0.05); 
            border-radius: 15px; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .withdraw-section h3 {
            color: var(--secondary); 
            margin-bottom: 5px; 
            font-size: 20px;
            font-weight: 600;
        }
        .withdraw-section .warning-message { 
            font-size: 13px;
            color: #FFC107; 
            margin-bottom: 15px;
            line-height: 1.4;
            white-space: pre-wrap; 
        }
        .withdraw-section input, 
        .withdraw-section select { 
            width: 100%;
            padding: 12px;
            margin: 10px 0; 
            border-radius: 10px; 
            /* Input border adjusted for green */
            border: 1px solid var(--primary); 
            background-color: var(--dark); 
            color: var(--light);
            font-size: 14px;
        }
        .withdraw-section input::placeholder {
            color: #aaa;
        }
        .withdraw-section input:focus, 
        .withdraw-section select:focus {
            border-color: var(--gold); 
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
        }
        .withdraw-section button {
            /* Withdrawal button gradient adjusted for green */
            background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            width: 100%;
            padding: 14px; 
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px; 
            border-radius: 15px; 
            cursor: pointer;
            color: white; 
            border: none; 
            box-shadow: 0 8px 0 var(--primary-dark), 0 15px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }
        .withdraw-section button:hover {
            transform: translateY(4px);
            box-shadow: 0 4px 0 var(--primary-dark), 0 8px 10px rgba(0, 0, 0, 0.3);
            /* Hover gradient adjusted for green */
            background: linear-gradient(90deg, var(--secondary), var(--primary)); 
        }
        .withdraw-section button:active {
            transform: translateY(8px);
            box-shadow: 0 0 0 var(--primary-dark), 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* Referral Section Styles */
        .referral-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        .referral-section h3 {
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 18px;
        }
        .referral-link-container {
            background-color: var(--dark);
            border: 1px solid var(--primary);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .referral-link-container input {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: var(--light);
            font-size: 14px;
            padding: 0;
            cursor: text;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .referral-link-container button {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            border: none;
            background: linear-gradient(45deg, var(--secondary), var(--primary));
            transition: all 0.2s ease;
            box-shadow: 0 4px 0 var(--secondary-dark);
        }
        .referral-link-container button:hover {
            transform: translateY(2px);
            box-shadow: 0 2px 0 var(--secondary-dark);
        }
        .referral-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        .referral-stat-item {
            text-align: center;
        }
        .referral-stat-item .value {
            font-size: 22px;
            font-weight: 700;
            color: var(--gold);
        }
        .referral-stat-item .label {
            font-size: 12px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div class="ad-notification" id="ad-notification"></div>
    
    <div class="container">
        <!-- Language Selector -->
        <div class="language-selector">
            <button data-lang="ar" onclick="setLanguage('ar')">AR</button>
            <button data-lang="en" onclick="setLanguage('en')">EN</button>
            <button data-lang="ru" onclick="setLanguage('ru')">RU</button>
        </div>

        <div class="header">
            <h1 data-key="app_title">⛏️شغل المشاهده التلقائيه وادهب لي النوم 😴واستمتع بي الارباح🤫💵</h1>
        </div>
        
        <div class="content">
            <div class="user-info">
                <p data-key="earn_per_click_message">اربح 5 عملات pepe لكل نقرة🔥</p>
                <p data-key="min_withdrawal_message_static_general">السحب عن طريق FaucetPay من 10 عملات فقط ✅<br>السحب إلى أي محفظة أخرى من 100 عملة فقط ✅</p>
                <p id="user-id-display"></p> <!-- Display Telegram User ID -->
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <h3 data-key="watched_ads_label">الإعلانات المشاهدة</h3>
                    <div class="value" id="watched-ads">0</div>
                </div>
                <div class="stat-card">
                    <h3 data-key="earned_points_label">عملات Pepe المكتسبة</h3>
                    <div class="value" id="earned-points">0.00</div>
                </div>
            </div>
            
            <div class="stats"> 
                <div class="stat-card">
                    <h3 data-key="daily_limit_label">المشاهدات اليومية</h3>
                    <div class="value" id="daily-watched-ads">0 / 100</div>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-label">
                    <span data-key="progress_to_bonus">التقدم للمكافأة</span>
                    <span id="ads-progress">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
            
            <div class="ad-container">
                <div class="ad-label" data-key="ad_type_label">إعلان Adsgram بيني</div>
                <div class="buttons">
                    <button class="btn-3d" id="watch-ad-btn" onclick="watchAd()" data-key="watch_ad_btn_with_points">شاهد إعلان (+10.00 عملة pepe)</button>
                    <button class="btn-3d btn-secondary" id="auto-ad-btn" onclick="startAutoAds()" data-key="auto_show_ads_btn">عرض الإعلانات تلقائياً</button>
                    <button class="btn-3d" id="stop-auto-btn" onclick="stopAutoAds()" data-key="stop_auto_ads_btn">إيقاف العرض التلقائي</button>
                    <button class="btn-3d btn-blue" id="show-withdraw-btn" onclick="showWithdrawForm()" data-key="withdraw_points_btn">سحب عملات Pepe</button>
                </div>
            </div>

            <!-- Referral System Section -->
            <div class="referral-section">
                <h3 data-key="referral_title">نظام الإحالة</h3>
                <p data-key="referral_desc">ادع أصدقائك واكسب مكافآت!</p>
                <div class="referral-link-container">
                    <input type="text" id="referral-link" readonly value="Loading referral link...">
                    <button onclick="copyReferralLink()" data-key="copy_link_btn">نسخ الرابط</button>
                </div>
                <div class="referral-stats">
                    <div class="referral-stat-item">
                        <div class="value" id="referred-users-count">0</div>
                        <div class="label" data-key="referred_users_label">المستخدمون المدعوون</div>
                    </div>
                    <div class="referral-stat-item">
                        <div class="value" id="referral-bonus-earned">0.00</div>
                        <div class="label" data-key="referral_bonus_earned_label">مكافآت الإحالة</div>
                    </div>
                </div>
            </div>
            
            <div class="website-section">
                <h3 data-key="visit_channel_title">قم بزيارة قناتنا على تيليجرام</h3>
                <button class="btn-3d btn-blue" onclick="window.open('https://t.me/dogsarn', '_blank')" data-key="visit_channel_button">زيارة القناة</button>
            </div>
        </div>
        
        <div class="footer">
            <p data-key="footer_text">مؤمن بواسطة Firebase • جميع المعاملات محمية</p>
            <div class="firebase-logo">Firebase</div>
        </div>

        <!-- Withdraw Section - Moved here to be hidden/shown -->
        <div class="withdraw-section" id="withdraw-section">
            <h3 data-key="withdrawal_request_title">طلب السحب</h3>
            <p class="warning-message" data-key="withdrawal_warning">تنبيه 🙋🏻‍♂️
الحد الأدنى للسحب عن طريق FaucetPay هو 10 عملات pepe.
الحد الأدنى للسحب إلى أي محفظة أخرى هو 100 عملة pepe.
يرجى التأكد من إدخال عنوان محفظة صحيح لتلقي السحب بدون مشاكل (◍•ᴗ•◍)</p>
            <input type="number" id="withdraw-amount" data-key-placeholder="enter_points_placeholder" placeholder="أدخل الكمية لسحب عملات Pepe" />
            <select id="payment-method"> 
                <option value="faucetpay" data-key="faucetpay_option">FaucetPay</option>
                <option value="other_wallet" data-key="other_wallet_option">السحب إلى أي محفظة أخرى</option>
            </select>
            <input type="text" id="wallet-address" data-key-placeholder="wallet_address_placeholder" placeholder="أدخل عنوان المحفظة" /> 
            <button onclick="withdrawPoints()" data-key="withdraw_button">سحب</button>
            <p id="withdraw-status"></p>
        </div>
    </div>

    <!-- Adsgram SDK -->
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

    <script type="module">
        // Import Firebase modules for direct use in this script block
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Constants
        const POINTS_PER_AD = 10.00; // Reward per ad is now 10.00 Pepe Coins
        const ADS_FOR_BONUS = 10; 
        const MIN_WITHDRAW_POINTS = 100; // Minimum withdrawal for other wallets
        const MIN_WITHDRAW_POINTS_FAUCETPAY = 10; // Minimum withdrawal for FaucetPay
        const DAILY_AD_LIMIT = 100; // Daily limit for ads watched is now 100
        const REFERRAL_BONUS_ADS_COUNT = 5; // Number of ads referred user must watch for referrer bonus
        const REFERRAL_BONUS_AMOUNT = 50.00; // Amount of pepe coins for referrer bonus
        const ADMIN_USER_ID = "-1002705355317"; // Telegram Admin Chat ID
        const BOT_TOKEN = "7509054222:AAFhFhVXFCOs4kXtHQBigGU2QeNamHX42LQ"; // Telegram Bot Token
        
        // State variables (now primarily synced with Firestore)
        let currentUserData = { // User data structure
            telegramUserId: null,
            telegramUsername: 'AnonymousUser', // Default if not from Telegram Mini App
            earnedPoints: 0.00,
            watchedAdsCount: 0,
            dailyWatchedAdsCount: 0,
            lastWatchDate: '',
            referrerId: null, // ID of the user who referred this user
            referredUsersCount: 0, // Count of users referred by this user
            referralBonusEarned: 0.00, // Total bonus earned from referrals
            isNewUser: true, // Flag for initial setup
            referredAdsWatched: 0, // How many ads the referred user has watched (tracked for bonus)
            hasReceivedReferralBonusForThisUser: false // Flag to ensure referrer gets bonus only once per referred user
        };
        let autoAdInterval;
        
        // Firebase Instances (initialized in the script module head)
        let firebaseApp, firebaseDb, firebaseAuth, firebaseCurrentUserId; // Will hold instances
        let isFirebaseInitialized = false;

        // Initialize Firebase (copied from the module head, but ensures it runs in this script scope)
        try {
            const tempAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const tempFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const tempInitialAuthToken = typeof __initial_auth_token !== 'undefined' ? tempInitialAuthToken : null; // Corrected: Use tempInitialAuthToken

            if (Object.keys(tempFirebaseConfig).length > 0) {
                firebaseApp = initializeApp(tempFirebaseConfig);
                firebaseDb = getFirestore(firebaseApp);
                firebaseAuth = getAuth(firebaseApp);
                isFirebaseInitialized = true;

                // Listen for auth state changes and update our internal userId
                onAuthStateChanged(firebaseAuth, async (user) => {
                    if (user) {
                        firebaseCurrentUserId = user.uid;
                        console.log("Firebase Auth State (main script): User is signed in:", firebaseCurrentUserId);
                        // Once Firebase auth is ready, proceed with core app initialization
                        // This prevents trying to fetch/save data before auth is resolved
                        if (window.Telegram && window.Telegram.WebApp) {
                             // If Mini App, init data might provide user ID for custom token or link
                            if (window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                                // If a custom token was used, firebaseCurrentUserId is the actual Telegram user ID
                                // If anonymous fallback, firebaseCurrentUserId is anonymous UID.
                                // We need to ensure currentUserData.telegramUserId is correctly set to Telegram's user.id
                                currentUserData.telegramUserId = String(window.Telegram.WebApp.initDataUnsafe.user.id);
                                currentUserData.telegramUsername = window.Telegram.WebApp.initDataUnsafe.user.username || tgInitData.user.first_name || 'Anonymous'; // Corrected to use tgInitData.user.first_name for display
                            }
                        }
                        initApp();
                    } else {
                        firebaseCurrentUserId = null;
                        console.log("Firebase Auth State (main script): No user is signed in.");
                        // Fallback to anonymous if auth state becomes null (e.g., initial load without token)
                        if (isFirebaseInitialized) { // Only attempt if Firebase was actually initialized
                            signInAnonymously(firebaseAuth).then(userCredential => {
                                firebaseCurrentUserId = userCredential.user.uid;
                                console.log("Signed in anonymously (fallback to main script init).", firebaseCurrentUserId);
                                initApp();
                            }).catch(err => console.error("Anonymous sign-in failed:", err));
                        } else {
                            // If Firebase itself wasn't initialized, proceed without it (though limited)
                            initApp();
                        }
                    }
                });
                
                // If initialAuthToken is provided (from Telegram Mini App), use it
                if (tempInitialAuthToken) {
                    signInWithCustomToken(firebaseAuth, tempInitialAuthToken)
                        .then(userCredential => console.log("Signed in with custom token via main script init.", userCredential.user.uid))
                        .catch(error => {
                            console.error("Error signing in with custom token via main script init:", error);
                            // If custom token fails, proceed with anonymous
                            signInAnonymously(firebaseAuth).then(userCredential => console.log("Signed in anonymously (fallback from custom token failure).", userCredential.user.uid)).catch(err => console.error("Anonymous sign-in failed:", err));
                        });
                } else {
                    // If no custom token from Mini App, sign in anonymously
                    signInAnonymously(firebaseAuth)
                        .then(userCredential => console.log("Signed in anonymously via main script init.", userCredential.user.uid))
                        .catch(error => console.error("Anonymous sign-in failed via main script init:", error));
                }

            } else {
                console.warn("Firebase config not found. Running app without Firebase persistence.");
                isFirebaseInitialized = false;
                initApp(); // Call initApp directly if no Firebase
            }
        } catch (e) {
            console.error("Failed to initialize Firebase in main script:", e);
            isFirebaseInitialized = false;
            initApp(); // Call initApp directly if Firebase init fails
        }


        // DOM Elements
        const watchedAdsEl = document.getElementById('watched-ads');
        const earnedPointsEl = document.getElementById('earned-points');
        const dailyWatchedAdsEl = document.getElementById('daily-watched-ads'); 
        const adsProgressEl = document.getElementById('ads-progress');
        const progressFillEl = document.getElementById('progress-fill');
        const adNotificationEl = document.getElementById('ad-notification');
        const withdrawSectionEl = document.getElementById('withdraw-section');
        const withdrawStatusEl = document.getElementById('withdraw-status');
        const watchAdBtn = document.getElementById('watch-ad-btn');
        const autoAdBtn = document.getElementById('auto-ad-btn');
        const stopAutoBtn = document.getElementById('stop-auto-btn');
        const userIdDisplayEl = document.getElementById('user-id-display'); // For displaying Telegram User ID
        // Referral system DOM elements
        const referralLinkInput = document.getElementById('referral-link');
        const referredUsersCountEl = document.getElementById('referred-users-count');
        const referralBonusEarnedEl = document.getElementById('referral-bonus-earned');

        // --- Translation Logic ---
        const translations = {
            ar: {
                app_title: "⛏️شغل المشاهده التلقائيه وادهب لي النوم 😴واستمتع بي الارباح🤫💵",
                earn_per_click_message: "اربح 5 عملات pepe لكل نقرة🔥", 
                min_withdrawal_message_static_general: `السحب عن طريق FaucetPay من ${MIN_WITHDRAW_POINTS_FAUCETPAY} عملات فقط ✅\nالسحب إلى أي محفظة أخرى من ${MIN_WITHDRAW_POINTS} عملة فقط ✅`, 
                watched_ads_label: "الإعلانات المشاهدة",
                earned_points_label: "عملات Pepe المكتسبة", 
                daily_limit_label: "المشاهدات اليومية", 
                progress_to_bonus: "التقدم للمكافأة",
                ad_type_label: "إعلان Adsgram بيني",
                watch_ad_btn_with_points: `شاهد إعلان (+${POINTS_PER_AD.toFixed(2)} عملة pepe)`, 
                auto_show_ads_btn: "عرض الإعلانات تلقائياً",
                stop_auto_ads_btn: "إيقاف العرض التلقائي",
                withdraw_points_btn: "سحب عملات Pepe", 
                visit_channel_title: "قم بزيارة قناتنا على تيليجرام", 
                visit_channel_button: "زيارة القناة", 
                footer_text: "مؤمن بواسطة Firebase • جميع المعاملات محمية",
                withdrawal_request_title: "طلب السحب",
                withdrawal_warning: `تنبيه 🙋🏻‍♂️\nالحد الأدنى للسحب عن طريق FaucetPay هو ${MIN_WITHDRAW_POINTS_FAUCETPAY} عملات pepe.\nالحد الأدنى للسحب إلى أي محفظة أخرى هو ${MIN_WITHDRAW_POINTS} عملة pepe.\nيرجى التأكد من إدخال عنوان محفظة صحيح لتلقي السحب بدون مشاكل (◍•ᴗ•◍)`, 
                enter_points_placeholder: "أدخل الكمية لسحب عملات Pepe", 
                faucetpay_option: "FaucetPay",
                other_wallet_option: "السحب إلى أي محفظة أخرى",
                wallet_address_placeholder: "أدخل عنوان المحفظة",
                withdraw_button: "سحب",
                ad_loading: "جاري تحميل الإعلان... يرجى الانتظار",
                ad_completed_success: `اكتمل الإعلان! تمت إضافة ${POINTS_PER_AD.toFixed(2)} عملة pepe إلى حسابك`, 
                ad_failed: "فشل عرض الإعلان. يرجى المحاولة مرة أخرى.",
                auto_ads_started_notification: "بدأ العرض التلقائي للإعلانات. ستعمل الإعلانات كل 30 ثانية.",
                auto_ads_stopped_notification: "تم إيقاف العرض التلقائي للإعلانات.",
                daily_limit_reached: `لقد وصلت للحد الأقصى من المشاهدات اليومية (${DAILY_AD_LIMIT}). يرجى المحاولة غدًا.`, 
                min_withdraw_message: `الحد الأدنى للسحب عن طريق {methodName} هو {minAmount} عملة pepe.`, 
                insufficient_balance: `رصيدك غير كافٍ. لديك {earnedPoints} عملة pepe.`, 
                enter_wallet_address: "يرجى إدخال عنوان المحفظة.",
                withdrawal_success_message: 'تم إرسال طلب السحب بنجاح!',
                telegram_send_fail: `فشل إرسال الطلب: {error}`,
                telegram_connect_error: `خطأ في الاتصال بخدمة تيليجرام: {error}`,
                unknown_method: "طريقة غير معروفة:",
                // Referral system translations
                referral_title: "نظام الإحالة",
                referral_desc: `ادع أصدقائك واكسب ${REFERRAL_BONUS_AMOUNT.toFixed(2)} عملة pepe عند مشاهدتهم أول ${REFERRAL_BONUS_ADS_COUNT} إعلان!`,
                copy_link_btn: "نسخ الرابط",
                copy_link_success: "تم نسخ رابط الإحالة!",
                referred_users_label: "المستخدمون المدعوون",
                referral_bonus_earned_label: "مكافآت الإحالة",
                user_id_display: "معرف المستخدم: {userId}",
                referral_link_loading: "جاري تحميل رابط الإحالة...",
            },
            en: {
                app_title: "⛏️Enable Auto Watch, Go to Sleep 😴, and Enjoy the Profits🤫💵", 
                earn_per_click_message: "Earn 5 Pepe coins per click🔥", 
                min_withdrawal_message_static_general: `Withdrawal via FaucetPay from ${MIN_WITHDRAW_POINTS_FAUCETPAY} pepe coins only ✅\nWithdrawal to Any Other Wallet from ${MIN_WITHDRAW_POINTS} pepe coins only ✅`, 
                watched_ads_label: "Watched Ads",
                earned_points_label: "Earned Pepe Coins", 
                daily_limit_label: "Daily Views", 
                progress_to_bonus: "Progress to Bonus",
                ad_type_label: "Adsgram Interstitial Ad",
                watch_ad_btn_with_points: `Watch Ad (+${POINTS_PER_AD.toFixed(2)} Pepe Coins)`, 
                auto_show_ads_btn: "Auto Show Ads",
                stop_auto_ads_btn: "Stop Auto Ads",
                withdraw_points_btn: "Withdraw Pepe Coins", 
                visit_channel_title: "Visit Our Telegram Channel", 
                visit_channel_button: "Visit Channel", 
                footer_text: "Secured by Firebase • All transactions are protected",
                withdrawal_request_title: "Withdrawal Request",
                withdrawal_warning: `Warning 🙋🏻‍♂️\nMinimum withdrawal for FaucetPay is ${MIN_WITHDRAW_POINTS_FAUCETPAY} pepe coins.\nMinimum withdrawal for Any Other Wallet is ${MIN_WITHDRAW_POINTS} pepe coins.\nPlease ensure you enter a correct wallet address for smooth withdrawals (◍•ᴗ•◍)`, 
                enter_points_placeholder: "Enter Amount to Withdraw Pepe Coins", 
                faucetpay_option: "FaucetPay",
                other_wallet_option: "Withdraw to Any Other Wallet",
                wallet_address_placeholder: "Enter Wallet Address",
                withdraw_button: "Withdraw",
                ad_loading: "Loading ad... Please wait",
                ad_completed_success: `Ad completed! +${POINTS_PER_AD.toFixed(2)} Pepe Coins added to your account`, 
                ad_failed: "Failed to show ad. Please try again.",
                auto_ads_started_notification: "Auto ads started. Ads will play every 30 seconds.",
                auto_ads_stopped_notification: "Auto ads stopped.",
                daily_limit_reached: `You have reached the daily ad limit (${DAILY_AD_LIMIT}). Please try again tomorrow.`, 
                min_withdraw_message: `Minimum withdrawal for {methodName} is {minAmount} pepe coins.`, 
                insufficient_balance: `Insufficient balance. You have {earnedPoints} Pepe Coins.`, 
                enter_wallet_address: "Please enter the wallet address.",
                withdrawal_success_message: 'Withdrawal request sent successfully!',
                telegram_send_fail: `Failed to send request: {error}`,
                telegram_connect_error: `Error connecting to Telegram service: {error}`,
                unknown_method: "Unknown method:",
                // Referral system translations
                referral_title: "Referral System",
                referral_desc: `Invite your friends and earn ${REFERRAL_BONUS_AMOUNT.toFixed(2)} pepe coins when they watch their first ${REFERRAL_BONUS_ADS_COUNT} ads!`,
                copy_link_btn: "Copy Link",
                copy_link_success: "Referral link copied!",
                referred_users_label: "Referred Users",
                referral_bonus_earned_label: "Referral Bonus Earned",
                user_id_display: "User ID: {userId}",
                referral_link_loading: "Loading referral link...",
            },
            ru: {
                app_title: "⛏️Включи автопросмотр и иди спать 😴, наслаждайся прибылью🤫💵", 
                earn_per_click_message: "Заработайте 5 монет Pepe за клик🔥", 
                min_withdrawal_message_static_general: `Вывод через FaucetPay от ${MIN_WITHDRAW_POINTS_FAUCETPAY} монет pepe только ✅\nВывод на любой другой кошелек от ${MIN_WITHDRAW_POINTS} монет pepe только ✅`, 
                watched_ads_label: "Просмотрено объявлений",
                earned_points_label: "Заработанные монеты Pepe", 
                daily_limit_label: "Ежедневные просмотры", 
                progress_to_bonus: "Прогресс к бонусу",
                ad_type_label: "Межстраничная реклама Adsgram",
                watch_ad_btn_with_points: `Смотреть рекламу (+${POINTS_PER_AD.toFixed(2)} монет Pepe)`, 
                auto_show_ads_btn: "Автоматический показ рекламы",
                stop_auto_ads_btn: "Остановить автопоказ",
                withdraw_points_btn: "Вывести монеты Pepe", 
                visit_channel_title: "Посетите наш Telegram-канал", 
                visit_channel_button: "Посетить канал", 
                footer_text: "Защищено Firebase • Все транзакции защищены",
                withdrawal_request_title: "Запрос на вывод",
                withdrawal_warning: `Внимание 🙋🏻‍♂️\nМинимальная сумма вывода для FaucetPay составляет ${MIN_WITHDRAW_POINTS_FAUCETPAY} монет pepe.\nМинимальная сумма вывода для любого другого кошелька составляет ${MIN_WITHDRAW_POINTS} монет pepe.\nПожалуйста, убедитесь, что вы ввели правильный адрес кошелька для беспроблемного вывода средств (◍•ᴗ•◍)`, 
                enter_points_placeholder: "Введите сумму для вывода монет Pepe", 
                faucetpay_option: "FaucetPay",
                other_wallet_option: "Вывод на любой другой кошелек",
                wallet_address_placeholder: "Введите адрес кошелька",
                withdraw_button: "Вывести",
                ad_loading: "Загрузка рекламы... Пожалуйста, подождите",
                ad_completed_success: `Реклама завершена! +${POINTS_PER_AD.toFixed(2)} монет Pepe добавлено на ваш счет`, 
                ad_failed: "Не удалось показать рекламу. Пожалуйста, попробуйте еще раз.",
                auto_ads_started_notification: "Автоматический показ рекламы запущен. Реклама будет воспроизводиться каждые 30 секунд.",
                auto_ads_stopped_notification: "Остановить автопоказ.",
                daily_limit_reached: `Вы достигли дневного лимита по рекламе (${DAILY_AD_LIMIT}). Пожалуйста, попробуйте завтра.`, 
                min_withdraw_message: `Минимальная сумма вывода для {methodName} составляет {minAmount} монет pepe.`, 
                insufficient_balance: `Недостаточный баланс. У вас {earnedPoints} монет pepe.`, 
                enter_wallet_address: "Пожалуйста, введите адрес кошелька.",
                withdrawal_success_message: 'Запрос на вывод успешно отправлен!',
                telegram_send_fail: `Не удалось отправить запрос: {error}`,
                telegram_connect_error: `Ошибка подключения к службе Telegram: {error}`,
                unknown_method: "Неизвестный метод:",
            }
        };

        let currentLanguage = localStorage.getItem('appLanguage') || 'ar'; // Default to Arabic
        let appInitialized = false; // Flag to prevent multiple initializations

        // Function to get today's date inYYYY-MM-DD format
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Function to set the language
        window.setLanguage = function(lang) {
            currentLanguage = lang;
            localStorage.setItem('appLanguage', lang);
            document.documentElement.lang = lang; // Set HTML lang attribute

            // Update active button style
            document.querySelectorAll('.language-selector button').forEach(button => {
                if (button.dataset.lang === lang) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            // Translate all elements with data-key
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.dataset.key;
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'INPUT' && element.hasAttribute('data-key-placeholder')) {
                        element.placeholder = translations[lang][key];
                    } else if (key === 'watch_ad_btn_with_points' || key === 'ad_completed_success') {
                         element.textContent = translations[lang][key];
                    } else if (key === 'daily_limit_reached') { 
                        element.textContent = translations[lang][key].replace(`(${DAILY_AD_LIMIT})`, `(${DAILY_AD_LIMIT})`); 
                    } else if (key === 'insufficient_balance') {
                        element.textContent = translations[lang][key].replace('{earnedPoints}', currentUserData.earnedPoints.toFixed(2));
                    } else if (key === 'min_withdrawal_message') { // Handle dynamic min_withdrawal_message
                        // This specific translation is handled inside withdrawPoints to be dynamic
                        // So we don't set it directly here
                    }
                    else {
                        element.textContent = translations[lang][key];
                    }
                }
            });

            // Translate all elements with data-key-placeholder
            document.querySelectorAll('[data-key-placeholder]').forEach(element => {
                const placeholderKey = element.dataset.keyPlaceholder;
                if (translations[lang] && translations[lang][placeholderKey]) {
                    element.placeholder = translations[lang][placeholderKey];
                }
            });

            // Translate options in select dropdowns
            document.querySelectorAll('#payment-method option').forEach(option => {
                const key = option.dataset.key;
                if (translations[lang] && translations[lang][key]) {
                    option.textContent = translations[lang][key];
                }
            });

            // Update dynamically set messages
            // The referral_desc is set dynamically
            const referralDescEl = document.querySelector('[data-key="referral_desc"]');
            if (referralDescEl) {
                referralDescEl.textContent = translations[lang].referral_desc;
            }
            // User ID display
            if (currentUserData.telegramUserId) {
                userIdDisplayEl.textContent = translations[currentLanguage].user_id_display.replace('{userId}', currentUserData.telegramUserId);
            } else if (firebaseCurrentUserId) { // Fallback if not Telegram Mini App
                 userIdDisplayEl.textContent = translations[currentLanguage].user_id_display.replace('{userId}', firebaseCurrentUserId);
            } else {
                 userIdDisplayEl.textContent = "User ID: N/A"; // Or hide this element
            }


            // Re-render dynamic content (like numbers)
            updateUI();
            showAdNotification(''); 
            withdrawStatusEl.textContent = ''; 
        };

        // This initApp is called by the Firebase auth listener to ensure Firebase is ready
        async function initApp() {
            if (appInitialized) return; // Prevent multiple initializations
            appInitialized = true;

            // Step 1: Get Telegram Mini App Data (if applicable)
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
                const tgInitData = window.Telegram.WebApp.initDataUnsafe;
                if (tgInitData.user) {
                    currentUserData.telegramUserId = String(tgInitData.user.id);
                    currentUserData.telegramUsername = tgInitData.user.username || tgInitData.user.first_name || 'Anonymous';
                    console.log("Telegram Mini App User Data:", currentUserData.telegramUserId, currentUserData.telegramUsername);

                    // If a referrer ID is present in the start_param
                    if (tgInitData.start_param) {
                        const referrerId = tgInitData.start_param;
                        if (referrerId !== currentUserData.telegramUserId) { // Cannot refer self
                            currentUserData.referrerId = referrerId;
                            console.log("Referred by:", referrerId);
                        }
                    }
                }
            }

            // Step 2: Determine the user's unique ID for Firestore
            // Use Telegram User ID if available, otherwise Firebase Auth UID (for anonymous users outside Mini App)
            const userIdForFirestore = currentUserData.telegramUserId || firebaseCurrentUserId;

            if (!userIdForFirestore && isFirebaseInitialized) {
                console.error("No valid user ID for Firestore. Firebase operations may fail.");
                showAdNotification("Error: Could not determine user ID. Please refresh.");
                return;
            } else if (!isFirebaseInitialized) {
                 console.warn("Firebase not initialized. Running without data persistence.");
                 // Load from localStorage as fallback if Firebase is not present
                 if (localStorage.getItem('userData')) {
                    currentUserData = JSON.parse(localStorage.getItem('userData'));
                 }
            }


            if (isFirebaseInitialized) {
                const userDocRef = doc(firebaseDb, `artifacts/${appId}/users/${userIdForFirestore}/appData/userData`);
                
                try {
                    const userDocSnap = await getDoc(userDocRef);

                    if (userDocSnap.exists()) {
                        // Load existing user data from Firestore
                        const data = userDocSnap.data();
                        currentUserData = { 
                            ...currentUserData, // Keep Telegram-derived info
                            ...data, // Overlay with Firestore data
                            isNewUser: false // Not a new user if document exists
                        };
                        console.log("Loaded user data from Firestore:", currentUserData);

                        // Daily reset logic (if it's a new day, reset daily watched ads)
                        const todayDate = getTodayDate();
                        if (currentUserData.lastWatchDate !== todayDate) {
                            currentUserData.dailyWatchedAdsCount = 0;
                            currentUserData.lastWatchDate = todayDate;
                            await setDoc(userDocRef, { dailyWatchedAdsCount: 0, lastWatchDate: todayDate }, { merge: true });
                            console.log("Daily ad count reset for new day.");
                        }

                    } else {
                        // New user: Save initial data to Firestore
                        console.log("New user detected. Saving initial data to Firestore.");
                        currentUserData.watchedAdsCount = 0;
                        currentUserData.earnedPoints = 0.00;
                        currentUserData.dailyWatchedAdsCount = 0;
                        currentUserData.lastWatchDate = getTodayDate();
                        currentUserData.isNewUser = true; // Confirm new user for referral bonus logic
                        currentUserData.referredUsersCount = 0;
                        currentUserData.referralBonusEarned = 0.00;
                        currentUserData.referredAdsWatched = 0;
                        currentUserData.hasReceivedReferralBonusForThisUser = false; // For the referred user to give bonus once

                        await setDoc(userDocRef, currentUserData);
                        console.log("Initial user data saved to Firestore.");
                    }

                } catch (error) {
                    console.error("Error fetching/setting user data from Firestore:", error);
                    showAdNotification("Error loading user data. Functionality may be limited.");
                    // Fallback to localStorage if Firestore fails
                    if (localStorage.getItem('userData')) {
                        currentUserData = JSON.parse(localStorage.getItem('userData'));
                    }
                }
            }
            
            // Apply language settings after user data is loaded
            setLanguage(currentLanguage);
            updateUI(); // Update UI with loaded data
            updateButtonStates(); // Set initial button states
            generateReferralLink(); // Generate referral link based on user ID
        }
        
        // Update UI elements
        function updateUI() {
            watchedAdsEl.textContent = currentUserData.watchedAdsCount;
            earnedPointsEl.textContent = currentUserData.earnedPoints.toFixed(2);
            dailyWatchedAdsEl.textContent = `${currentUserData.dailyWatchedAdsCount} / ${DAILY_AD_LIMIT}`; 
            
            const progress = (currentUserData.watchedAdsCount % ADS_FOR_BONUS) / ADS_FOR_BONUS * 100;
            adsProgressEl.textContent = `${Math.round(progress)}%`;
            progressFillEl.style.width = `${progress}%`;
            
            // Add animation when points change
            earnedPointsEl.classList.remove('pulse');
            void earnedPointsEl.offsetWidth; // Trigger reflow
            earnedPointsEl.classList.add('pulse');

            // Update referral UI
            referredUsersCountEl.textContent = currentUserData.referredUsersCount;
            referralBonusEarnedEl.textContent = currentUserData.referralBonusEarned.toFixed(2);
            
            // Update User ID display
            if (currentUserData.telegramUserId) {
                userIdDisplayEl.textContent = translations[currentLanguage].user_id_display.replace('{userId}', currentUserData.telegramUserId);
            } else if (firebaseCurrentUserId) { // Fallback if not Telegram Mini App
                 userIdDisplayEl.textContent = translations[currentLanguage].user_id_display.replace('{userId}', firebaseCurrentUserId);
            } else {
                 userIdDisplayEl.textContent = "User ID: N/A"; // Or hide this element
            }


            updateButtonStates(); // Ensure button states are updated after UI changes
        }

        // Save user data to Firestore
        async function saveUserDataToFirestore() {
            if (!isFirebaseInitialized || !firebaseCurrentUserId) {
                console.warn("Firebase not initialized or user not authenticated. Cannot save to Firestore. Saving to localStorage.");
                localStorage.setItem('userData', JSON.stringify(currentUserData)); // Fallback save
                return;
            }
            // Use telegramUserId if available, otherwise firebaseAuth.uid
            const userIdToSave = currentUserData.telegramUserId || firebaseCurrentUserId;
            if (!userIdToSave) {
                 console.error("Cannot save user data: No valid user ID found.");
                 return;
            }
            const userDocRef = doc(firebaseDb, `artifacts/${appId}/users/${userIdToSave}/appData/userData`);
            try {
                // Use `updateDoc` for partial updates, `setDoc` with `merge: true` is also an option
                await setDoc(userDocRef, currentUserData, { merge: true });
                console.log("User data saved to Firestore successfully.");
            } catch (error) {
                console.error("Error saving user data to Firestore:", error);
                showAdNotification("Error saving data. Please check your connection.");
            }
        }
        
        // Function to update button enabled/disabled states
        function updateButtonStates() {
            const limitReached = currentUserData.dailyWatchedAdsCount >= DAILY_AD_LIMIT;
            watchAdBtn.disabled = limitReached;
            autoAdBtn.disabled = limitReached; 
            
            if (limitReached) {
                // If limit reached, make sure auto ads are stopped
                clearInterval(autoAdInterval);
                autoAdInterval = null; // Clear the interval ID
                stopAutoBtn.disabled = true; 
            } else {
                stopAutoBtn.disabled = !autoAdInterval; 
            }
        }
        
        // Watch ad function using Adsgram
        async function watchAd() {
            if (currentUserData.dailyWatchedAdsCount >= DAILY_AD_LIMIT) {
                showAdNotification(translations[currentLanguage].daily_limit_reached);
                return; 
            }

            showAdNotification(translations[currentLanguage].ad_loading);
            
            try {
                // Log before attempting to show ad
                console.log("Attempting to show Adsgram ad...");
                if (typeof window.Adsgram !== 'undefined' && typeof window.Adsgram.init === 'function') {
                    await window.Adsgram.init({ blockId: "12082" }).show(); 
                    console.log("Adsgram ad shown successfully."); // Log success
                    
                    currentUserData.watchedAdsCount++;
                    currentUserData.earnedPoints += POINTS_PER_AD; 
                    currentUserData.dailyWatchedAdsCount++; 

                    // Update last watched date to today
                    currentUserData.lastWatchDate = getTodayDate();
                    
                    if (currentUserData.watchedAdsCount % ADS_FOR_BONUS === 0) {
                        currentUserData.earnedPoints += 1.00; // Bonus point
                    }

                    // Referral Bonus Logic: Check if this referred user qualifies their referrer for a bonus
                    if (currentUserData.referrerId && currentUserData.isNewUser) { // Only for new referred users
                        currentUserData.referredAdsWatched = (currentUserData.referredAdsWatched || 0) + 1; // Increment ads watched by this referred user

                        if (currentUserData.referredAdsWatched >= REFERRAL_BONUS_ADS_COUNT && !currentUserData.hasReceivedReferralBonusForThisUser) {
                            console.log(`Referred user ${currentUserData.telegramUserId} watched ${REFERRAL_BONUS_ADS_COUNT} ads. Awarding bonus to referrer.`);
                            
                            // Get referrer's data and update their points
                            const referrerDocRef = doc(firebaseDb, `artifacts/${appId}/users/${currentUserData.referrerId}/appData/userData`);
                            const referrerDocSnap = await getDoc(referrerDocRef);
                            
                            if (referrerDocSnap.exists()) {
                                const referrerData = referrerDocSnap.data();
                                const newReferrerPoints = (referrerData.earnedPoints || 0) + REFERRAL_BONUS_AMOUNT;
                                const newReferralBonusEarned = (referrerData.referralBonusEarned || 0) + REFERRAL_BONUS_AMOUNT;
                                
                                await updateDoc(referrerDocRef, {
                                    earnedPoints: newReferrerPoints,
                                    referralBonusEarned: newReferralBonusEarned
                                });
                                console.log(`Referrer ${currentUserData.referrerId} awarded ${REFERRAL_BONUS_AMOUNT} pepe coins.`);
                                
                                // Mark that bonus has been received for this referred user
                                currentUserData.hasReceivedReferralBonusForThisUser = true;
                                
                                // Also increment referrer's referredUsersCount if this is the first bonus from this specific referred user
                                // This assumes a referred user gives a bonus only once after reaching the ad threshold
                                if ((referrerData.referredUsersCount || 0) === referrerDocSnap.data().referredUsersCount) { // Check if count already updated by another referred user simultaneously
                                    await updateDoc(referrerDocRef, { referredUsersCount: (referrerData.referredUsersCount || 0) + 1 });
                                }
                            } else {
                                console.warn(`Referrer ${currentUserData.referrerId} not found in Firestore.`);
                            }
                        }
                    }
                    
                    await saveUserDataToFirestore(); // Save updated user data to Firestore
                    updateUI(); 
                    
                    showAdNotification(translations[currentLanguage].ad_completed_success);
                } else {
                    // This else block indicates SDK not loaded, which is now checked in initApp too
                    console.error("Adsgram SDK is not available when trying to show ad.");
                    showAdNotification(translations[currentLanguage].ad_failed); 
                }

            } catch (error) {
                // Log specific error from Adsgram or network
                console.error("Adsgram ad failed to show or an error occurred:", error);
                showAdNotification(translations[currentLanguage].ad_failed);
            }
        }
        
        // Auto show ads 
        function startAutoAds() {
            if (currentUserData.dailyWatchedAdsCount >= DAILY_AD_LIMIT) {
                showAdNotification(translations[currentLanguage].daily_limit_reached);
                return;
            }
            // Ensure any existing interval is cleared before starting a new one
            if (autoAdInterval) {
                clearInterval(autoAdInterval);
            }
            autoAdInterval = setInterval(watchAd, 30000); 
            autoAdBtn.disabled = true; 
            stopAutoBtn.disabled = false; 
            showAdNotification(translations[currentLanguage].auto_ads_started_notification);
        }
        
        function stopAutoAds() {
            clearInterval(autoAdInterval);
            autoAdInterval = null; 
            autoAdBtn.disabled = false; 
            stopAutoBtn.disabled = true; 
            showAdNotification(translations[currentLanguage].auto_ads_stopped_notification);
        }
        
        // Show ad notification
        function showAdNotification(message) {
            adNotificationEl.textContent = message;
            adNotificationEl.style.display = 'block';
            
            setTimeout(() => {
                adNotificationEl.style.display = 'none';
            }, 3000);
        }

        // Function to show withdraw form
        function showWithdrawForm() {
            withdrawSectionEl.style.display = 'block';
        }

        // Function to handle withdrawal
        async function withdrawPoints() {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const paymentMethod = document.getElementById('payment-method').value; 
            const walletAddress = document.getElementById('wallet-address').value; 

            let minRequiredPoints;
            let methodName;

            if (paymentMethod === 'faucetpay') {
                minRequiredPoints = MIN_WITHDRAW_POINTS_FAUCETPAY;
                methodName = translations[currentLanguage].faucetpay_option;
            } else { // Covers 'other_wallet' and any default case
                minRequiredPoints = MIN_WITHDRAW_POINTS;
                methodName = translations[currentLanguage].other_wallet_option;
            }

            if (isNaN(amount) || amount < minRequiredPoints) {
                let message = translations[currentLanguage].min_withdraw_message
                    .replace('{methodName}', methodName)
                    .replace('{minAmount}', minRequiredPoints);
                showTemporaryMessage(message, 'red');
                return;
            }

            if (amount > currentUserData.earnedPoints) {
                let message = translations[currentLanguage].insufficient_balance.replace('{earnedPoints}', currentUserData.earnedPoints.toFixed(2));
                showTemporaryMessage(message, 'red');
                return;
            }

            if (!walletAddress.trim()) { 
                showTemporaryMessage(translations[currentLanguage].enter_wallet_address, 'red');
                return;
            }

            // Deduct points locally first
            currentUserData.earnedPoints -= amount;
            await saveUserDataToFirestore(); // Save updated points to Firestore
            updateUI(); 

            // Construct Telegram message for admin, including actual Telegram username
            let messageToAdmin = `New Withdrawal Request:\n`;
            if (currentUserData.telegramUsername && currentUserData.telegramUserId) {
                messageToAdmin += `User: @${currentUserData.telegramUsername} (ID: ${currentUserData.telegramUserId})\n`;
            } else {
                 messageToAdmin += `User ID: ${currentUserData.telegramUserId || firebaseCurrentUserId} (No Telegram Username)\n`;
            }
            messageToAdmin += `Amount: ${amount} pepe coins\nPayment Method: ${methodName}\nWallet Address: ${walletAddress}`;
            
            sendWithdrawRequestToAdmin(messageToAdmin); 

            showTemporaryMessage(translations[currentLanguage].withdrawal_success_message, 'green');

            document.getElementById('withdraw-amount').value = '';
            document.getElementById('wallet-address').value = '';
        }

        // Function to send withdrawal request to admin via Telegram
        function sendWithdrawRequestToAdmin(message) {
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${ADMIN_USER_ID}&text=${encodeURIComponent(message)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        console.log('Message sent to admin');
                    } else {
                        console.error('Failed to send message to Telegram:', data.description || data);
                        let errorMessage = translations[currentLanguage].telegram_send_fail.replace('{error}', data.description || data);
                        showTemporaryMessage(errorMessage, 'red');
                    }
                })
                .catch(error => {
                    console.error('Error during fetch to Telegram API:', error);
                    let errorMessage = translations[currentLanguage].telegram_connect_error.replace('{error}', error.message);
                    showTemporaryMessage(errorMessage, 'red');
                });
        }

        // Utility for showing temporary messages
        let messageTimeout;
        function showTemporaryMessage(msg, color) {
            withdrawStatusEl.textContent = msg;
            withdrawStatusEl.style.color = color;
            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                withdrawStatusEl.textContent = '';
            }, 5000); 
        }

        // Referral System Functions
        async function generateReferralLink() {
            // Check if Telegram WebApp is available and user ID exists
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                const userId = window.Telegram.WebApp.initDataUnsafe.user.id;
                // Important: Replace 'YOUR_BOT_USERNAME' with your actual Telegram bot's username (without the @)
                // And 'YOUR_MINI_APP_URL' with the actual URL where your HTML file is hosted.
                // The initData field will be appended automatically by Telegram to your Mini App URL.
                const botUsername = "ididkd46_bot"; // Replaced with the provided bot username
                const referralLink = `https://t.me/${botUsername}?start=${userId}`;
                referralLinkInput.value = referralLink;
            } else if (isFirebaseInitialized && firebaseCurrentUserId) {
                // Fallback for non-Mini App or if Telegram init data is not available
                // This link will NOT open a Mini App directly, but a direct message to the bot
                // with the start parameter. The bot would then need to launch the Mini App.
                // Replace 'YOUR_BOT_USERNAME' with your actual Telegram bot's username (without the @)
                const botUsername = "ididkd46_bot"; // Replaced with the provided bot username
                const referralLink = `https://t.me/${botUsername}?start=${firebaseCurrentUserId}`;
                referralLinkInput.value = referralLink;
            }
             else {
                referralLinkInput.value = translations[currentLanguage].referral_link_loading;
            }
        }

        function copyReferralLink() {
            referralLinkInput.select();
            document.execCommand('copy');
            showAdNotification(translations[currentLanguage].copy_link_success);
        }

        // Initialize Telegram Mini App
        if (window.Telegram && window.Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand(); // Expand Mini App to full screen
            console.log("Telegram WebApp initialized.");
        } else {
            console.warn("Telegram WebApp SDK not detected. Running as a standalone web page.");
        }

        // Initial call to set language (will be refined by initApp when data is loaded)
        setLanguage(currentLanguage);

        // window.onload is handled by Firebase auth listener now or directly by initApp if Firebase not configured
    </script>
</body>
</html>
