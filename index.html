<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="app_title">Premium Ad Reward System</title>
    
    <!-- Adsgram SDK -->
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>

    <style>
        :root {
            /* Changed primary and secondary colors to vibrant green shades */
            --primary: #00BF63; /* Vibrant Green */
            --primary-dark: #008C4A; /* Darker shade for shadows */
            --secondary: #32CD32; /* Lime Green, for a more vibrant accent */
            --secondary-dark: #28A745; /* Darker shade of secondary */
            
            --dark: #121212;
            --darker: #0a0a0a;
            --light: #f5f5f5;
            --gray: #2a2a2a;
            --card-bg: #1f1f1f;
            --gold: #ffd700;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--darker), #1a1a2e);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(0, 191, 99, 0.1) 0%, transparent 20%), /* Adjusted for green */
                radial-gradient(circle at 90% 80%, rgba(50, 205, 50, 0.1) 0%, transparent 20%); /* Adjusted for green */
            z-index: -1;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background: var(--card-bg);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .header {
            /* Header gradient adjusted for green */
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            padding: 25px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, 
                rgba(255,255,255,0.1) 0%,
                rgba(255,255,255,0) 50%,
                rgba(255,255,255,0.1) 100%);
            z-index: 1;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
        }
        
        .content {
            padding: 25px;
        }
        
        .user-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .user-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        /* Updated .stats to center the single card */
        .stats {
            display: flex;
            justify-content: center; /* Center the single card */
            margin: 20px 0;
            text-align: center;
        }
        
        /* Enlarged stat-card for earned points */
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px 30px; /* Increased padding */
            width: 80%; /* Made it wider */
            max-width: 300px; /* Max width to keep it reasonable */
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            margin-bottom: 20px; /* Space between points card and ad container */
        }
        
        .stat-card h3 {
            font-size: 18px; /* Larger font for title */
            margin-bottom: 10px; /* More space */
            color: #aaa;
        }
        
        .stat-card .value {
            font-size: 36px; /* Significantly larger font for value */
            font-weight: 700;
            color: var(--primary); 
        }
        
        .progress-container {
            margin: 25px 0;
            text-align: center;
        }
        
        .progress-label {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            /* Progress bar fill adjusted for green */
            background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            border-radius: 10px;
            width: 30%;
            transition: width 0.5s ease;
        }
        
        .buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 25px 0;
        }
        
        /* 3D Button Styles - Adjusted for green */
        .btn-3d {
            position: relative;
            padding: 16px 20px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: white;
            text-align: center;
            transition: all 0.2s ease;
            transform-style: preserve-3d;
            perspective: 500px;
            /* Box shadow uses primary-dark for depth */
            box-shadow: 
                0 8px 0 var(--primary-dark), 
                0 15px 20px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            z-index: 1;
        }
        
        .btn-3d::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Gradient background for button surface */
            background: linear-gradient(45deg, var(--primary), var(--secondary)); 
            z-index: -1;
            transition: all 0.3s ease;
        }
        
        .btn-3d::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            /* Shiny effect on hover */
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.2), 
                transparent);
            transition: all 0.5s ease;
            z-index: -1;
        }
        
        .btn-3d:hover {
            transform: translateY(4px);
            /* Adjust shadow on hover */
            box-shadow: 
                0 4px 0 var(--primary-dark),
                0 8px 10px rgba(0, 0, 0, 0.3);
        }
        
        .btn-3d:hover::after {
            left: 100%;
        }
        
        .btn-3d:active {
            transform: translateY(8px);
            /* Flatten shadow on click */
            box-shadow: 
                0 0 0 var(--primary-dark),
                0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .btn-secondary {
            /* Secondary button uses secondary-dark for shadow */
            box-shadow: 
                0 8px 0 var(--secondary-dark), 
                0 15px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn-secondary::before {
            /* Secondary button background gradient */
            background: linear-gradient(45deg, var(--secondary), var(--primary-dark)); 
        }
        
        .btn-blue { /* This class is now essentially the same as btn-3d due to shared primary/secondary colors */
            box-shadow: 
                0 8px 0 var(--primary-dark), 
                0 15px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn-blue::before {
            background: linear-gradient(45deg, var(--primary), var(--secondary)); 
        }
        
        .website-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        
        .website-section h3 {
            color: var(--secondary); 
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .footer {
            text-align: center;
            padding: 15px;
            color: #777;
            font-size: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .firebase-logo {
            display: inline-block;
            margin-top: 10px;
            font-size: 10px;
            background: rgba(255, 152, 0, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            color: #ffa726;
        }
        
        .ad-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .ad-label {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 10px;
        }
        
        /* Animation for ad watching */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 0.5s ease;
        }
        
        .ad-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        /* Responsive design */
        @media (max-width: 480px) {
            .container {
                border-radius: 15px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .content {
                padding: 20px;
            }
            .tap-area {
                width: 180px; /* Adjust size for smaller screens */
                height: 180px;
            }
            .tap-area img {
                width: 100%; /* Make image fill for smaller screens */
                height: 100%;
            }
            .tap-area h2 {
                font-size: 36px;
            }
            .tap-area p {
                font-size: 16px;
            }
            .stat-card { /* Adjust for smaller screens */
                width: 95%;
                padding: 15px 20px;
            }
            .stat-card h3 {
                font-size: 16px;
            }
            .stat-card .value {
                font-size: 30px;
            }
        }
        
        /* Language Selector Styles - Active button gradient adjusted for green */
        .language-selector {
            position: absolute;
            top: 15px; 
            right: 15px; 
            display: flex;
            gap: 5px;
            z-index: 999; 
            background-color: rgba(0, 0, 0, 0.3); 
            border-radius: 10px; 
            padding: 5px; 
            backdrop-filter: blur(5px); 
        }
        .language-selector button {
            width: auto;
            padding: 5px 10px;
            font-size: 13px;
            background-color: rgba(255, 255, 255, 0.1); 
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px; 
            cursor: pointer;
            min-width: 30px;
            transition: all 0.2s ease; 
        }
        .language-selector button.active {
            background: linear-gradient(45deg, var(--primary), var(--secondary)); 
            border-color: var(--primary); 
        }
        .language-selector button:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.2); 
        }

        /* Withdrawal Section Styles - Adapted to be integrated */
        .withdraw-section {
            margin-top: 20px;
            display: none; /* Hidden by default, shown by JS */
            padding: 25px; 
            background-color: rgba(255, 255, 255, 0.05); 
            border-radius: 15px; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .withdraw-section h3 {
            color: var(--secondary); 
            margin-bottom: 5px; 
            font-size: 20px;
            font-weight: 600;
        }
        .withdraw-section .warning-message { 
            font-size: 13px;
            color: #FFC107; 
            margin-bottom: 15px;
            line-height: 1.4;
            white-space: pre-wrap; 
            background: rgba(255, 215, 0, 0.1); /* Light gold background for warning */
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #FFD700;
        }
        .withdraw-section input, 
        .withdraw-section select { 
            width: 100%;
            padding: 12px;
            margin: 10px 0; 
            border-radius: 10px; 
            border: 1px solid var(--primary); 
            background-color: var(--dark); 
            color: var(--light);
            font-size: 14px;
        }
        .withdraw-section input::placeholder {
            color: #aaa;
        }
        .withdraw-section input:focus, 
        .withdraw-section select:focus {
            border-color: var(--gold); 
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
        }
        .withdraw-section button {
            background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            width: 100%;
            padding: 14px; 
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px; 
            border-radius: 15px; 
            cursor: pointer;
            color: white; 
            border: none; 
            box-shadow: 0 8px 0 var(--primary-dark), 0 15px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }
        .withdraw-section button:hover {
            transform: translateY(4px);
            box-shadow: 0 4px 0 var(--primary-dark), 0 8px 10px rgba(0, 0, 0, 0.3);
            background: linear-gradient(90deg, var(--secondary), var(--primary)); 
        }
        .withdraw-section button:active {
            transform: translateY(8px);
            box-shadow: 
                0 0 0 var(--primary-dark),
                0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .withdraw-section p.current-balance {
            font-size: 18px;
            color: var(--gold);
            margin-bottom: 25px;
            font-weight: 600;
        }

        .back-button-container {
            margin-top: 25px;
            text-align: center;
        }
        .back-button {
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            padding: 10px 20px;
            border-radius: 10px;
            text-decoration: none;
            font-size: 14px;
            transition: background-color 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: inline-block; /* Make it a block for centering */
        }
        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Hamster Kombat Style Tap Area */
        .tap-area {
            background: radial-gradient(circle at center, #2e2e2e 0%, #1a1a1a 100%);
            border-radius: 50%; /* Make it circular */
            margin: 20px auto; /* Center the circular area */
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            position: relative;
            width: 220px; /* Set fixed width and height for a perfect circle */
            height: 220px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5), inset 0 0 20px rgba(0,0,0,0.5); /* Added outer shadow */
            animation: backgroundPulse 5s infinite alternate;
            user-select: none; /* Prevent text selection on tap */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE10+ */
        }

        /* Image inside the tap area */
        .tap-area img {
            width: 100%; /* Make image fill the circle's width */
            height: 100%; /* Make image fill the circle's height */
            object-fit: cover; /* Make image cover the area, cropping if necessary */
            border-radius: 50%; /* Ensure image itself is circular */
            position: absolute; /* Position image absolutely within the tap-area */
            top: 0;
            left: 0;
            z-index: 5; /* Place image behind text but above background pulse */
            transition: transform 0.1s ease;
        }

        .tap-area.active img {
            transform: scale(0.95); /* Shrink image on tap */
        }

        @keyframes backgroundPulse {
            0% { background: radial-gradient(circle at center, #2e2e2e 0%, #1a1a1a 100%); }
            100% { background: radial-gradient(circle at center, #3a3a3a 0%, #2a3a3a 100%); }
        }

        .tap-area h2 {
            font-size: 48px;
            font-weight: 800;
            color: var(--gold);
            margin-bottom: 5px; /* Adjusted margin */
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
            transition: transform 0.1s ease;
            position: relative;
            z-index: 10; /* Ensure text is above image */
        }

        .tap-area p {
            font-size: 18px;
            color: #ccc;
            margin-top: 0; /* Adjusted margin */
            position: relative;
            z-index: 10; /* Ensure text is above image */
        }

        .tap-feedback {
            position: absolute;
            font-size: 40px;
            font-weight: bold;
            color: var(--gold);
            opacity: 0;
            pointer-events: none;
            animation: fadeOutUp 1s forwards;
            text-shadow: 0 0 5px rgba(255,215,0,0.8);
            z-index: 20;
        }

        @keyframes fadeOutUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }

        .tap-button-container {
            margin-top: 20px;
            text-align: center;
        }

        .tap-claim-btn {
            display: none; /* Hidden by default */
            position: relative;
            padding: 16px 30px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            color: white;
            background: linear-gradient(90deg, #28a745, #218838); /* Green gradient */
            box-shadow: 
                0 8px 0 #1e7e34, 
                0 15px 20px rgba(0, 0, 0, 0.4);
            transition: all 0.2s ease;
            transform-style: preserve-3d;
            perspective: 500px;
            overflow: hidden;
            z-index: 1;
        }

        .tap-claim-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #28a745, #218838); 
            z-index: -1;
            transition: all 0.3s ease;
        }
        
        .tap-claim-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.2), 
                transparent);
            transition: all 0.5s ease;
            z-index: -1;
        }
        
        .tap-claim-btn:hover {
            transform: translateY(4px);
            box-shadow: 
                0 4px 0 #1e7e34,
                0 8px 10px rgba(0, 0, 0, 0.3);
        }
        
        .tap-claim-btn:hover::after {
            left: 100%;
        }
        
        .tap-claim-btn:active {
            transform: translateY(8px);
            box-shadow: 
                0 0 0 #1e7e34,
                0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .tap-claim-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 8px 0 #1e7e34, 
                        0 15px 20px rgba(0, 0, 0, 0.4);
        }

        .points-per-tap-message {
            font-size: 16px;
            color: var(--light);
            margin-top: 15px; /* Spacing below the circle/claim button */
            font-weight: 500;
        }

        /* Referral Section Styles */
        .referral-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            display: none; /* Hidden by default */
        }

        .referral-section h3 {
            color: var(--secondary);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .referral-link-container {
            display: flex;
            margin-bottom: 15px;
            background-color: var(--dark);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--primary);
        }

        .referral-link-container input {
            flex-grow: 1;
            padding: 10px 15px;
            border: none;
            background: transparent;
            color: var(--light);
            font-size: 14px;
            outline: none;
            cursor: text;
        }

        .referral-link-container button {
            background: var(--primary);
            color: white;
            padding: 10px 15px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .referral-link-container button:hover {
            background: var(--primary-dark);
        }

        .referral-stats p {
            margin: 5px 0;
            font-size: 14px;
            color: #ccc;
        }

        .referral-stats span {
            font-weight: bold;
            color: var(--gold);
        }
    </style>
</head>
<body>
    <div class="ad-notification" id="ad-notification"></div>
    
    <div class="container">
        <!-- Language Selector -->
        <div class="language-selector">
            <button data-lang="ar" onclick="setLanguage('ar')">AR</button>
            <button data-lang="en" onclick="setLanguage('en')">EN</button>
            <button data-lang="ru" onclick="setLanguage('ru')">RU</button>
        </div>

        <div class="header">
            <h1 data-key="app_title">⛏️شغل المشاهده التلقائيه وادهب لي النوم 😴واستمتع بي الارباح🤫💵</h1>
        </div>
        
        <div class="content">
            <div class="user-info">
                <p data-key="earn_per_click_message">اربح 5 عملات pepe لكل نقرة🔥</p>
                <p data-key="min_withdrawal_message_static_general">السحب عن طريق FaucetPay من 10 عملات فقط ✅<br>السحب إلى أي محفظة أخرى من 100 عملة فقط ✅</p>
                 <p class="user-id-display" data-key="your_user_id">معرف المستخدم: <span id="display-user-id">جار التحميل...</span></p>
            </div>
            
            <!-- Moved and Enlarged Earned Points Stat Card -->
            <div class="stats"> 
                <div class="stat-card">
                    <h3 data-key="earned_points_label">عملات Pepe المكتسبة</h3>
                    <div class="value" id="earned-points">0.00</div>
                </div>
            </div>
            
            <!-- Removed Watched Ads and Daily Limit Stats here -->
            
            <div class="progress-container">
                <div class="progress-label">
                    <span data-key="progress_to_bonus">التقدم للمكافأة</span>
                    <span id="ads-progress">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
            
            <div class="ad-container">
                <div class="ad-label" data-key="ad_type_label">إعلان Adsgram بيني</div>
                
                <!-- New Tap Area -->
                <div class="tap-area" id="tap-area">
                    <img src="https://f.top4top.io/p_3464tveeu0.jpeg" alt="Pepe Coin Image" onerror="this.onerror=null; this.src='https://placehold.co/220x220/00BF63/FFFFFF?text=Pepe+Coin';">
                    <h2 id="taps-remaining">10</h2>
                    <p data-key="taps_to_claim">نقرة للمطالبة بالمكافأة</p>
                </div>

                <div class="tap-button-container">
                    <button class="btn-3d tap-claim-btn" id="claim-reward-btn" onclick="claimReward()" data-key="claim_reward_btn">المطالبة بالمكافأة</button>
                </div>
                
                <!-- New text below the tap area -->
                <p class="points-per-tap-message" data-key="points_per_tap_message">اربح 1 Pepe لكل نقرة</p>

            </div>
            
            <div class="website-section">
                <h3 data-key="visit_channel_title">قم بزيارة قناتنا على تيليجرام</h3>
                <button class="btn-3d btn-blue" onclick="window.open('https://t.me/dogsarn', '_blank')" data-key="visit_channel_button">زيارة القناة</button>
            </div>

            <div class="buttons">
                <!-- Button to show the integrated withdrawal form -->
                <button class="btn-3d btn-blue" id="show-withdraw-btn" onclick="showWithdrawForm()" data-key="withdraw_points_btn">سحب عملات Pepe</button>
                 <!-- Button to show the referral section -->
                <button class="btn-3d btn-blue" id="show-referral-btn" onclick="showReferralSection()" data-key="referral_program_btn">برنامج الإحالة</button>
            </div>

            <!-- Withdraw Section - Now integrated back into the main page -->
            <div class="withdraw-section" id="withdraw-section">
                <h3 data-key="withdrawal_request_title">طلب السحب</h3>
                <p class="current-balance" data-key="current_balance_label">رصيدك الحالي: <span id="current-earned-points">0.00</span> عملة Pepe</p>
                <p class="warning-message" data-key="withdrawal_warning">تنبيه 🙋🏻‍♂️
الحد الأدنى للسحب عن طريق FaucetPay هو 10 عملات pepe.
الحد الأدنى للسحب إلى أي محفظة أخرى هو 100 عملة pepe.
يرجى التأكد من إدخال عنوان محفظة صحيح لتلقي السحب بدون مشاكل (◍•ᴗ•◍)</p>
                <input type="number" id="withdraw-amount" data-key-placeholder="enter_points_placeholder" placeholder="أدخل الكمية لسحب عملات Pepe" />
                <select id="payment-method"> 
                    <option value="faucetpay" data-key="faucetpay_option">FaucetPay</option>
                    <option value="other_wallet" data-key="other_wallet_option">السحب إلى أي محفظة أخرى</option>
                </select>
                <input type="text" id="wallet-address" data-key-placeholder="wallet_address_placeholder" placeholder="أدخل عنوان المحفظة" /> 
                <button onclick="withdrawPoints()" data-key="withdraw_button">سحب</button>
                <p id="withdraw-status"></p>

                <div class="back-button-container">
                    <!-- Button to hide the withdrawal form -->
                    <a href="#" class="back-button" onclick="hideWithdrawForm(); return false;" data-key="back_to_main_page">العودة إلى الواجهة الرئيسية</a>
                </div>
            </div>

            <!-- Referral Section -->
            <div class="referral-section" id="referral-section">
                <h3 data-key="referral_title">برنامج الإحالة</h3>
                <p data-key="referral_description">ادعُ أصدقائك واكسب 10% من أرباحهم!</p>
                <div class="referral-link-container">
                    <input type="text" id="referral-link" readonly />
                    <button onclick="copyReferralLink()" data-key="copy_link_btn">نسخ الرابط</button>
                </div>
                <div class="referral-stats">
                    <p data-key="total_referrals">الإحالات الكلية: <span id="total-referrals">0</span></p>
                    <p data-key="earned_from_referrals">الربح من الإحالات: <span id="earned-from-referrals">0.00</span> Pepe</p>
                </div>
                <div class="back-button-container">
                    <a href="#" class="back-button" onclick="hideReferralSection(); return false;" data-key="back_to_main_page">العودة إلى الواجهة الرئيسية</a>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p data-key="footer_text">مؤمن بواسطة Firebase • جميع المعاملات محمية</p>
            <div class="firebase-logo">Firebase</div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // <<< معلومات تكوين Firebase الخاصة بك >>>
        // هذا الكائن يحتوي على بيانات مشروع Firebase الخاص بك.
        // تم استبدال القيم هنا بالقيم التي قدمتها.
        const firebaseConfig = {
          apiKey: "AIzaSyAOf0KsfC9HlOa7z1VdR31DBcYcJAynrnA",
          authDomain: "adrewardapp-e2755.firebaseapp.com",
          projectId: "adrewardapp-e2755",
          storageBucket: "adrewardapp-e2755.firebasestorage.app",
          messagingSenderId: "978106558327",
          appId: "1:978106558327:web:b567f8c72beb0113e2a372"
        };
        // <<< نهاية معلومات التكوين >>>

        // المتغيرات العامة لـ Firebase
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = null; // هذا هو معرف المستخدم المصادق عليه (UID)
        let isFirebaseReady = false; // NEW: Flag to track Firebase initialization and authentication state

        // الثوابت من السكريبت الأصلي الخاص بك
        const POINTS_PER_AD = 1.00;
        const TAPS_REQUIRED = 10;
        const ADS_FOR_BONUS = 10; 
        const MIN_WITHDRAW_POINTS = 100;
        const MIN_WITHDRAW_POINTS_FAUCETPAY = 10;
        const DAILY_AD_LIMIT = 100;
        const ADMIN_USER_ID = "-1002705355317"; 
        const BOT_TOKEN = "7509054222:AAFhFhVXFCOs4kXtHQBigGU2QeNamHX42LQ"; 
        const REFERRAL_PERCENTAGE = 0.10;

        // متغيرات الحالة، الآن يتم التحكم بها بشكل أساسي بواسطة Firestore
        let watchedAdsCount = 0;
        let earnedPoints = 0.00; 
        let dailyWatchedAdsCount = 0; 
        let lastWatchDate = ""; 
        let tapsCount = 0; 
        let referrerId = null; // معرف المستخدم الذي أحال هذا المستخدم
        let totalReferrals = 0; // عدد المستخدمين الذين أحالهم *هذا* المستخدم
        let earnedFromReferrals = 0.00; // النقاط التي كسبها *هذا* المستخدم من إحالاته

        // عناصر DOM
        const earnedPointsEl = document.getElementById('earned-points');
        const adsProgressEl = document.getElementById('ads-progress');
        const progressFillEl = document.getElementById('progress-fill');
        const adNotificationEl = document.getElementById('ad-notification');
        
        // عناصر DOM لقسم السحب
        const withdrawSectionEl = document.getElementById('withdraw-section');
        const withdrawStatusEl = document.getElementById('withdraw-status');
        const currentEarnedPointsEl = document.getElementById('current-earned-points');

        const tapAreaEl = document.getElementById('tap-area'); 
        const tapsRemainingEl = document.getElementById('taps-remaining'); 
        const claimRewardBtn = document.getElementById('claim-reward-btn'); 

        // عناصر DOM لقسم الإحالة
        const referralSectionEl = document.getElementById('referral-section');
        const referralLinkInput = document.getElementById('referral-link');
        const totalReferralsEl = document.getElementById('total-referrals');
        const earnedFromReferralsEl = document.getElementById('earned-from-referrals');
        const displayUserIdEl = document.getElementById('display-user-id'); // عنصر جديد لعرض معرف المستخدم


        // منطق الترجمة
        const translations = {
            ar: {
                app_title: "⛏️شغل المشاهده التلقائيه وادهب لي النوم 😴واستمتع بي الارباح🤫💵",
                earn_per_click_message: "اربح 5 عملات pepe لكل نقرة🔥", 
                points_per_tap_message: "اربح 1 Pepe لكل نقرة", 
                min_withdrawal_message_static_general: `السحب عن طريق FaucetPay من ${MIN_WITHDRAW_POINTS_FAUCETPAY} عملات فقط ✅\nالسحب إلى أي محفظة أخرى من ${MIN_WITHDRAW_POINTS} عملة فقط ✅`, 
                watched_ads_label: "الإعلانات المشاهدة", 
                earned_points_label: "عملات Pepe المكتسبة", 
                daily_limit_label: "المشاهدات اليومية", 
                progress_to_bonus: "التقدم للمكافأة",
                ad_type_label: "إعلان Adsgram بيني",
                taps_to_claim: "نقرة للمطالبة بالمكافأة", 
                claim_reward_btn: "المطالبة بالمكافأة", 
                visit_channel_title: "قم بزيارة قناتنا على تيليجرام", 
                visit_channel_button: "زيارة القناة", 
                footer_text: "مؤمن بواسطة Firebase • جميع المعاملات محمية",
                withdrawal_request_title: "طلب السحب", 
                current_balance_label: "رصيدك الحالي:", 
                withdrawal_warning: `تنبيه 🙋🏻‍♂️\nالحد الأدنى للسحب عن طريق FaucetPay هو ${MIN_WITHDRAW_POINTS_FAUCETPAY} عملات pepe.\nالحد الأدنى للسحب إلى أي محفظة أخرى هو ${MIN_WITHDRAW_POINTS} عملة pepe.\nيرجى التأكد من إدخال عنوان محفظة صحيح لتلقي السحب بدون مشاكل (◍•ᴗ•◍)`, 
                enter_points_placeholder: "أدخل الكمية لسحب عملات Pepe", 
                faucetpay_option: "FaucetPay", 
                other_wallet_option: "السحب إلى أي محفظة أخرى", 
                wallet_address_placeholder: "أدخل عنوان المحفظة", 
                withdraw_button: "سحب", 
                ad_loading: "جاري تحميل الإعلان... يرجى الانتظار",
                ad_completed_success: `اكتمل الإعلان! تمت إضافة {POINTS_PER_AD} عملة pepe إلى حسابك`, 
                ad_failed: "فشل عرض الإعلان. يرجى المحاولة مرة أخرى.",
                daily_limit_reached: `لقد وصلت للحد الأقصى من المشاهدات اليومية (${DAILY_AD_LIMIT}). يرجى المحاولة غدًا.`, 
                min_withdraw_message: `الحد الأدنى للسحب عن طريق {methodName} هو {minAmount} عملة pepe.`, 
                insufficient_balance: `رصيدك غير كافٍ. لديك {earnedPoints} عملة pepe.`, 
                enter_wallet_address: "يرجى إدخال عنوان المحفظة.", 
                withdrawal_success_message: 'تم إرسال طلب السحب بنجاح!', 
                telegram_send_fail: `فشل إرسال الطلب: {error}`, 
                telegram_connect_error: `خطأ في الاتصال بخدمة تيليجرام: {error}`, 
                unknown_method: "طريقة غير معروفة:", 
                back_to_main_page: "العودة إلى الواجهة الرئيسية", 
                withdraw_points_btn: "سحب عملات Pepe", 
                referral_program_btn: "برنامج الإحالة",
                referral_title: "برنامج الإحالة",
                referral_description: `ادعُ أصدقائك واكسب ${REFERRAL_PERCENTAGE * 100}% من أرباحهم!`,
                copy_link_btn: "نسخ الرابط",
                total_referrals: "الإحالات الكلية:",
                earned_from_referrals: "الربح من الإحالات:",
                link_copied_success: "تم نسخ رابط الإحالة بنجاح!",
                your_user_id: "معرف المستخدم:",
                loading_user_id: "جاري تحميل معرف المستخدم...", // NEW translation key
            },
            en: {
                app_title: "⛏️Enable Auto Watch, Go to Sleep 😴, and Enjoy the Profits🤫💵", 
                earn_per_click_message: "Earn 5 Pepe coins per click🔥", 
                points_per_tap_message: "Earn 1 Pepe per tap",
                min_withdrawal_message_static_general: `Withdrawal via FaucetPay from ${MIN_WITHDRAW_POINTS_FAUCETPAY} pepe coins only ✅\nWithdrawal to Any Other Wallet from ${MIN_WITHDRAW_POINTS} pepe coins only ✅`, 
                watched_ads_label: "Watched Ads", 
                earned_points_label: "Earned Pepe Coins", 
                daily_limit_label: "Daily Views", 
                progress_to_bonus: "Progress to Bonus",
                ad_type_label: "Adsgram Interstitial Ad",
                taps_to_claim: "taps to claim reward",
                claim_reward_btn: "Claim Reward",
                visit_channel_title: "Visit Our Telegram Channel", 
                visit_channel_button: "Visit Channel", 
                footer_text: "Secured by Firebase • All transactions are protected",
                withdrawal_request_title: "Withdrawal Request", 
                current_balance_label: "Your Current Balance:", 
                withdrawal_warning: `Warning 🙋🏻‍♂️\nMinimum withdrawal for FaucetPay is ${MIN_WITHDRAW_POINTS_FAUCETPAY} pepe coins.\nMinimum withdrawal for Any Other Wallet is ${MIN_WITHDRAW_POINTS} pepe coins.\nPlease ensure you enter a correct wallet address for smooth withdrawals (◍•ᴗ•◍)`, 
                enter_points_placeholder: "Enter Amount to Withdraw Pepe Coins", 
                faucetpay_option: "FaucetPay", 
                other_wallet_option: "Withdraw to Any Other Wallet", 
                wallet_address_placeholder: "Enter Wallet Address", 
                withdraw_button: "Withdraw", 
                ad_loading: "Loading ad... Please wait",
                ad_completed_success: `Ad completed! +{POINTS_PER_AD} Pepe Coins added to your account`, 
                ad_failed: "Failed to show ad. Please try again.",
                daily_limit_reached: `You have reached the daily ad limit (${DAILY_AD_LIMIT}). Please try again tomorrow.`, 
                min_withdraw_message: `Minimum withdrawal for {methodName} is {minAmount} pepe coins.`, 
                insufficient_balance: `Insufficient balance. You have {earnedPoints} Pepe Coins.`, 
                enter_wallet_address: "Please enter the wallet address.", 
                withdrawal_success_message: 'Withdrawal request sent successfully!', 
                telegram_send_fail: `Failed to send request: {error}`, 
                telegram_connect_error: `Error connecting to Telegram service: {error}`, 
                unknown_method: "Unknown Method:", 
                back_to_main_page: "Back to Main Page", 
                withdraw_points_btn: "Withdraw Pepe Coins", 
                referral_program_btn: "Referral Program",
                referral_title: "Referral Program",
                referral_description: `Invite your friends and earn ${REFERRAL_PERCENTAGE * 100}% of their earnings!`,
                copy_link_btn: "Copy Link",
                total_referrals: "Total Referrals:",
                earned_from_referrals: "Earned from Referrals:",
                link_copied_success: "Referral link copied successfully!",
                your_user_id: "User ID:",
                loading_user_id: "Loading User ID...", // NEW translation key
            },
            ru: {
                app_title: "⛏️Включи автопросмотр и иди спать 😴, наслаждайся прибылью🤫💵", 
                earn_per_click_message: "Заработайте 5 монет Pepe за клик🔥", 
                points_per_tap_message: "Заработайте 1 Pepe за нажатие",
                min_withdrawal_message_static_general: `Вывод через FaucetPay от ${MIN_WITHDRAW_POINTS_FAUCETPAY} монет pepe только ✅\nВывод на любой другой кошелек от ${MIN_WITHDRAW_POINTS} монет pepe только ✅`, 
                watched_ads_label: "Просмотрено объявлений", 
                earned_points_label: "Заработанные монеты Pepe", 
                daily_limit_label: "Ежедневные просмотры", 
                progress_to_bonus: "Прогресс к бонусу",
                ad_type_label: "Межстраничная реклама Adsgram",
                taps_to_claim: "нажатий для получения награды",
                claim_reward_btn: "Получить награду",
                visit_channel_title: "Посетите наш Telegram-канал", 
                visit_channel_button: "Посетить канал", 
                footer_text: "Защищено Firebase • Все транзакции защищены",
                withdrawal_request_title: "Запрос на вывод", 
                current_balance_label: "Ваш текущий баланс:", 
                withdrawal_warning: `Внимание 🙋🏻‍♂️\nМинимальная сумма вывода для FaucetPay составляет ${MIN_WITHDRAW_POINTS_FAUCETPAY} монет pepe.\nМинимальная сумма вывода для любого другого кошелька составляет ${MIN_WITHDRAW_POINTS} монет pepe.\nПожалуйста, убедитесь, что вы ввели правильный адрес кошелька для беспроблемного вывода средств (◍•ᴗ•◍)`, 
                enter_points_placeholder: "Введите сумму для вывода монет Pepe", 
                faucetpay_option: "FaucetPay", 
                other_wallet_option: "Вывод на любой другой кошелек", 
                wallet_address_placeholder: "Введите адрес кошелька", 
                withdraw_button: "Вывести", 
                ad_loading: "Загрузка рекламы... Пожалуйста, подождите",
                ad_completed_success: `Реклама завершена! +{POINTS_PER_AD} монет Pepe добавлено на ваш счет`, 
                ad_failed: "Не удалось показать рекламу. Пожалуйста, попробуйте еще раз.",
                daily_limit_reached: `Вы достигли дневного лимита по рекламе (${DAILY_AD_LIMIT}). Пожалуйста, попробуйте завтра.`, 
                min_withdraw_message: `Минимальная сумма вывода для {methodName} составляет {minAmount} монет pepe.`, 
                insufficient_balance: `Недостаточный баланс. У вас {earnedPoints} монет pepe.`, 
                enter_wallet_address: "Пожалуйста, введите адрес кошелька.", 
                withdrawal_success_message: 'Запрос на вывод успешно отправлен!', 
                telegram_send_fail: `Не удалось отправить запрос: {error}`, 
                telegram_connect_error: `Ошибка подключения к службе Telegram: {error}`, 
                unknown_method: "Неизвестный метод:", 
                back_to_main_page: "Вернуться на главную страницу", 
                withdraw_points_btn: "Вывести монеты Pepe", 
                referral_program_btn: "Referral Program",
                referral_title: "Реферальная программа",
                referral_description: `Приглашайте друзей и зарабатывайте ${REFERRAL_PERCENTAGE * 100}% от их заработка!`,
                copy_link_btn: "Копировать ссылку",
                total_referrals: "Всего рефералов:",
                earned_from_referrals: "Заработано с рефералов:",
                link_copied_success: "Реферальная ссылка успешно скопирована!",
                your_user_id: "ID пользователя:",
                loading_user_id: "Загрузка ID пользователя...", // NEW translation key
            }
        };

        let currentLanguage = localStorage.getItem('appLanguage') || 'ar'; // Default to Arabic

        // دالة للحصول على تاريخ اليوم بتنسيق YYYY-MM-DD
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // دالة لضبط اللغة وتحديث واجهة المستخدم
        window.setLanguage = function(lang) {
            currentLanguage = lang;
            localStorage.setItem('appLanguage', lang);
            document.documentElement.lang = lang; // Set HTML lang attribute

            // Update active button style
            document.querySelectorAll('.language-selector button').forEach(button => {
                if (button.dataset.lang === lang) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            // Translate all elements with data-key
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.dataset.key;
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'INPUT' && element.hasAttribute('data-key-placeholder')) {
                        element.placeholder = translations[lang][key];
                    } else if (key === 'ad_completed_success') {
                        // Use placeholder for POINTS_PER_AD
                        element.textContent = translations[lang][key].replace('{POINTS_PER_AD}', POINTS_PER_AD.toFixed(2));
                    } else if (key === 'daily_limit_reached') { 
                        element.textContent = translations[lang][key].replace(`(${DAILY_AD_LIMIT})`, `(${DAILY_AD_LIMIT})`); 
                    } else if (key === 'insufficient_balance') {
                        element.textContent = translations[lang][key].replace('{earnedPoints}', earnedPoints.toFixed(2));
                    } else if (key === 'min_withdrawal_message') { 
                        // This specific translation is handled dynamically in withdrawPoints
                    }
                    else {
                        element.textContent = translations[lang][key];
                    }
                }
            });

            // Translate all elements with data-key-placeholder
            document.querySelectorAll('[data-key-placeholder]').forEach(element => {
                const placeholderKey = element.dataset.keyPlaceholder;
                if (translations[lang] && translations[lang][placeholderKey]) {
                    element.placeholder = translations[lang][placeholderKey];
                }
            });

            // Translate options in the dropdown
            document.querySelectorAll('#payment-method option').forEach(option => {
                const key = option.dataset.key;
                if (translations[lang] && translations[lang][key]) {
                    option.textContent = translations[lang][key];
                }
            });

            // Re-render dynamic content (like numbers)
            earnedPointsEl.textContent = earnedPoints.toFixed(2); 
            adsProgressEl.textContent = `${Math.round((watchedAdsCount % ADS_FOR_BONUS) / ADS_FOR_BONUS * 100)}%`; 
            showAdNotification(''); 
            withdrawStatusEl.textContent = ''; // Clear withdrawal status as well
            if (withdrawSectionEl.style.display === 'block') { // Update balance if withdrawal form is visible
                currentEarnedPointsEl.textContent = earnedPoints.toFixed(2);
            }
            
            // Update taps remaining text
            tapsRemainingEl.textContent = TAPS_REQUIRED - tapsCount;

            // Update referral section UI
            totalReferralsEl.textContent = totalReferrals;
            earnedFromReferralsEl.textContent = earnedFromReferrals.toFixed(2);
            referralLinkInput.value = generateReferralLink();
            
            // Update user ID display based on authentication status
            displayUserIdEl.textContent = window.currentUserId ? window.currentUserId : translations[currentLanguage].loading_user_id;
        };

        // Initialize Firebase and load user data
        async function initFirebase() {
            try {
                // Use the firebaseConfig defined above
                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                    console.error("Firebase config is missing or incomplete. Please ensure firebaseConfig is set correctly.");
                    showAdNotification("Error: Firebase configuration missing.");
                    return;
                }
                
                // We use projectId as the appId in the Firestore path for GitHub Pages
                const appId = firebaseConfig.projectId; 

                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                // Sign in anonymously for GitHub Pages (no custom token)
                // Ensure "Anonymous Authentication" is enabled in your Firebase project (Authentication -> Sign-in method)
                await signInAnonymously(window.auth);
                console.log("Signed in anonymously.");

                // Listen for authentication state changes to get the user ID
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.currentUserId = user.uid;
                        console.log("Authenticated User ID:", window.currentUserId);
                        displayUserIdEl.textContent = window.currentUserId; // Display User ID
                        isFirebaseReady = true; // NEW: Set flag to true

                        // Now that we have a user ID, load/set up user data
                        loadUserDataFromFirestore(appId); // Pass appId here

                        // Check for referrer ID in URL parameters (Telegram Mini App context)
                        const urlParams = new URLSearchParams(window.location.search);
                        const ref = urlParams.get('startapp'); // Telegram Mini App passes params via 'startapp'
                        if (ref && ref.startsWith('ref_')) {
                            const foundReferrerId = ref.substring(4); // Extract referrer ID
                            if (foundReferrerId !== window.currentUserId) { // Prevent self-referral
                                referrerId = foundReferrerId;
                                // Store referrerId in Firestore for the current user
                                const userRef = doc(window.db, `artifacts/${appId}/users`, window.currentUserId);
                                
                                getDoc(userRef).then(docSnap => {
                                    // Only set referrerId if it hasn't been set before for this user
                                    if (!docSnap.exists() || !docSnap.data().referrerId) {
                                        updateDoc(userRef, { referrerId: referrerId }, { merge: true }) // Use merge to avoid overwriting
                                            .then(() => console.log(`Set referrerId ${referrerId} for user ${window.currentUserId}`))
                                            .catch(e => console.error("Error setting referrerId:", e, userRef));
                                    } else {
                                        console.log(`ReferrerId already set for user ${window.currentUserId}. Skipping.`);
                                    }
                                }).catch(e => console.error("Error checking user doc for referrerId:", e));

                                // Increment totalReferrals for the referrer (simplified, ideally backend)
                                const referrerRef = doc(window.db, `artifacts/${appId}/users`, referrerId);
                                getDoc(referrerRef).then(docSnap => {
                                    if (docSnap.exists()) {
                                        // A simple increment. For robust systems, use Cloud Functions and transactions.
                                        updateDoc(referrerRef, {
                                            totalReferrals: increment(1)
                                        }).then(() => console.log(`Incremented totalReferrals for ${referrerId}`));
                                    } else {
                                        console.warn(`Referrer ${referrerId} does not exist in Firestore. Cannot increment totalReferrals.`);
                                    }
                                }).catch(e => console.error("Error updating referrer's totalReferrals:", e));
                            }
                        }
                    } else {
                        window.currentUserId = null;
                        displayUserIdEl.textContent = translations[currentLanguage].loading_user_id; // Still loading or error
                        isFirebaseReady = false; // Firebase not ready for operations without user
                        console.log("No user signed in.");
                    }
                    updateButtonStates(); // Update button states immediately after auth change
                });

            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                showAdNotification("Error initializing app. Please try again.");
                displayUserIdEl.textContent = "Error loading user";
                isFirebaseReady = false; // Firebase not ready
                updateButtonStates(); // Update button states on error
            }
        }

        // Load user data from Firestore and set up real-time listener
        async function loadUserDataFromFirestore(appId) { // Receive appId as parameter
            if (!window.db || !window.currentUserId || !appId) {
                console.log("Firestore, User ID, or App ID not ready for data load.");
                return;
            }

            const userDocRef = doc(window.db, `artifacts/${appId}/users`, window.currentUserId);

            // Use onSnapshot to get real-time updates
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    earnedPoints = data.earnedPoints || 0.00;
                    watchedAdsCount = data.watchedAdsCount || 0;
                    dailyWatchedAdsCount = data.dailyWatchedAdsCount || 0;
                    lastWatchDate = data.lastWatchDate || "";
                    // Only update referrerId from docSnap if it's currently null in our state
                    if (!referrerId && data.referrerId) {
                        referrerId = data.referrerId; 
                    }
                    totalReferrals = data.totalReferrals || 0;
                    earnedFromReferrals = data.earnedFromReferrals || 0.00;

                    const todayDate = getTodayDate();
                    if (lastWatchDate !== todayDate) {
                        dailyWatchedAdsCount = 0;
                        // Update only if there's a date change
                        updateDoc(userDocRef, { dailyWatchedAdsCount: 0, lastWatchDate: todayDate })
                            .then(() => console.log("Daily count reset for new day."))
                            .catch(e => console.error("Error resetting daily count:", e));
                    }
                    console.log("User data loaded/updated from Firestore:", data);
                } else {
                    // User document not found, create a new one. This path should only hit for brand new users.
                    console.log("User document not found, creating new one.");
                    earnedPoints = 0.00;
                    watchedAdsCount = 0;
                    dailyWatchedAdsCount = 0;
                    lastWatchDate = getTodayDate();
                    totalReferrals = 0;
                    earnedFromReferrals = 0.00;
                    // When creating the document, include referrerId if available (from URL param)
                    setDoc(userDocRef, {
                        earnedPoints: earnedPoints,
                        watchedAdsCount: watchedAdsCount,
                        dailyWatchedAdsCount: dailyWatchedAdsCount,
                        lastWatchDate: lastWatchDate,
                        referrerId: referrerId, // Will be null if not referred via URL param
                        totalReferrals: totalReferrals,
                        earnedFromReferrals: earnedFromReferrals
                    })
                    .then(() => console.log("New user document created."))
                    .catch(e => console.error("Error creating user document:", e));
                }
                updateUI(); // Update UI after data load/update
                updateTapUI();
                updateReferralUI();
                updateButtonStates(); // Recalculate button states after data is loaded
            }, (error) => {
                console.error("Error listening to user document:", error);
                showAdNotification("Failed to load user data.");
            });
        }
        
        // Update UI elements
        function updateUI() {
            earnedPointsEl.textContent = earnedPoints.toFixed(2); 
            
            const progress = (watchedAdsCount % ADS_FOR_BONUS) / ADS_FOR_BONUS * 100;
            adsProgressEl.textContent = `${Math.round(progress)}%`;
            progressFillEl.style.width = `${progress}%`;
            
            // Add animation when points change
            earnedPointsEl.classList.remove('pulse');
            void earnedPointsEl.offsetWidth; // Trigger reflow
            earnedPointsEl.classList.add('pulse');

            updateButtonStates(); // Ensure button states are updated after UI changes
        }

        // Update tap UI elements
        function updateTapUI() {
            tapsRemainingEl.textContent = TAPS_REQUIRED - tapsCount;
            if (tapsCount >= TAPS_REQUIRED) {
                claimRewardBtn.style.display = 'block'; // Show claim button
                tapsRemainingEl.style.display = 'none'; // Hide taps remaining
                tapAreaEl.querySelector('p').style.display = 'none'; // Hide "taps to claim" text
            } else {
                claimRewardBtn.style.display = 'none'; // Hide claim button
                tapsRemainingEl.style.display = 'block'; // Show taps remaining
                tapAreaEl.querySelector('p').style.display = 'block'; // Show "taps to claim" text
            }
        }

        // Function to update button enabled/disabled states
        function updateButtonStates() {
            const limitReached = dailyWatchedAdsCount >= DAILY_AD_LIMIT;
            // NEW: Buttons are disabled if Firebase is not ready OR daily limit is reached
            claimRewardBtn.disabled = !isFirebaseReady || limitReached; 
            tapAreaEl.style.pointerEvents = (!isFirebaseReady || limitReached) ? 'none' : 'auto';

            // Also disable other main action buttons if Firebase not ready
            document.getElementById('show-withdraw-btn').disabled = !isFirebaseReady;
            document.getElementById('show-referral-btn').disabled = !isFirebaseReady;
        }
        
        // Handle tap area click
        tapAreaEl.addEventListener('click', async (event) => {
            // NEW: Check isFirebaseReady before processing tap
            if (!isFirebaseReady) {
                showAdNotification(translations[currentLanguage].loading_user_id); // Show loading message
                return;
            }
            if (dailyWatchedAdsCount >= DAILY_AD_LIMIT) {
                showAdNotification(translations[currentLanguage].daily_limit_reached);
                return; 
            }

            if (tapsCount < TAPS_REQUIRED) {
                tapsCount++;
                tapsRemainingEl.textContent = TAPS_REQUIRED - tapsCount;
                
                // Add visual feedback for tap
                const feedback = document.createElement('div');
                feedback.classList.add('tap-feedback');
                feedback.textContent = `+1`;
                // Position feedback relative to the tap area, but use event.clientX/Y for click location
                feedback.style.left = `${event.clientX - tapAreaEl.getBoundingClientRect().left}px`;
                feedback.style.top = `${event.clientY - tapAreaEl.getBoundingClientRect().top}px`;
                tapAreaEl.appendChild(feedback);

                // Add active class to tap area and image for visual feedback
                tapAreaEl.classList.add('active');
                setTimeout(() => {
                    feedback.remove();
                    tapAreaEl.classList.remove('active'); // Remove active class after animation
                }, 1000);

                if (tapsCount >= TAPS_REQUIRED) {
                    updateTapUI();
                }
            }
        });

        // Function to claim reward (show ad and update Firestore)
        window.claimReward = async function() {
            // NEW: Check isFirebaseReady before claiming
            if (!isFirebaseReady) {
                showAdNotification(translations[currentLanguage].loading_user_id); // Show loading message
                return;
            }
            if (dailyWatchedAdsCount >= DAILY_AD_LIMIT) {
                showAdNotification(translations[currentLanguage].daily_limit_reached);
                return; 
            }

            showAdNotification(translations[currentLanguage].ad_loading);
            claimRewardBtn.disabled = true; // Disable button while ad is loading
            tapAreaEl.style.pointerEvents = 'none'; // Disable tapping during ad loading
            
            try {
                if (typeof window.Adsgram !== 'undefined' && typeof window.Adsgram.init === 'function') {
                    await window.Adsgram.init({ blockId: "12082" }).show(); 
                    
                    const appId = firebaseConfig.projectId; // Use projectId as appId
                    const userDocRef = doc(window.db, `artifacts/${appId}/users`, window.currentUserId);
                    
                    let pointsToAdd = POINTS_PER_AD;
                    let newDailyWatchedAdsCount = dailyWatchedAdsCount + 1;
                    let newWatchedAdsCount = watchedAdsCount + 1;

                    if (newWatchedAdsCount % ADS_FOR_BONUS === 0) {
                        pointsToAdd += 1.00; // Bonus point
                    }

                    // Update user points in Firestore
                    await updateDoc(userDocRef, {
                        earnedPoints: increment(pointsToAdd),
                        watchedAdsCount: increment(1),
                        dailyWatchedAdsCount: newDailyWatchedAdsCount,
                        lastWatchDate: getTodayDate()
                    });

                    // --- Referral System Logic (Client-Side with Caveats) ---
                    // IMPORTANT: For a robust and secure referral system, especially for awarding points to the referrer,
                    // Firebase Cloud Functions and Firestore Transactions are highly recommended.
                    // Direct client-side updates to other users' documents are prone to security issues and race conditions
                    // without proper backend logic.

                    if (referrerId && referrerId !== window.currentUserId) { // Ensure there is a referrer and it's not the user themselves
                        const referrerEarn = POINTS_PER_AD * REFERRAL_PERCENTAGE;
                        const referrerDocRef = doc(window.db, `artifacts/${appId}/users`, referrerId);
                        
                        // Attempt to update referrer's points directly.
                        // This is simplified and can lead to race conditions if many referred users
                        // update the same referrer document simultaneously from their clients.
                        // A Cloud Function triggered by the referred user's points update is the ideal solution.
                        updateDoc(referrerDocRef, {
                            earnedFromReferrals: increment(referrerEarn)
                        })
                        .then(() => console.log(`Awarded ${referrerEarn.toFixed(2)} to referrer ${referrerId}`))
                        .catch(e => console.error(`Error awarding referrer points to ${referrerId}:`, e));
                    }
                    // End of Referral System Logic

                    showAdNotification(translations[currentLanguage].ad_completed_success.replace('{POINTS_PER_AD}', pointsToAdd.toFixed(2)));
                    
                    // Reset taps after successful claim
                    tapsCount = 0;
                    updateTapUI();
                } else {
                    console.error("Adsgram SDK is not loaded. Please check the script tag.");
                    showAdNotification(translations[currentLanguage].ad_failed);
                }

            } catch (error) {
                console.error("Adsgram ad error or Firestore update error:", error);
                showAdNotification(translations[currentLanguage].ad_failed);
            } finally {
                // NEW: Re-enable buttons based on current state (including firebase readiness)
                updateButtonStates(); 
            }
        }
        
        // Show ad notification
        function showAdNotification(message) {
            adNotificationEl.textContent = message;
            adNotificationEl.style.display = 'block';
            
            setTimeout(() => {
                adNotificationEl.style.display = 'none';
            }, 3000);
        }

        // Function to show withdrawal form
        window.showWithdrawForm = function() {
            if (!isFirebaseReady) { // NEW: Prevent showing if Firebase not ready
                showAdNotification(translations[currentLanguage].loading_user_id);
                return;
            }
            hideAllSections();
            withdrawSectionEl.style.display = 'block';
            currentEarnedPointsEl.textContent = earnedPoints.toFixed(2);
        }

        // Function to hide withdrawal form
        window.hideWithdrawForm = function() {
            withdrawSectionEl.style.display = 'none';
            withdrawStatusEl.textContent = ''; // Clear status message on hide
            showMainContent(); // Show main content when withdrawal form is hidden
        }

        // Function to handle withdrawal
        window.withdrawPoints = async function() {
            if (!isFirebaseReady) { // NEW: Prevent withdrawal if Firebase not ready
                showTemporaryMessage(translations[currentLanguage].loading_user_id, 'red');
                return;
            }

            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const paymentMethod = document.getElementById('payment-method').value; 
            const walletAddress = document.getElementById('wallet-address').value; 

            let minRequiredPoints;
            let methodName;

            if (paymentMethod === 'faucetpay') {
                minRequiredPoints = MIN_WITHDRAW_POINTS_FAUCETPAY;
                methodName = translations[currentLanguage].faucetpay_option;
            } else { 
                minRequiredPoints = MIN_WITHDRAW_POINTS;
                methodName = translations[currentLanguage].other_wallet_option;
            }

            if (isNaN(amount) || amount < minRequiredPoints) {
                let message = translations[currentLanguage].min_withdraw_message
                    .replace('{methodName}', methodName)
                    .replace('{minAmount}', minRequiredPoints);
                showTemporaryMessage(message, 'red');
                return;
            }

            if (amount > earnedPoints) {
                let message = translations[currentLanguage].insufficient_balance.replace('{earnedPoints}', earnedPoints.toFixed(2));
                showTemporaryMessage(message, 'red');
                return;
            }

            if (!walletAddress.trim()) { 
                showTemporaryMessage(translations[currentLanguage].enter_wallet_address, 'red');
                return;
            }

            try {
                const appId = firebaseConfig.projectId; // Use projectId as appId
                const userDocRef = doc(window.db, `artifacts/${appId}/users`, window.currentUserId);
                
                await updateDoc(userDocRef, {
                    earnedPoints: increment(-amount)
                });

                // Send withdrawal request to admin via Telegram
                let messageToAdmin = `New Withdrawal Request:\nUser: ${window.currentUserId}\nAmount: ${amount} pepe coins\nPayment Method: `;
                if (paymentMethod === 'faucetpay') {
                    messageToAdmin += `FaucetPay\nWallet Address: ${walletAddress}`;
                } else if (paymentMethod === 'other_wallet') {
                    messageToAdmin += `Other Wallet\nWallet Address: ${walletAddress}`;
                } else {
                    messageToAdmin += `Unknown Method: ${paymentMethod}\nWallet Address: ${walletAddress}`; 
                }
                
                sendWithdrawRequestToAdmin(messageToAdmin);

                showTemporaryMessage(translations[currentLanguage].withdrawal_success_message, 'green');

                document.getElementById('withdraw-amount').value = '';
                document.getElementById('wallet-address').value = '';

            } catch (error) {
                console.error("Error during withdrawal or Firestore update:", error);
                showTemporaryMessage("Withdrawal failed. Please try again.", 'red');
            }
        }

        // Function to send withdrawal request to admin via Telegram
        function sendWithdrawRequestToAdmin(message) {
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${ADMIN_USER_ID}&text=${encodeURIComponent(message)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        console.log('Message sent to admin');
                    } else {
                        console.error('Failed to send message to Telegram:', data.description || data);
                        let errorMessage = translations[currentLanguage].telegram_send_fail.replace('{error}', data.description || data);
                        showTemporaryMessage(errorMessage, 'red');
                    }
                })
                .catch(error => {
                    console.error('Error during fetch to Telegram API:', error);
                    let errorMessage = translations[currentLanguage].telegram_connect_error.replace('{error}', error.message);
                    showTemporaryMessage(errorMessage, 'red');
                });
        }

        // Utility for showing temporary messages
        let messageTimeout;
        function showTemporaryMessage(msg, color) {
            withdrawStatusEl.textContent = msg;
            withdrawStatusEl.style.color = color;
            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                withdrawStatusEl.textContent = '';
            }, 5000); 
        }

        // Referral system functions
        function generateReferralLink() {
            // Updated to use your Telegram bot username: @ididkd46_bot
            const botUsername = "ididkd46_bot"; // Your Telegram bot username (without the @)
            if (window.currentUserId) {
                return `https://t.me/${botUsername}?startapp=ref_${window.currentUserId}`;
            }
            return translations[currentLanguage].loading_user_id; // Show loading if ID not ready
        }

        window.showReferralSection = function() {
            if (!isFirebaseReady) { // NEW: Prevent showing if Firebase not ready
                showAdNotification(translations[currentLanguage].loading_user_id);
                return;
            }
            hideAllSections();
            referralSectionEl.style.display = 'block';
            updateReferralUI();
        }

        window.hideReferralSection = function() {
            referralSectionEl.style.display = 'none';
            showMainContent(); // Show main content when referral form is hidden
        }

        function updateReferralUI() {
            referralLinkInput.value = generateReferralLink();
            totalReferralsEl.textContent = totalReferrals;
            earnedFromReferralsEl.textContent = earnedFromReferrals.toFixed(2);
        }

        window.copyReferralLink = function() {
            if (!isFirebaseReady) { // NEW: Prevent copying if Firebase not ready
                showTemporaryMessage(translations[currentLanguage].loading_user_id, 'red');
                return;
            }
            referralLinkInput.select();
            document.execCommand('copy'); 
            showTemporaryMessage(translations[currentLanguage].link_copied_success, 'green');
        }

        // Function to hide all main sections (withdraw, referral, etc.)
        function hideAllSections() {
            withdrawSectionEl.style.display = 'none';
            referralSectionEl.style.display = 'none';
            document.querySelector('.ad-container').style.display = 'none';
            document.querySelector('.website-section').style.display = 'none';
            document.querySelector('.buttons').style.display = 'none';
        }

        // Function to show the main content
        function showMainContent() {
            document.querySelector('.ad-container').style.display = 'block';
            document.querySelector('.website-section').style.display = 'block';
            document.querySelector('.buttons').style.display = 'flex';
        }

        // Initialize Firebase then app logic on window load
        window.onload = async function() {
            setLanguage(currentLanguage); // Set initial language and translate static elements
            updateButtonStates(); // Set initial disabled state for buttons
            await initFirebase();
            // The onSnapshot listener in loadUserDataFromFirestore will handle further UI updates.
        };
    </script>
</body>
</html>
