<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Easy Earning Bot</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    /* Root variables for consistent theming */
    :root {
      --primary-color: #2ed914;
      --primary-hover: #3bff21;
      --secondary-color: #2a2a2e;
      --background-color: #1c1c1f;
      --text-color: #f0f0f0;
      --text-muted-color: #a0a0a0;
      --accent-color: #ff8c00;
      --card-bg: #252528;
      --error-color: #ff4d4d;
      --success-color: #4CAF50;
    }
    /* Universal box-sizing and tap-highlight prevention */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    /* Body styling for full-screen layout and centering */
    body {
      margin: 0; padding: 0; background-color: var(--background-color); color: var(--text-color);
      font-family: 'Segoe UI', 'Roboto', sans-serif; display: flex; justify-content: center; align-items: center;
      height: 100vh; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      overflow: hidden; /* Prevent body scroll */
    }
    /* Main container for the app, responsive and centered */
    .container {
      width: 100%; height: 100%; max-width: 400px; background: var(--background-color);
      display: flex; flex-direction: column; overflow: hidden; position: relative;
    }
    /* Main content area with scrollability and padding */
    main {
      flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; /* Space for footer nav */
    }
    /* View transitions for smooth navigation */
    .view { display: none; animation: fadeIn 0.4s ease-in-out; }
    .view.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    /* User header card styling */
    .user-header-card {
      background: var(--card-bg); border-radius: 16px; padding: 15px; margin-bottom: 25px;
      display: flex; align-items: center; border: 1px solid rgba(255, 255, 255, 0.05);
    }
    /* User avatar styling */
    .user-avatar {
      width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; overflow: hidden;
      background: linear-gradient(135deg, var(--primary-color), #00a651);
      display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px;
      color: #fff;
    }
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .user-info .username { font-size: 18px; font-weight: 700; margin: 0; }
    .user-info .title { font-size: 14px; color: var(--text-muted-color); margin: 0; }
    /* Balance card styling */
    .balance-card {
      background: linear-gradient(135deg, #00a651, #00753a); border-radius: 16px; padding: 20px;
      text-align: center; margin-bottom: 25px;
    }
    .balance-card .label { font-size: 16px; opacity: 0.8; margin-bottom: 5px; }
    .balance-card .balance-value { font-size: 36px; font-weight: 800; margin: 0; letter-spacing: 1px; }
    .balance-card .points-value { font-size: 16px; font-weight: 600; color: var(--accent-color); margin-top: 10px; }
    /* Section title styling */
    .section-title { font-size: 20px; font-weight: 700; margin-bottom: 15px; padding-left: 5px; border-left: 4px solid var(--primary-color); }
    /* Task card styling */
    .task-card {
      background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 15px;
      display: flex; align-items: center; cursor: pointer; transition: transform 0.2s ease, background-color 0.2s ease;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .task-card:hover { transform: translateY(-3px); background-color: var(--secondary-color); }
    .task-icon { font-size: 24px; color: var(--primary-color); margin-right: 20px; width: 30px; text-align: center; }
    .task-details h3 { margin: 0; font-size: 16px; font-weight: 600; }
    .task-details p { margin: 3px 0 0; font-size: 13px; color: var(--text-muted-color); }
    .task-arrow { margin-left: auto; font-size: 18px; color: var(--text-muted-color); }
    /* List item styling (for leaderboard and history) */
    .list-item {
      display: flex; align-items: center; background: var(--card-bg); padding: 12px 15px;
      border-radius: 10px; margin-bottom: 10px; border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .list-item .rank { font-size: 16px; font-weight: 700; color: var(--text-muted-color); width: 30px; }
    .list-item .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--secondary-color); margin-right: 15px; object-fit: cover; }
    .list-item .info { flex-grow: 1; }
    .list-item .info .name { font-weight: 600; font-size: 15px; }
    .list-item .info .detail { font-size: 13px; color: var(--text-muted-color); }
    .list-item .score { font-size: 16px; font-weight: 700; color: var(--accent-color); }
    .history-icon { color: var(--primary-color); margin-right: 15px; font-size: 18px; }
    /* Footer navigation styling */
    .footer-nav {
      position: fixed; bottom: 0; left: 0; right: 0; width: 100%; max-width: 400px; margin: 0 auto;
      display: flex; justify-content: space-around; background: var(--secondary-color);
      padding: 10px 0; border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    .nav-button {
      display: flex; flex-direction: column; align-items: center; color: var(--text-muted-color);
      background: none; border: none; font-size: 12px; transition: color 0.2s ease, transform 0.2s ease;
      cursor: pointer; padding: 5px 10px;
    }
    .nav-button .icon { font-size: 22px; margin-bottom: 4px; }
    .nav-button:hover { color: var(--text-color); }
    .nav-button.active { color: var(--primary-color); transform: scale(1.1); }
    /* Action button styling */
    .action-button {
      width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 16px; font-weight: 700;
      margin-top: 15px; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px;
    }
    .primary-button { background: var(--primary-color); color: #000; }
    .primary-button:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(46, 217, 20, 0.3); }
    .secondary-button { background: var(--secondary-color); color: var(--primary-color); }
    .secondary-button:hover { background: #3a3a3e; }
    .action-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    /* Modal overlay and content styling */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7);
      display: none; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.3s;
    }
    .modal-overlay.active { display: flex; }
    .modal-content {
      background: var(--card-bg); padding: 25px; border-radius: 16px; width: 90%; max-width: 320px;
      text-align: center; animation: slideIn 0.3s;
    }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-content h3 { margin-top: 0; font-size: 20px; }
    .modal-content p { color: var(--text-muted-color); margin-bottom: 25px; }
    .modal-actions { display: flex; gap: 10px; }

    /* Custom Notification/Message Box */
    #custom-notification {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        font-size: 14px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    #custom-notification.show {
        opacity: 1;
        visibility: visible;
    }
    #custom-notification.error {
        background-color: var(--error-color);
    }
    #custom-notification.success {
        background-color: var(--success-color);
    }

    /* Withdrawal Form Specific Styles */
    .form-group {
        margin-bottom: 15px;
        text-align: left;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        color: var(--text-muted-color);
    }
    .form-group input[type="number"],
    .form-group input[type="text"],
    .form-group select {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background-color: var(--secondary-color);
        color: var(--text-color);
        font-size: 15px;
    }
    .form-group input::placeholder {
        color: #777;
    }
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(46, 217, 20, 0.3);
    }
    .current-balance-info {
        font-size: 15px;
        color: var(--accent-color);
        margin-bottom: 20px;
        text-align: center;
    }
    .warning-message {
        font-size: 13px;
        color: var(--accent-color);
        background: rgba(255, 140, 0, 0.1);
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--accent-color);
        margin-bottom: 20px;
        white-space: pre-wrap; /* For multi-line messages */
    }

    /* Referral Section Specific Styles */
    .referral-link-container {
        display: flex;
        margin-bottom: 15px;
        background-color: var(--secondary-color);
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .referral-link-container input {
        flex-grow: 1;
        padding: 10px 15px;
        border: none;
        background: transparent;
        color: var(--text-color);
        font-size: 14px;
        outline: none;
        cursor: text;
    }
    .referral-link-container button {
        background: var(--primary-color);
        color: #000;
        padding: 10px 15px;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s ease;
        font-weight: 600;
    }
    .referral-link-container button:hover {
        background: var(--primary-hover);
    }
    .referral-stats p {
        margin: 8px 0;
        font-size: 14px;
        color: var(--text-muted-color);
    }
    .referral-stats span {
        font-weight: bold;
        color: var(--accent-color);
    }
    .back-button {
        display: block;
        width: fit-content;
        margin: 20px auto 0;
        padding: 10px 20px;
        background: var(--card-bg);
        color: var(--primary-color);
        border-radius: 10px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 600;
        transition: background-color 0.2s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .back-button:hover {
        background: var(--secondary-color);
    }
  </style>

  <!-- Firebase SDKs -->
  <script type="module" src="https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js"></script>
  <script src='//libtl.com/sdk.js' data-zone='9459352' data-sdk='show_9459352'></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">
    <main id="main-content">

      <!-- HOME VIEW -->
      <div id="home-view" class="view active">
        <div class="user-header-card">
          <div class="user-avatar" id="profile-pic">EE</div>
          <div class="user-info">
            <h2 class="username" id="username">Loading...</h2>
            <p class="title">Welcome Back!</p>
          </div>
        </div>
        <div class="balance-card">
            <p class="label">Total Balance</p>
            <h1 class="balance-value" id="balance-value">$0.00</h1>
            <p class="points-value"><i class="fa-solid fa-coins"></i> <span id="points-value">0</span> Points</p>
        </div>
        <h2 class="section-title">Quick Actions</h2>
        <div class="task-card" onclick="showView('tasks-view')">
            <div class="task-icon"><i class="fa-solid fa-list-check"></i></div>
            <div class="task-details"><h3>View Tasks</h3><p>Watch ads and complete tasks to earn points.</p></div>
            <div class="task-arrow"><i class="fa-solid fa-chevron-right"></i></div>
        </div>
        <div class="task-card" onclick="showView('withdraw-view')">
            <div class="task-icon"><i class="fa-solid fa-wallet"></i></div>
            <div class="task-details"><h3>Withdraw Funds</h3><p>Request to withdraw your available balance.</p></div>
            <div class="task-arrow"><i class="fa-solid fa-chevron-right"></i></div>
        </div>
        <!-- New AI-powered Earning Tips Card -->
        <div class="task-card" onclick="showEarningTips()">
            <div class="task-icon"><i class="fa-solid fa-lightbulb"></i></div>
            <div class="task-details"><h3>âœ¨ Ù†ØµØ§Ø¦Ø­ Ù„Ù„Ø±Ø¨Ø­</h3><p>Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ù…Ø®ØµØµØ© Ù„Ø²ÙŠØ§Ø¯Ø© Ø£Ø±Ø¨Ø§Ø­Ùƒ.</p></div>
            <div class="task-arrow"><i class="fa-solid fa-chevron-right"></i></div>
        </div>
      </div>

      <!-- TASKS VIEW -->
      <div id="tasks-view" class="view">
        <h2 class="section-title">Earning Tasks</h2>
        <div class="task-card" onclick="showRewardedInterstitial()">
            <div class="task-icon"><i class="fa-solid fa-rectangle-ad"></i></div>
            <div class="task-details"><h3>Rewarded Interstitial</h3><p>Watch a full-screen ad to earn rewards.</p></div>
            <div class="task-arrow"><i class="fa-solid fa-play"></i></div>
        </div>
        <div class="task-card" onclick="showRewardedPopup()">
            <div class="task-icon"><i class="fa-solid fa-window-restore"></i></div>
            <div class="task-details"><h3>Rewarded Popup</h3><p>View a popup ad for quick points.</p></div>
            <div class="task-arrow"><i class="fa-solid fa-play"></i></div>
        </div>
      </div>

      <!-- LEADERBOARD VIEW -->
      <div id="leaderboard-view" class="view">
        <h2 class="section-title">Top Earners</h2>
        <div id="leaderboard-list"><!-- Leaderboard items will be generated here by JS --></div>
      </div>

      <!-- HISTORY VIEW -->
      <div id="history-view" class="view">
        <h2 class="section-title">Recent Activity</h2>
        <div id="history-list"><!-- History items will be generated here by JS --></div>
      </div>

      <!-- WITHDRAWAL VIEW -->
      <div id="withdraw-view" class="view">
        <h2 class="section-title">Withdraw Funds</h2>
        <p class="current-balance-info">Your Current Balance: <span id="current-withdraw-balance">0.00</span> Points ($<span id="current-withdraw-usd">0.00</span>)</p>
        <p class="warning-message" id="withdraw-warning-message">
            Minimum withdrawal for FaucetPay is 10 points.
            Minimum withdrawal for Any Other Wallet is 100 points.
            Please ensure you enter a correct wallet address for smooth withdrawals.
        </p>

        <div class="form-group">
            <label for="withdraw-amount">Amount to Withdraw (Points)</label>
            <input type="number" id="withdraw-amount" placeholder="Enter points to withdraw" min="1">
        </div>
        <div class="form-group">
            <label for="payment-method">Payment Method</label>
            <select id="payment-method">
                <option value="faucetpay">FaucetPay</option>
                <option value="other_wallet">Any Other Wallet</option>
            </select>
        </div>
        <div class="form-group">
            <label for="wallet-address">Wallet Address</label>
            <input type="text" id="wallet-address" placeholder="Enter your wallet address">
        </div>
        <button class="action-button primary-button" onclick="requestWithdraw()">Request Withdrawal</button>
        <button class="action-button secondary-button back-button" onclick="showView('home-view')">Back to Home</button>
      </div>

      <!-- REFERRAL VIEW -->
      <div id="referral-view" class="view">
        <h2 class="section-title">Referral Program</h2>
        <p>Invite your friends and earn <span id="referral-percentage"></span>% of their earnings!</p>
        <div class="referral-link-container">
            <input type="text" id="referral-link" readonly />
            <button onclick="copyReferralLink()">Copy Link</button>
        </div>
        <div class="referral-stats">
            <p>Total Referrals: <span id="total-referrals">0</span></p>
            <p>Earned from Referrals: <span id="earned-from-referrals">0.00</span> Points</p>
        </div>
        <button class="action-button secondary-button back-button" onclick="showView('home-view')">Back to Home</button>
      </div>

      <!-- EARNING TIPS VIEW (New AI-powered feature) -->
      <div id="earning-tips-view" class="view">
          <h2 class="section-title">âœ¨ Ù†ØµØ§Ø¦Ø­ Ù„Ù„Ø±Ø¨Ø­</h2>
          <div class="card-bg p-4 rounded-lg shadow-md mb-4 text-center">
              <p id="tips-display" class="text-muted-color">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ØµØ§Ø¦Ø­ Ù…Ø®ØµØµØ©!</p>
              <div id="tips-loading" class="text-center text-primary-color mt-4 hidden">
                  <i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù†ØµØ§Ø¦Ø­...
              </div>
          </div>
          <button class="action-button primary-button" onclick="generateEarningTips()">ØªÙˆÙ„ÙŠØ¯ Ù†ØµØ§Ø¦Ø­ Ø¬Ø¯ÙŠØ¯Ø©</button>
          <button class="action-button secondary-button back-button" onclick="showView('home-view')">Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      </div>

    </main>

    <nav class="footer-nav">
      <button class="nav-button active" onclick="showView('home-view')"><i class="icon fa-solid fa-house"></i>Home</button>
      <button class="nav-button" onclick="showView('tasks-view')"><i class="icon fa-solid fa-list-check"></i>Tasks</button>
      <button class="nav-button" onclick="showView('leaderboard-view')"><i class="icon fa-solid fa-trophy"></i>Leaders</button>
      <button class="nav-button" onclick="showView('history-view')"><i class="icon fa-solid fa-clock-rotate-left"></i>History</button>
      <button class="nav-button" onclick="showView('referral-view')"><i class="icon fa-solid fa-users"></i>Referral</button>
    </nav>
  </div>

  <!-- Custom Notification Display -->
  <div id="custom-notification" class="custom-notification"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    // --- Firebase Configuration (Provided by user) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCydJckf37-5tcuEui380_B1Z2lQSgg5gc",
      authDomain: "alhdad-c435e.firebaseapp.com",
      projectId: "alhdad-c435e",
      storageBucket: "alhdad-c435e.firebasestorage.app",
      messagingSenderId: "598507430930",
      appId: "1:598507430930:web:12dbf6386bd6dbf0da64cb"
    };

    // Extract appId directly from firebaseConfig
    const appId = firebaseConfig.projectId; // Or firebaseConfig.appId if you prefer that specific ID

    // Global Firebase and Telegram Mini App variables
    let firebaseApp = null;
    let db = null;
    let telegramUserId = null;
    let telegramUsername = null;
    let isAppReady = false;

    // --- Constants ---
    const POINTS_PER_AD = 1; // Points earned per ad view (from second script)
    const RATE_PER_POINT = 0.05; // USD value per point (from second script)
    const MIN_WITHDRAW_POINTS_FAUCETPAY = 10;
    const MIN_WITHDRAW_POINTS_OTHER_WALLET = 100;
    const REFERRAL_PERCENTAGE = 0.10; // 10% referral earnings

    // Telegram Bot API details (Replace with your actual bot token and admin ID)
    const BOT_TOKEN = '7201062892:AAGewLnDhE6l7buTuXAIScVhI4d-XJZZ5Hs'; // Your bot token
    const ADMIN_USER_ID = '6357701459'; // Your Telegram Admin User ID

    // --- State Variables (Managed by Firestore) ---
    let points = 0;
    let balance = 0.00; // USD balance
    let historyLog = []; // Stored in Firestore as part of user document
    let referrerId = null;
    let totalReferrals = 0;
    let earnedFromReferrals = 0.00;

    // --- DOM Elements ---
    const usernameEl = document.getElementById('username');
    const profilePicDiv = document.getElementById('profile-pic');
    const pointsValueEl = document.getElementById('points-value');
    const balanceValueEl = document.getElementById('balance-value');
    const leaderboardListEl = document.getElementById('leaderboard-list');
    const historyListEl = document.getElementById('history-list');
    const customNotificationEl = document.getElementById('custom-notification');

    // Withdrawal View Elements
    const currentWithdrawBalanceEl = document.getElementById('current-withdraw-balance');
    const currentWithdrawUsdEl = document.getElementById('current-withdraw-usd');
    const withdrawAmountInput = document.getElementById('withdraw-amount');
    const paymentMethodSelect = document.getElementById('payment-method');
    const walletAddressInput = document.getElementById('wallet-address');
    const withdrawWarningMessageEl = document.getElementById('withdraw-warning-message');

    // Referral View Elements
    const referralPercentageEl = document.getElementById('referral-percentage');
    const referralLinkInput = document.getElementById('referral-link');
    const totalReferralsEl = document.getElementById('total-referrals');
    const earnedFromReferralsEl = document.getElementById('earned-from-referrals');

    // Earning Tips View Elements
    const earningTipsViewEl = document.getElementById('earning-tips-view');
    const tipsDisplayEl = document.getElementById('tips-display');
    const tipsLoadingEl = document.getElementById('tips-loading');

    // --- Core App Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        initApp();
    });

    async function initApp() {
        showNotification('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...', 'info');
        try {
            // Initialize Telegram WebApp
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                Telegram.WebApp.BackButton.onClick(handleBackButtonClick); // Set up back button listener
                Telegram.WebApp.onEvent('backButtonClicked', handleBackButtonClick); // Fallback/alternative
                
                const initDataUnsafe = Telegram.WebApp.initDataUnsafe;
                if (initDataUnsafe && initDataUnsafe.user && initDataUnsafe.user.id) {
                    telegramUserId = initDataUnsafe.user.id.toString();
                    telegramUsername = initDataUnsafe.user.username || '';
                    console.log("Telegram User ID:", telegramUserId);
                    console.log("Telegram Username:", telegramUsername);

                    // Initialize Firebase using the provided config
                    firebaseApp = initializeApp(firebaseConfig);
                    db = getFirestore(firebaseApp);
                    console.log("Firebase initialized with provided config.");

                    // Load user data and set up real-time listener
                    await loadUserDataFromFirestore(appId, telegramUserId);

                    // Process referral parameter from Telegram initData
                    const urlParams = new URLSearchParams(Telegram.WebApp.initData);
                    const startParam = urlParams.get('start_param');
                    if (startParam && startParam.startsWith('ref_')) {
                        const foundReferrerId = startParam.substring(4);
                        if (foundReferrerId !== telegramUserId) { // Prevent self-referral
                            const userDocRef = doc(db, `artifacts/${appId}/users/${telegramUserId}`);
                            const userDocSnap = await getDoc(userDocRef);
                            if (userDocSnap.exists() && !userDocSnap.data().referrerId) {
                                await updateDoc(userDocRef, { referrerId: foundReferrerId });
                                console.log(`Referrer ID ${foundReferrerId} set for user ${telegramUserId}.`);
                                // Increment referrer's totalReferrals
                                const referrerRef = doc(db, `artifacts/${appId}/users/${foundReferrerId}`);
                                await updateDoc(referrerRef, { totalReferrals: increment(1) });
                                console.log(`Referrer ${foundReferrerId}'s totalReferrals incremented.`);
                            } else if (!userDocSnap.exists()) {
                                // If user doc doesn't exist yet, referrerId will be set during doc creation
                                referrerId = foundReferrerId; // Store temporarily
                            }
                        }
                    }

                    isAppReady = true;
                    showNotification('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                } else {
                    showNotification("Ù…Ø¹Ø±Ù Ù…Ø³ØªØ®Ø¯Ù… Telegram ØºÙŠØ± Ù…ØªØ§Ø­. Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ ÙÙŠ Telegram.", 'error');
                    isAppReady = false;
                }
            } else {
                showNotification("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Telegram WebApp SDK. ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³ØªÙ‚Ù„.", 'info');
                // For standalone testing, you might mock telegramUserId
                telegramUserId = 'test_user_123';
                telegramUsername = 'testuser';
                
                // Initialize Firebase for standalone mode using the provided config
                firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                console.log("Firebase initialized in standalone mode with provided config.");
                await loadUserDataFromFirestore(appId, telegramUserId);
                isAppReady = true;
                showNotification('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­ (ÙˆØ¶Ø¹ Ù…Ø³ØªÙ‚Ù„)!', 'success');
            }
        } catch (error) {
            console.error("Error initializing app:", error);
            showNotification(`ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: ${error.message}`, 'error');
            isAppReady = false;
        } finally {
            updateUI(); // Initial UI update
            renderLeaderboard(); // Render static leaderboard
            updateWithdrawalWarning(); // Update withdrawal warning message
        }

        // Initialize Automatic Ads (Monetag SDK)
        initializeInAppAds();
    }

    async function loadUserDataFromFirestore(appId, userId) {
        if (!db || !userId || !appId) {
            console.warn("Firestore, User ID, or App ID not ready. Skipping data load.");
            return;
        }

        const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);

        onSnapshot(userDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                points = data.points || 0;
                balance = data.balance || 0.00;
                historyLog = data.historyLog || [];
                referrerId = data.referrerId || null; // Load referrerId if exists
                totalReferrals = data.totalReferrals || 0;
                earnedFromReferrals = data.earnedFromReferrals || 0.00;

                // If user document was just created and we had a referrerId from initData
                if (!data.referrerId && referrerId && referrerId !== userId) {
                    updateDoc(userDocRef, { referrerId: referrerId })
                        .then(() => console.log(`Referrer ID ${referrerId} set for new user ${userId}.`))
                        .catch(e => console.error("Error setting referrer for new user:", e));
                }

                console.log("User data loaded/updated from Firestore:", data);
            } else {
                console.log("User document not found, creating new one for user:", userId);
                points = 0;
                balance = 0.00;
                historyLog = [];
                totalReferrals = 0;
                earnedFromReferrals = 0.00;

                setDoc(userDocRef, {
                    points: points,
                    balance: balance,
                    historyLog: historyLog,
                    referrerId: referrerId, // Set referrerId if it came from initData
                    totalReferrals: totalReferrals,
                    earnedFromReferrals: earnedFromReferrals
                })
                .then(() => console.log("New user document created successfully."))
                .catch(e => console.error("Error creating user document:", e));
            }
            updateUI();
        }, (error) => {
            console.error("Error listening to user document in Firestore:", error);
            showNotification(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${error.message}`, 'error');
        });
    }

    // --- Initialize Automatic Ads ---
    function initializeInAppAds() {
        if (typeof show_9459352 === 'function') {
            show_9459352({
              type: 'inApp',
              inAppSettings: {
                frequency: 2,
                capping: 0.1,
                interval: 30,
                timeout: 5,
                everyPage: false
              }
            });
            console.log("Automatic In-App Interstitial Ads Initialized.");
        } else {
            console.warn("Monetag SDK not ready for In-App Ads. Retrying...");
            setTimeout(initializeInAppAds, 2000);
        }
    }

    // --- View Management ---
    function showView(viewId) {
        document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        
        document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector(`.nav-button[onclick="showView('${viewId}')"]`);
        if(activeBtn) activeBtn.classList.add('active');
        
        // Update specific view contents when activated
        if (viewId === 'history-view') renderHistory();
        if (viewId === 'withdraw-view') updateWithdrawalView();
        if (viewId === 'referral-view') updateReferralView();
        if (viewId === 'earning-tips-view') updateEarningTipsView(); // New: Update tips view

        // Manage Telegram BackButton visibility
        if (window.Telegram && Telegram.WebApp && Telegram.WebApp.BackButton) {
            if (viewId === 'home-view') {
                Telegram.WebApp.BackButton.hide();
            } else {
                Telegram.WebApp.BackButton.show();
            }
        }
    }

    // Handles Telegram's native back button click
    function handleBackButtonClick() {
        const currentActiveView = document.querySelector('.view.active');
        if (currentActiveView && currentActiveView.id !== 'home-view') {
            showView('home-view');
        } else {
            // If on home view, close the Mini App
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.close();
            }
        }
    }

    // --- Data Display Update ---
    function updateUI() {
        if (!telegramUserId) {
            usernameEl.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
            profilePicDiv.textContent = "EE";
            pointsValueEl.textContent = "0";
            balanceValueEl.textContent = "$0.00";
            return;
        }

        usernameEl.textContent = telegramUsername || 'Ù…Ø³ØªØ®Ø¯Ù… Telegram';
        if (Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user && Telegram.WebApp.initDataUnsafe.user.photo_url) {
            profilePicDiv.innerHTML = `<img src="${Telegram.WebApp.initDataUnsafe.user.photo_url}" alt="P">`;
        } else {
            profilePicDiv.textContent = (telegramUsername || 'U').charAt(0);
        }

        pointsValueEl.textContent = points;
        balanceValueEl.textContent = `$${balance.toFixed(2)}`;
        
        // Update withdrawal view if it's active
        if (document.getElementById('withdraw-view').classList.contains('active')) {
            updateWithdrawalView();
        }
        // Update referral view if it's active
        if (document.getElementById('referral-view').classList.contains('active')) {
            updateReferralView();
        }
        // Update earning tips view if it's active
        if (document.getElementById('earning-tips-view').classList.contains('active')) {
            updateEarningTipsView();
        }
    }

    // --- History Logic ---
    async function addToHistory(type, detail) {
        if (!db || !telegramUserId) {
            console.error("Firestore Ø£Ùˆ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„.");
            return;
        }
        const timestamp = new Date().toISOString();
        const newEntry = { type, detail, timestamp };
        
        // Prepend new entry and limit history to 50 items
        const updatedHistory = [newEntry, ...historyLog].slice(0, 50);
        
        const userDocRef = doc(db, `artifacts/${appId}/users/${telegramUserId}`);
        try {
            await updateDoc(userDocRef, { historyLog: updatedHistory });
            historyLog = updatedHistory; // Update local state after successful Firestore update
            console.log("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ Firestore.");
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ Firestore:", error);
        }
    }

    function renderHistory() {
        const list = historyListEl;
        if (historyLog.length === 0) {
            list.innerHTML = `<div class="list-item"><div class="info"><div class="name">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ø¨Ø¹Ø¯.</div><div class="detail">Ø´Ø§Ù‡Ø¯ Ø¨Ø¹Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù„Ù„Ø¨Ø¯Ø¡!</div></div></div>`;
            return;
        }
        
        list.innerHTML = historyLog.map(item => {
            const icon = item.type === 'earn' 
                ? '<i class="fa-solid fa-plus-circle" style="color: var(--primary-color);"></i>' 
                : '<i class="fa-solid fa-paper-plane" style="color: var(--accent-color);"></i>';
            return `
                <div class="list-item">
                    <div class="history-icon">${icon}</div>
                    <div class="info">
                        <div class="name">${item.detail}</div>
                        <div class="detail">${new Date(item.timestamp).toLocaleString('ar-EG')}</div>
                    </div>
                </div>`;
        }).join('');
    }

    // --- Leaderboard Logic (Static for now, can be dynamic with Firestore) ---
    function renderLeaderboard() {
        const leaderboardData = [
            { name: "CryptoKing", score: 2540, avatar: "https://i.pravatar.cc/150?img=1" },
            { name: "Elena", score: 2210, avatar: "https://i.pravatar.cc/150?img=2" },
            { name: "ProMiner", score: 1980, avatar: "https://i.pravatar.cc/150?img=3" },
            { name: "Aisha", score: 1750, avatar: "https://i.pravatar.cc/150?img=4" },
            { name: "BotMaster", score: 1530, avatar: "https://i.pravatar.cc/150?img=5" },
        ];
        
        leaderboardListEl.innerHTML = leaderboardData.map((user, index) => `
            <div class="list-item">
                <div class="rank">#${index + 1}</div>
                <img src="${user.avatar}" class="avatar" alt="Avatar">
                <div class="info"><div class="name">${user.name}</div></div>
                <div class="score">${user.score} pts</div>
            </div>
        `).join('');
    }

    // --- Earning Functions ---
    async function grantReward() {
        if (!db || !telegramUserId) {
            showNotification("Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ø¬Ø§Ù‡Ø². ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.", 'error');
            return;
        }

        const userDocRef = doc(db, `artifacts/${appId}/users/${telegramUserId}`);
        let pointsToAdd = POINTS_PER_AD;
        let usdToAdd = pointsToAdd * RATE_PER_POINT;

        try {
            // Update current user's points and balance
            await updateDoc(userDocRef, {
                points: increment(pointsToAdd),
                balance: increment(usdToAdd)
            });
            console.log(`User ${telegramUserId} earned ${pointsToAdd} points ($${usdToAdd.toFixed(2)}).`);

            // Handle referral earnings
            if (referrerId && referrerId !== telegramUserId) {
                const referrerEarnPoints = pointsToAdd * REFERRAL_PERCENTAGE;
                const referrerEarnUSD = usdToAdd * REFERRAL_PERCENTAGE;
                const referrerDocRef = doc(db, `artifacts/${appId}/users/${referrerId}`);
                
                await updateDoc(referrerDocRef, {
                    earnedFromReferrals: increment(referrerEarnPoints),
                    points: increment(referrerEarnPoints), // Add referral points to referrer's main points too
                    balance: increment(referrerEarnUSD) // Add referral USD to referrer's main balance too
                });
                console.log(`Referrer ${referrerId} earned ${referrerEarnPoints} points ($${referrerEarnUSD.toFixed(2)}) from referral.`);
            }

            showNotification(`ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø±Ø¨Ø­Øª +${pointsToAdd} Ù†Ù‚Ø·Ø©.`, 'success');
            addToHistory('earn', `+${pointsToAdd} Ù†Ù‚Ø·Ø© Ù…Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†`);
            Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ù…Ù†Ø­ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Firestore:", error);
            showNotification(`ÙØ´Ù„ Ø±Ø¨Ø­ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©: ${error.message}`, 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        }
    }

    function showRewardedInterstitial() {
        if (!isAppReady) {
            showNotification("Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø¹Ø¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.", 'info');
            return;
        }
        if (typeof show_9459352 !== 'function') {
            showNotification('Ù…Ø²ÙˆØ¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø². ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
            return;
        }
        showNotification('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†...', 'info');
        show_9459352().then(grantReward).catch(e => {
            console.error("ÙØ´Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¨ÙŠÙ†ÙŠ Ø¨Ù…ÙƒØ§ÙØ£Ø©:", e);
            showNotification('ØªØ¹Ø°Ø± Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        });
    }

    function showRewardedPopup() {
        if (!isAppReady) {
            showNotification("Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø¹Ø¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.", 'info');
            return;
        }
        if (typeof show_9459352 !== 'function') {
            showNotification('Ù…Ø²ÙˆØ¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø². ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
            return;
        }
        showNotification('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†...', 'info');
        show_9459352('pop').then(grantReward).catch(e => {
            console.error("ÙØ´Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ Ø¨Ù…ÙƒØ§ÙØ£Ø©:", e);
            showNotification('ØªØ¹Ø°Ø± Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        });
    }

    // --- Custom Notification Function ---
    let notificationTimeout;
    function showNotification(message, type = 'info', duration = 3000) {
        customNotificationEl.textContent = message;
        customNotificationEl.className = 'custom-notification show'; // Reset classes
        if (type === 'error') {
            customNotificationEl.classList.add('error');
        } else if (type === 'success') {
            customNotificationEl.classList.add('success');
        }
        
        clearTimeout(notificationTimeout);
        notificationTimeout = setTimeout(() => {
            customNotificationEl.classList.remove('show');
        }, duration);
    }

    // --- Withdrawal Logic ---
    function updateWithdrawalView() {
        currentWithdrawBalanceEl.textContent = points.toFixed(0);
        currentWithdrawUsdEl.textContent = balance.toFixed(2);
        updateWithdrawalWarning();
    }

    function updateWithdrawalWarning() {
        const selectedMethod = paymentMethodSelect.value;
        let minPoints = 0;
        if (selectedMethod === 'faucetpay') {
            minPoints = MIN_WITHDRAW_POINTS_FAUCETPAY;
        } else {
            minPoints = MIN_WITHDRAW_POINTS_OTHER_WALLET;
        }
        withdrawWarningMessageEl.innerHTML = `
            Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ Ù„Ù€ FaucetPay Ù‡Ùˆ ${MIN_WITHDRAW_POINTS_FAUCETPAY} Ù†Ù‚Ø·Ø©.<br>
            Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ Ù„Ø£ÙŠ Ù…Ø­ÙØ¸Ø© Ø£Ø®Ø±Ù‰ Ù‡Ùˆ ${MIN_WITHDRAW_POINTS_OTHER_WALLET} Ù†Ù‚Ø·Ø©.<br>
            Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${points.toFixed(0)} Ù†Ù‚Ø·Ø© ($${balance.toFixed(2)}).<br>
            ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸Ø© ØµØ­ÙŠØ­ Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø³Ø­Ø¨ Ø³Ù„Ø³Ø©.
        `;
    }

    paymentMethodSelect.addEventListener('change', updateWithdrawalWarning);

    async function requestWithdraw() {
        if (!isAppReady || !telegramUserId) {
            showNotification("Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ø¬Ø§Ù‡Ø². ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.", 'error');
            return;
        }

        const amount = parseFloat(withdrawAmountInput.value);
        const paymentMethod = paymentMethodSelect.value;
        const walletAddress = walletAddressInput.value.trim();

        let minRequiredPoints;
        let methodNameDisplay;

        if (paymentMethod === 'faucetpay') {
            minRequiredPoints = MIN_WITHDRAW_POINTS_FAUCETPAY;
            methodNameDisplay = 'FaucetPay';
        } else {
            minRequiredPoints = MIN_WITHDRAW_POINTS_OTHER_WALLET;
            methodNameDisplay = 'Ø£ÙŠ Ù…Ø­ÙØ¸Ø© Ø£Ø®Ø±Ù‰';
        }

        if (isNaN(amount) || amount <= 0) {
            showNotification("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ§Ù„Ø­.", 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            return;
        }

        if (amount < minRequiredPoints) {
            showNotification(`Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ Ù„Ù€ ${methodNameDisplay} Ù‡Ùˆ ${minRequiredPoints} Ù†Ù‚Ø·Ø©.`, 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            return;
        }

        if (amount > points) {
            showNotification(`Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ. Ù„Ø¯ÙŠÙƒ ${points.toFixed(0)} Ù†Ù‚Ø·Ø©.`, 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            return;
        }

        if (!walletAddress) {
            showNotification("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸ØªÙƒ.", 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            return;
        }

        try {
            const userDocRef = doc(db, `artifacts/${appId}/users/${telegramUserId}`);
            const usdAmount = amount * RATE_PER_POINT;

            // Deduct points and balance in Firestore
            await updateDoc(userDocRef, {
                points: increment(-amount),
                balance: increment(-usdAmount)
            });
            console.log(`ØªÙ… Ø®ØµÙ… ${amount} Ù†Ù‚Ø·Ø© ($${usdAmount.toFixed(2)}) Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${telegramUserId}.`);

            // Send withdrawal request to admin via Telegram Bot API
            const userInfo = telegramUsername ? `@${telegramUsername} (ID: ${telegramUserId})` : `Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${telegramUserId}`;
            const messageToAdmin = `ğŸ’¸ *Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯*\n\nğŸ‘¤ *Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:* ${userInfo}\nğŸ’° *Ø§Ù„Ù…Ø¨Ù„Øº:* ${amount} Ù†Ù‚Ø·Ø© ($${usdAmount.toFixed(2)})\nğŸ’³ *Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©:* ${methodNameDisplay}\nâœ‰ï¸ *Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©:* \`${walletAddress}\`\n\n_ÙŠØ±Ø¬Ù‰ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨._`;

            sendWithdrawRequestToAdmin(messageToAdmin, telegramUserId, amount, usdAmount);

            showNotification("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!", 'success');
            addToHistory('withdraw', `Ø·Ù„Ø¨ ${amount} Ù†Ù‚Ø·Ø© ($${usdAmount.toFixed(2)}) Ø¹Ø¨Ø± ${methodNameDisplay}`);
            Telegram.WebApp.HapticFeedback.notificationOccurred('success');

            // Clear form fields
            withdrawAmountInput.value = '';
            walletAddressInput.value = '';

        } catch (error) {
            console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø³Ø­Ø¨:", error);
            showNotification(`ÙØ´Ù„ Ø§Ù„Ø³Ø­Ø¨: ${error.message}`, 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        }
    }

    function sendWithdrawRequestToAdmin(message, userId, pointsAmount, usdAmount) {
        // Callback data format: approve_withdraw_<user_id>_<points>_<usd>
        const callbackData = `approve_withdraw_${userId}_${pointsAmount}_${usdAmount.toFixed(2)}`;
        
        const inlineKeyboard = {
            inline_keyboard: [
                [{ text: "âœ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø­Ø¨", callback_data: callbackData }]
            ]
        };
        const replyMarkup = encodeURIComponent(JSON.stringify(inlineKeyboard));

        fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${ADMIN_USER_ID}&text=${encodeURIComponent(message)}&parse_mode=Markdown&reply_markup=${replyMarkup}`)
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    console.log('Telegram Bot API: ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ Ø²Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.');
                } else {
                    console.error('Ø®Ø·Ø£ Telegram Bot API: ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Telegram:', data.description || JSON.stringify(data));
                    showNotification('ÙØ´Ù„ Ø¥Ø®Ø·Ø§Ø± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ø®ØµÙˆØµ Ø§Ù„Ø³Ø­Ø¨.', 'error');
                }
            })
            .catch(error => {
                console.error('Ø®Ø·Ø£ Telegram Bot API: Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ API Telegram:', error);
                showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© Ø¹Ù†Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø³Ø­Ø¨.', 'error');
            });
    }

    // --- Share & Referral ---
    function updateReferralView() {
        referralPercentageEl.textContent = (REFERRAL_PERCENTAGE * 100).toFixed(0);
        referralLinkInput.value = generateReferralLink();
        totalReferralsEl.textContent = totalReferrals;
        earnedFromReferralsEl.textContent = earnedFromReferrals.toFixed(0);
    }

    function generateReferralLink() {
        const botUsername = "Easyearing99_bot"; // Replace with your bot's actual username
        if (telegramUserId) {
            return `https://t.me/${botUsername}?startapp=ref_${telegramUserId}`;
        }
        return "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø©...";
    }

    window.copyReferralLink = function() {
        if (!isAppReady || !telegramUserId) {
            showNotification("Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ù„Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.", 'error');
            return;
        }
        referralLinkInput.select();
        document.execCommand('copy');
        showNotification("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!", 'success');
        Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    }

    // This function is for the 'Share' button in the footer nav
    function shareApp() {
        if (!telegramUserId) {
            showNotification("ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Telegram.", 'error');
            return;
        }
        const referralLink = generateReferralLink();
        const text = `ğŸ‰ Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø±Ø§Ø¦Ø¹ ÙˆØ§Ø¨Ø¯Ø£ ÙÙŠ Ø§Ù„ÙƒØ³Ø¨! Ø§Ø³ØªØ®Ø¯Ù… Ø±Ø§Ø¨Ø·ÙŠ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙƒØ§ÙØ£Ø© Ø®Ø§ØµØ©:`;
        const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=${encodeURIComponent(text)}`;
        Telegram.WebApp.openTelegramLink(shareUrl);
    }

    // --- New AI-Powered Earning Tips Logic ---
    function updateEarningTipsView() {
        // Reset display when entering the view
        tipsDisplayEl.textContent = 'Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ØµØ§Ø¦Ø­ Ù…Ø®ØµØµØ©!';
        tipsLoadingEl.classList.add('hidden');
    }

    window.showEarningTips = function() {
        showView('earning-tips-view');
    }

    window.generateEarningTips = async function() {
        if (!isAppReady || !telegramUserId) {
            showNotification("Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ø¬Ø§Ù‡Ø². ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.", 'error');
            return;
        }

        tipsDisplayEl.textContent = ''; // Clear previous tips
        tipsLoadingEl.classList.remove('hidden'); // Show loading indicator

        const prompt = `Ø£Ù†Ø§ Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø±Ø¨Ø­ Ø§Ù„Ù†Ù‚Ø§Ø·. Ù„Ø¯ÙŠ Ø­Ø§Ù„ÙŠÙ‹Ø§ ${points} Ù†Ù‚Ø·Ø© ÙˆØ±ØµÙŠØ¯ÙŠ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ù‡Ùˆ ${balance.toFixed(2)} Ø¯ÙˆÙ„Ø§Ø±. Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ Ù…Ù† Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª Ù‡ÙŠ ${REFERRAL_PERCENTAGE * 100}%. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ Ø¥Ù„Ù‰ FaucetPay Ù‡Ùˆ ${MIN_WITHDRAW_POINTS_FAUCETPAY} Ù†Ù‚Ø·Ø©ØŒ ÙˆØ¥Ù„Ù‰ Ø£ÙŠ Ù…Ø­ÙØ¸Ø© Ø£Ø®Ø±Ù‰ Ù‡Ùˆ ${MIN_WITHDRAW_POINTS_OTHER_WALLET} Ù†Ù‚Ø·Ø©.
        Ø£Ø¹Ø·Ù†ÙŠ 3 Ù†ØµØ§Ø¦Ø­ Ù…ÙˆØ¬Ø²Ø© ÙˆÙ…Ø¨ØªÙƒØ±Ø© (ÙÙŠ Ø´ÙƒÙ„ Ù†Ù‚Ø§Ø·) Ø­ÙˆÙ„ ÙƒÙŠÙÙŠØ© Ø²ÙŠØ§Ø¯Ø© Ø£Ø±Ø¨Ø§Ø­ÙŠ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª Ø§Ù„Ø±Ø¨Ø­ Ù…Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙˆØ§Ù„Ø¥Ø­Ø§Ù„Ø§Øª. Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù†ØµØ§Ø¦Ø­ Ø¹Ù…Ù„ÙŠØ© ÙˆÙ…Ø­ÙØ²Ø© ÙˆÙ…Ø¨Ø§Ø´Ø±Ø©.`;

        try {
            const apiKey = ""; // Canvas will provide this at runtime
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }]
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                tipsDisplayEl.textContent = text;
                showNotification("ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù†ØµØ§Ø¦Ø­ Ø¨Ù†Ø¬Ø§Ø­!", 'success');
            } else {
                tipsDisplayEl.textContent = "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† ØªÙˆÙ„ÙŠØ¯ Ù†ØµØ§Ø¦Ø­ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
                showNotification("ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù†ØµØ§Ø¦Ø­.", 'error');
                console.error("Gemini API response structure unexpected:", result);
            }
        } catch (error) {
            tipsDisplayEl.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© Ø§Ù„Ù†ØµØ§Ø¦Ø­. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
            showNotification("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© Ø§Ù„Ù†ØµØ§Ø¦Ø­.", 'error');
            console.error("Error calling Gemini API:", error);
        } finally {
            tipsLoadingEl.classList.add('hidden'); // Hide loading indicator
        }
    }
</script>

</body>
</html>
