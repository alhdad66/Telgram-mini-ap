<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="app_title">ØªØ·Ø¨ÙŠÙ‚ Ø¨ÙŠØ¨Ù‰ XO ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù…ÙŠÙ†ÙŠ Ù…Ø¹ Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† ÙˆØ§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</title>
    
    <!-- Adsgram SDK -->
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Firebase SDKs - MUST be loaded from CDN for Canvas Environment -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables accessible in main script
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentAppUserId = null; // Used for Firestore document IDs (Telegram ID if in Telegram, else Firebase UID)
        window.currentTelegramUsername = "Guest"; // Telegram username or fallback
        window.APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Global appId

        // Firebase Configuration - PROVIDED BY USER
        const firebaseConfig = {
          apiKey: "AIzaSyDunI1UMU27neEwpC1_Viq1cALM6Z57fFk",
          authDomain: "telgram1-44369.firebaseapp.com",
          projectId: "telgram1-44369",
          storageBucket: "telgram1-44369.firebasestorage.app",
          messagingSenderId: "69245093717",
          appId: "1:69245093717:web:c4cd5c042f77da359b51dc",
          measurementId: "G-7N4XZG92XW"
        };
        // End of Firebase Configuration

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        document.addEventListener('DOMContentLoaded', async () => {
            const appStatusMessagesEl = document.getElementById('app-status-messages');
            // Modified showAppStatus to accept a duration
            function showAppStatus(message, type = 'info', duration = 5000) { // Default duration 5 seconds
                clearTimeout(appStatusTimeout);
                appStatusMessagesEl.textContent = message;
                appStatusMessagesEl.style.display = 'block';
                if (type === 'error') {
                    appStatusMessagesEl.style.color = '#ff4444'; 
                    appStatusMessagesEl.style.backgroundColor = 'rgba(255, 68, 68, 0.1)';
                } else if (type === 'success') {
                    appStatusMessagesEl.style.color = '#4CAF50'; 
                    appStatusMessagesEl.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
                } else { // info
                    appStatusMessagesEl.style.color = '#ffeb3b'; 
                    appStatusMessagesEl.style.backgroundColor = 'rgba(255, 235, 59, 0.1)';
                }
                if (duration > 0) { // Persist if duration is 0
                    appStatusTimeout = setTimeout(() => {
                        appStatusMessagesEl.style.display = 'none';
                    }, duration);
                }
            }
            window.showAppStatus = showAppStatus; // Make it globally accessible

            showAppStatus('Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');

            if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey) {
                try {
                    window.firebaseApp = initializeApp(firebaseConfig);
                    window.db = getFirestore(window.firebaseApp);
                    window.auth = getAuth(window.firebaseApp);
                    showAppStatus('ØªÙ… ØªÙ‡ÙŠØ¦Ø© Firebase Ø¨Ù†Ø¬Ø§Ø­.', 'info');

                    // Handle Firebase Authentication state changes
                    onAuthStateChanged(window.auth, async (user) => {
                        let authAttemptSuccessful = false;
                        if (user) {
                            window.currentAppUserId = user.uid;
                            showAppStatus('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Firebase: ' + user.uid, 'success');
                            authAttemptSuccessful = true;
                        } else {
                            try {
                                showAppStatus('Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Firebase...', 'info', 0); // Show persistent loading
                                if (initialAuthToken) {
                                    const userCredential = await signInWithCustomToken(window.auth, initialAuthToken);
                                    window.currentAppUserId = userCredential.user.uid;
                                    showAppStatus('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ø®ØµØµ: ' + userCredential.user.uid, 'success');
                                } else {
                                    const userCredential = await signInAnonymously(window.auth);
                                    window.currentAppUserId = userCredential.user.uid;
                                    showAppStatus('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„: ' + userCredential.user.uid, 'success');
                                }
                                authAttemptSuccessful = true;
                            } catch (error) {
                                // Display specific Firebase Auth error message
                                showAppStatus('Ø®Ø·Ø£ ÙÙŠ Ù…ØµØ§Ø¯Ù‚Ø© Firebase: ' + error.message, 'error', 0); // Keep error visible
                                window.currentAppUserId = localStorage.getItem('localUserId') || 'USR-' + Math.floor(10000 + Math.random() * 90000);
                                localStorage.setItem('localUserId', window.currentAppUserId);
                            }
                        }

                        if (authAttemptSuccessful) {
                            if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                                // Prefer Telegram ID if available and valid
                                window.currentAppUserId = window.Telegram.WebApp.initDataUnsafe.user.id.toString();
                                window.currentTelegramUsername = window.Telegram.WebApp.initDataUnsafe.user.username || window.Telegram.WebApp.initDataUnsafe.user.first_name || "Telegram User";
                                showAppStatus('ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªØ·Ø¨ÙŠÙ‚ Telegram Ø§Ù„Ù…ØµØºØ± ÙˆØªØ¹ÙŠÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….', 'success');
                                
                                window.Telegram.WebApp.ready();
                                window.Telegram.WebApp.expand();

                                if (window.Telegram.WebApp.initDataUnsafe.start_param) {
                                    const referrerIdFromParam = window.Telegram.WebApp.initDataUnsafe.start_param;
                                    if (referrerIdFromParam && referrerIdFromParam !== window.currentAppUserId) {
                                        recordReferral(referrerIdFromParam, window.currentAppUserId, window.currentTelegramUsername);
                                    }
                                }
                            } else {
                                showAppStatus('Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªØ·Ø¨ÙŠÙ‚ Telegram Ø§Ù„Ù…ØµØºØ±. ØªØ£ÙƒØ¯ Ù…Ù† ÙØªØ­Ù‡ Ø¹Ø¨Ø± Telegram.', 'info');
                                window.currentTelegramUsername = "GuestUser";
                            }
                            initApp(); // Call initApp after all ID/username determination
                        } else {
                            // If auth failed, still call initApp but with a clear status that some features won't work
                            showAppStatus('Ø®Ø·Ø£: ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ. Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„.', 'error', 0); // Keep general error visible
                            initApp(); // Still initialize the app, but inform the user.
                        }
                    });
                } catch (error) {
                    showAppStatus('Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase: ' + error.message, 'error', 0); // Persistent error
                    window.currentAppUserId = localStorage.getItem('localUserId') || 'USR-' + Math.floor(10000 + Math.random() * 90000);
                    localStorage.setItem('localUserId', window.currentAppUserId);
                    window.currentTelegramUsername = "GuestUser";
                    initApp(); 
                }
            } else {
                showAppStatus('Ø®Ø·Ø£: Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ù…ÙÙ‚ÙˆØ¯Ø©. Ù„Ù† ØªØ¹Ù…Ù„ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© Ø¹Ù„Ù‰ Firebase.', 'error', 0); // Persistent error
                window.currentAppUserId = localStorage.getItem('localUserId') || 'USR-' + Math.floor(10000 + Math.random() * 90000);
                localStorage.setItem('localUserId', window.currentAppUserId);
                window.currentTelegramUsername = "GuestUser";
                initApp(); 
            }
        });
    </script>

    <style>
        :root {
            /* Changed primary and secondary colors to vibrant green shades */
            --primary: #00BF63; /* Vibrant Green */
            --primary-dark: #008C4A; /* Darker shade for shadows */
            --secondary: #32CD32; /* Lime Green, for a more vibrant accent */
            --secondary-dark: #28A745; /* Darker shade of secondary */
            
            --dark: #121212;
            --darker: #0a0a0a;
            --light: #f5f5f5;
            --gray: #2a2a2a;
            --card-bg: #1f1f1f;
            --gold: #ffd700;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--darker), #1a1a2e);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow-x: hidden;
            flex-direction: column; /* Allow content to stack vertically */
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(0, 191, 99, 0.1) 0%, transparent 20%), /* Adjusted for green */
                radial-gradient(circle at 90% 80%, rgba(50, 205, 50, 0.1) 0%, transparent 20%); /* Adjusted for green */
            z-index: -1;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background: var(--card-bg);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 20px; /* Space between container and footer/next section */
        }
        
        .header {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            padding: 25px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, 
                rgba(255,255,255,0.1) 0%,
                rgba(255,255,255,0) 50%,
                rgba(255,255,255,0.1) 100%);
            z-index: 1;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            z-index: 2;
        }
        
        .content {
            padding: 25px;
        }
        
        .user-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .user-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .stats {
            display: flex;
            justify-content: center; /* Center the single card */
            margin: 20px 0;
            text-align: center;
            flex-wrap: wrap; /* Allow wrapping for multiple cards */
            gap: 15px; /* Space between stat cards */
        }
        
        .stat-card { /* General style for any stat card */
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            padding: 15px 20px;
            width: 80%; /* Adjusted for better spacing with 3 cards */
            max-width: 300px;
        }

        #earned-points-card { /* Specific styles for the earned points card (Pepe balance) */
            order: 1; /* Order for display */
        }
        
        #earned-points-card h3 {
            font-size: 18px; /* Larger heading */
            margin-bottom: 5px;
            color: #aaa;
        }
        
        #earned-points-card .value {
            font-size: 36px; /* Much larger value */
            font-weight: 700;
            color: var(--primary); 
            display: flex; /* Use flexbox to align text and image */
            align-items: center; /* Vertically center items */
            justify-content: center; /* Horizontally center items */
            gap: 10px; /* Space between text and image */
        }
        
        /* Daily Competition Points card style */
        #daily-competition-points-card {
            order: 2;
        }
        #daily-competition-points-card h3 {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }
        #daily-competition-points-card .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--secondary);
        }
        
        /* Referral Count Card */
        #referral-count-card {
            order: 3;
        }
        #referral-count-card h3 {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }
        #referral-count-card .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--gold);
        }

        .pepe-logo {
            width: 35px; /* Size of the logo */
            height: 35px;
            border-radius: 50%; /* Make it circular */
            object-fit: contain; /* Ensure image fits well */
            background-color: #f5f5f5; /* Light background for logo visibility */
            padding: 2px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.3); /* Subtle shadow */
        }
        
        .progress-container {
            margin: 25px 0;
            text-align: center;
        }
        
        .progress-label {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            border-radius: 10px;
            width: 30%;
            transition: width 0.5s ease;
        }
        
        .game-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(3, 90px);
            grid-template-rows: repeat(3, 90px);
            gap: 8px;
            background-color: var(--dark);
            border-radius: 15px;
            padding: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            width: fit-content;
            margin-bottom: 15px;
        }

        .cell {
            width: 90px;
            height: 90px;
            background-color: var(--card-bg);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3.5em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            color: var(--primary);
        }

        .cell:hover {
            background-color: rgba(0, 191, 99, 0.2); /* Adjusted for green hover */
            transform: scale(1.05);
        }

        .cell.x {
            color: var(--gold);
        }

        .cell.o {
            color: var(--secondary);
        }

        #game-status {
            font-size: 1.4em;
            margin-bottom: 15px;
            color: var(--light);
            font-weight: 600;
        }
        
        /* 3D Button Styles */
        .btn-3d {
            position: relative;
            padding: 16px 20px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: white;
            text-align: center;
            transition: all 0.2s ease;
            transform-style: preserve-3d;
            perspective: 500px;
            box-shadow: 
                0 8px 0 var(--primary-dark), 
                0 15px 20px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            z-index: 1;
            width: 100%; /* Ensure buttons take full width within their container */
            max-width: 300px; /* Limit button width for better appearance */
        }
        
        .btn-3d::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, var(--primary), var(--secondary)); 
            z-index: -1;
            transition: all 0.3s ease;
        }
        
        .btn-3d::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.2), 
                transparent);
            transition: all 0.5s ease;
            z-index: -1;
        }
        
        .btn-3d:hover {
            transform: translateY(4px);
            box-shadow: 
                0 4px 0 var(--primary-dark),
                0 8px 10px rgba(0, 0, 0, 0.3);
        }
        
        .btn-3d:hover::after {
            left: 100%;
        }
        
        .btn-3d:active {
            transform: translateY(8px);
            box-shadow: 
                0 0 0 var(--primary-dark),
                0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .btn-secondary {
            box-shadow: 
                0 8px 0 var(--secondary-dark), 
                0 15px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn-secondary::before {
            background: linear-gradient(45deg, var(--secondary), var(--primary-dark)); 
        }
        
        .btn-blue {
            box-shadow: 
                0 8px 0 var(--primary-dark), 
                0 15px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn-blue::before {
            background: linear-gradient(45deg, var(--primary), var(--secondary)); 
        }

        .btn-gold {
            box-shadow: 
                0 8px 0 rgba(212, 175, 55, 0.7), /* Darker gold for shadow */
                0 15px 20px rgba(0, 0, 0, 0.3);
        }
        .btn-gold::before {
            background: linear-gradient(45deg, var(--gold), #FFD700); /* Gold gradient */
        }
        .btn-gold:hover {
            box-shadow: 
                0 4px 0 rgba(212, 175, 55, 0.7),
                0 8px 10px rgba(0, 0, 0, 0.3);
        }
        .btn-gold:active {
            box-shadow: 
                0 0 0 rgba(212, 175, 55, 0.7),
                0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .main-action-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 25px auto; /* Center buttons and add vertical spacing */
            width: 100%;
            max-width: 300px;
        }

        .website-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        
        .website-section h3 {
            color: var(--secondary); 
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .footer {
            text-align: center;
            padding: 15px;
            color: #777;
            font-size: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            width: 100%;
            max-width: 500px;
            margin-top: 20px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .firebase-logo {
            display: inline-block;
            margin-top: 10px;
            font-size: 10px;
            background: rgba(255, 152, 0, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            color: #ffa726;
        }
        
        /* New: Ad container for central ads (used for Adsgram iframes/ins tags) */
        .ad-container-flex {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px; /* Space between ads */
            margin: 20px 0;
        }
        
        /* Animation for pulse effect */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 0.5s ease;
        }
        
        /* Notification style */
        .ad-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            text-align: center;
        }

        /* App Status Message Bar */
        .app-status-messages {
            margin-top: 15px;
            text-align: center;
            font-size: 13px;
            color: #ffeb3b; /* Default info color */
            padding: 10px;
            background-color: rgba(255, 235, 59, 0.1); /* Default info background */
            border-radius: 10px;
            display: none; /* Hidden by default, shown by JS */
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }


        /* Reward Choice Modal Styles */
        .reward-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .reward-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .reward-modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            width: 90%;
            max-width: 400px;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .reward-modal-overlay.active .reward-modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .reward-modal-content h3 {
            color: var(--gold);
            margin-bottom: 25px;
            font-size: 24px;
        }

        .reward-modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .reward-modal-buttons .btn-3d {
            width: 100%;
            max-width: none; /* Override max-width for modal buttons */
        }

        /* Leaderboard Modal Styles */
        .leaderboard-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1002; /* Higher z-index than reward modal */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .leaderboard-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .leaderboard-modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            width: 90%;
            max-width: 500px;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            position: relative; /* For close button positioning */
        }

        .leaderboard-modal-overlay.active .leaderboard-modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .leaderboard-modal-content h3 {
            color: var(--gold);
            margin-bottom: 20px;
            font-size: 24px;
        }

        .leaderboard-list {
            list-style: none;
            padding: 0;
            max-height: 300px; /* Scrollable list */
            overflow-y: auto;
            margin-bottom: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaderboard-list li {
            display: flex;
            justify-content: space-between;
            align-items: center; /* Align items vertically */
            padding: 10px 0;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.05);
            font-size: 16px;
        }

        .leaderboard-list li:last-child {
            border-bottom: none;
        }

        .leaderboard-list li .rank {
            font-weight: bold;
            color: var(--secondary);
            width: 30px;
            text-align: left;
        }

        .leaderboard-list li .user-info-entry { /* Combined username and user ID */
            flex-grow: 1;
            text-align: left;
            margin-left: 10px;
            color: var(--light);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .leaderboard-list li .user-info-entry .username {
            font-weight: 600;
            color: var(--light);
        }
        .leaderboard-list li .user-info-entry .userid-mini {
            font-size: 0.7em;
            color: #888;
        }

        .leaderboard-list li.current-user {
            background-color: rgba(255, 215, 0, 0.1); /* Highlight current user */
            border: 1px solid var(--gold);
            border-radius: 10px;
            padding: 10px;
            margin: 5px 0;
        }

        .leaderboard-list li .points {
            font-weight: bold;
            color: var(--primary);
            width: 60px;
            text-align: right;
        }

        .leaderboard-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: #aaa;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .leaderboard-close-btn:hover {
            color: var(--light);
        }

        .user-rank-display {
            font-size: 1.1em;
            margin-top: 15px;
            color: var(--light);
            font-weight: 600;
        }

        /* Referral Modal Styles */
        .referral-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1003;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .referral-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .referral-modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            width: 90%;
            max-width: 450px;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            position: relative;
        }
        .referral-modal-overlay.active .referral-modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .referral-modal-content h3 {
            color: var(--gold);
            margin-bottom: 20px;
            font-size: 24px;
        }
        .referral-modal-content p {
            margin-bottom: 15px;
            font-size: 15px;
        }
        .referral-link-container {
            background-color: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 10px;
            word-break: break-all; /* Break long links */
            font-size: 14px;
            color: var(--light);
            margin-bottom: 20px;
            border: 1px dashed rgba(255, 255, 255, 0.2);
            position: relative;
        }
        .referral-link-container.copied::after {
            content: 'ØªÙ… Ø§Ù„Ù†Ø³Ø®!';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            color: #4CAF50;
            animation: fadeOut 2s forwards;
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .referral-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .referral-buttons .btn-3d {
            width: 100%;
            max-width: none;
        }
        .referral-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: #aaa;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .referral-close-btn:hover {
            color: var(--light);
        }


        /* Responsive design */
        @media (max-width: 480px) {
            .container {
                border-radius: 15px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .content {
                padding: 20px;
            }
            .game-board {
                grid-template-columns: repeat(3, 80px); /* Smaller cells on small screens */
                grid-template-rows: repeat(3, 80px);
                gap: 6px;
                padding: 10px;
            }
            .cell {
                width: 80px;
                height: 80px;
                font-size: 3em;
            }
            #game-status {
                font-size: 1.2em;
            }
            .btn-3d {
                padding: 12px 15px;
                font-size: 14px;
            }
            #earned-points-card, #daily-competition-points-card, #referral-count-card { 
                width: 90%; /* Adjust for smaller screens */
                padding: 20px 15px;
            }
            #earned-points-card h3 {
                font-size: 16px;
            }
            #earned-points-card .value {
                font-size: 30px;
                gap: 8px; /* Adjust gap for smaller screens */
            }
            .pepe-logo {
                width: 30px; /* Adjust logo size for smaller screens */
                height: 30px;
            }
            #daily-competition-points-card h3, #referral-count-card h3 { 
                font-size: 13px;
            }
            #daily-competition-points-card .value, #referral-count-card .value { 
                font-size: 20px;
            }
            .reward-modal-content, .leaderboard-modal-content, .referral-modal-content {
                padding: 20px;
            }
            .reward-modal-content h3, .leaderboard-modal-content h3, .referral-modal-content h3 {
                font-size: 20px;
            }
            .leaderboard-list li {
                font-size: 14px;
            }
            .leaderboard-list li .user-info-entry .userid-mini {
                font-size: 0.6em; /* Even smaller on mobile */
            }
            .referral-link-container {
                font-size: 12px;
            }
        }
        
        /* Language Selector Styles */
        .language-selector {
            position: absolute;
            top: 15px; 
            right: 15px; 
            display: flex;
            gap: 5px;
            z-index: 999; 
            background-color: rgba(0, 0, 0, 0.3); 
            border-radius: 10px; 
            padding: 5px; 
            backdrop-filter: blur(5px); 
        }
        .language-selector button {
            width: auto;
            padding: 5px 10px;
            font-size: 13px;
            background-color: rgba(255, 255, 255, 0.1); 
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px; 
            cursor: pointer;
            min-width: 30px;
            transition: all 0.2s ease; 
        }
        .language-selector button.active {
            background: linear-gradient(45deg, var(--primary), var(--secondary)); 
            border-color: var(--primary); 
        }
        .language-selector button:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.2); 
        }

        /* Withdrawal Section Styles */
        .withdraw-section {
            margin-top: 20px;
            display: none; /* Hidden by default, shown by JS */
            padding: 25px; 
            background-color: rgba(255, 255, 255, 0.05); 
            border-radius: 15px; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
        }
        .withdraw-section h3 {
            color: var(--secondary); 
            margin-bottom: 5px; 
            font-size: 20px;
            font-weight: 600;
        }
        .withdraw-section .warning-message { 
            font-size: 13px;
            color: #FFC107; 
            margin-bottom: 15px;
            line-height: 1.4;
            white-space: pre-wrap; 
        }
        .withdraw-section input, 
        .withdraw-section select { 
            width: 100%;
            padding: 12px;
            margin: 10px 0; 
            border-radius: 10px; 
            border: 1px solid var(--primary); 
            background-color: var(--dark); 
            color: var(--light);
            font-size: 14px;
        }
        .withdraw-section input::placeholder {
            color: #aaa;
        }
        .withdraw-section input:focus, 
        .withdraw-section select:focus {
            border-color: var(--gold); 
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
        }
        .withdraw-section button {
            background: linear-gradient(90deg, var(--primary), var(--secondary)); 
            width: 100%;
            padding: 14px; 
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px; 
            border-radius: 15px; 
            cursor: pointer;
            color: white; 
            border: none; 
            box-shadow: 0 8px 0 var(--primary-dark), 0 15px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }
        .withdraw-section button:hover {
            transform: translateY(4px);
            box-shadow: 0 4px 0 var(--primary-dark), 0 8px 10px rgba(0, 0, 0, 0.3);
            background: linear-gradient(90deg, var(--secondary), var(--primary)); 
        }
        .withdraw-section button:active {
            transform: translateY(8px);
            box-shadow: 0 0 0 var(--primary-dark), 0 2px 5px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="app-status-messages" id="app-status-messages">
        <!-- Dynamic status messages here -->
    </div>
    <div class="ad-notification" id="ad-notification"></div>
    
    <div class="container">
        <!-- Language Selector -->
        <div class="language-selector">
            <button data-lang="ar" onclick="setLanguage('ar')">AR</button>
            <button data-lang="en" onclick="setLanguage('en')">EN</button>
            <button data-lang="ru" onclick="setLanguage('ru')">RU</button>
        </div>

        <div class="header">
            <h1 data-key="app_title">ØªØ·Ø¨ÙŠÙ‚ Ø¨ÙŠØ¨Ù‰ XO ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù…ÙŠÙ†ÙŠ Ù…Ø¹ Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† ÙˆØ§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</h1>
        </div>
        
        <div class="content">
            <div class="user-info">
                <p data-key="earn_per_game_message">Ø§Ù„Ø¹Ø¨ XO Ù„Ù„ÙÙˆØ² Ø¨Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©!</p>
                <p data-key="min_withdrawal_message_static_general">Ø§Ù„Ø³Ø­Ø¨ Ø¹Ù† Ø·Ø±ÙŠÙ‚ FaucetPay Ù…Ù† 10 Ø¹Ù…Ù„Ø§Øª ÙÙ‚Ø· âœ…<br>Ø§Ù„Ø³Ø­Ø¨ Ø¥Ù„Ù‰ Ø£ÙŠ Ù…Ø­ÙØ¸Ø© Ø£Ø®Ø±Ù‰ Ù…Ù† 100 Ø¹Ù…Ù„Ø© ÙÙ‚Ø· âœ…</p>
                <p id="user-id-display" style="font-size: 12px; color: #888; margin-top: 10px;"></p>
            </div>

            <!-- Ad Spot 1 -->
            <div class="ad-container-flex">
                <ins style="width: 320px;height:50px" data-width="320" data-height="50" class="y8b3d62f820" data-domain="//data963.click" data-affquery="/1e63be6dc186de298305/8b3d62f820/?placementName=default"><script src="//data963.click/js/responsive.js" async></script></ins>
            </div>
            
            <div class="stats">
                <div class="stat-card" id="earned-points-card"> <!-- Specific ID for styling -->
                    <h3 data-key="earned_points_label">Ø¹Ù…Ù„Ø§Øª Pepe Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø©</h3>
                    <div class="value">
                        <span id="earned-points">0.00</span>
                        <img src="https://l.top4top.io/p_3464x9zix0.png" alt="Pepe Logo" class="pepe-logo">
                    </div>
                </div>
                <!-- New card for Daily Competition Points -->
                <div class="stat-card" id="daily-competition-points-card">
                    <h3 data-key="daily_competition_points_label">Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
                    <div class="value" id="daily-competition-points">0</div>
                </div>
                 <!-- New card for Referral Count -->
                 <div class="stat-card" id="referral-count-card">
                    <h3 data-key="referral_count_label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</h3>
                    <div class="value" id="referral-count">0</div>
                </div>
            </div>
            
            <div class="progress-container">
                <div class="progress-label">
                    <span data-key="progress_to_bonus">Ø§Ù„ØªÙ‚Ø¯Ù… Ù„Ù„Ù…ÙƒØ§ÙØ£Ø©</span>
                    <span id="game-progress">0%</span> <!-- Changed ID to game-progress -->
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
            
            <div class="game-section">
                <h3 data-key="game_title">Ø§Ù„Ø¹Ø¨ XO Ù„Ù„ÙÙˆØ² Ø¨Ù…ÙƒØ§ÙØ£Ø©!</h3>
                <div id="game-board" class="game-board">
                    <div class="cell" data-cell-index="0"></div>
                    <div class="cell" data-cell-index="1"></div>
                    <div class="cell" data-cell-index="2"></div>
                    <div class="cell" data-cell-index="3"></div>
                    <div class="cell" data-cell-index="4"></div>
                    <div class="cell" data-cell-index="5"></div>
                    <div class="cell" data-cell-index="6"></div>
                    <div class="cell" data-cell-index="7"></div>
                    <div class="cell" data-cell-index="8"></div>
                </div>
                <div id="game-status" data-key="game_status_x_turn">Ø¯ÙˆØ± Ø§Ù„Ù„Ø§Ø¹Ø¨: X</div>
                <div class="game-buttons" style="display: flex; flex-direction: column; gap: 15px; width: 100%; align-items: center;">
                    <button class="btn-3d" id="restart-game-btn" data-key="restart_game_button">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨</button>
                    <!-- claim-reward-btn will now trigger the modal -->
                    <button class="btn-3d btn-secondary" id="claim-reward-btn" style="display:none;" data-key="claim_reward_button_text">Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø¨Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©</button>
                </div>
            </div>

            <!-- Ad Spot 2 -->
            <div class="ad-container-flex">
                <iframe data-aa='2400444' src='//ad.a-ads.com/2400444?size=320x50' style='width:320px; height:50px; border:0px; padding:0; overflow:hidden; background-color: transparent;'></iframe>
            </div>
            
            <!-- Ø²Ø± Ø§Ù„Ø³Ø­Ø¨ ÙÙŠ Ù‚Ø³Ù… Ø®Ø§Øµ Ø¨Ù‡ Ù„ÙŠØ¸Ù„ Ù…Ø±Ø¦ÙŠØ§Ù‹ -->
            <div class="main-action-buttons">
                <button class="btn-3d btn-blue" id="show-withdraw-btn" onclick="showWithdrawForm()" data-key="withdraw_points_btn">Ø³Ø­Ø¨ Ø¹Ù…Ù„Ø§Øª Pepe</button>
                <button class="btn-3d btn-gold" id="view-leaderboard-btn" onclick="showLeaderboard()" data-key="view_leaderboard_btn">Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</button>
                <button class="btn-3d btn-secondary" id="invite-friends-btn" onclick="showReferralModal()" data-key="invite_friends_btn">Ø¯Ø¹ÙˆØ© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</button>
                 <!-- Ø²Ø± Ø§Ø®ØªØ¨Ø§Ø± Firebase Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
                <button class="btn-3d btn-secondary" id="test-firebase-btn" onclick="testFirebaseConnection()" data-key="test_firebase_button">Ø§Ø®ØªØ¨Ø§Ø± Firebase</button>
            </div>

            <div class="website-section">
                <h3 data-key="visit_channel_title">Ù‚Ù… Ø¨Ø²ÙŠØ§Ø±Ø© Ù‚Ù†Ø§ØªÙ†Ø§ Ø¹Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</h3>
                <button class="btn-3d btn-blue" onclick="window.open('https://t.me/dogsarn', '_blank')" data-key="visit_channel_button">Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù‚Ù†Ø§Ø©</button>
            </div>
        </div>
        
        <div class="footer">
            <p data-key="footer_text">Ù…Ø¤Ù…Ù† Ø¨ÙˆØ§Ø³Ø·Ø© Firebase â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ø­Ù…ÙŠØ©</p>
            <div class="firebase-logo">Firebase</div>
        </div>

        <!-- Withdraw Section (hidden by default) -->
        <div class="withdraw-section" id="withdraw-section">
            <h3 data-key="withdrawal_request_title">Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨</h3>
            <p class="warning-message" data-key="withdrawal_warning">ØªÙ†Ø¨ÙŠÙ‡ ğŸ™‹ğŸ»â€â™‚ï¸
Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ Ø¹Ù† Ø·Ø±ÙŠÙ‚ FaucetPay Ù‡Ùˆ 10 Ø¹Ù…Ù„Ø§Øª pepe.
Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ Ø¥Ù„Ù‰ Ø£ÙŠ Ù…Ø­ÙØ¸Ø© Ø£Ø®Ø±Ù‰ Ù‡Ùˆ 100 Ø¹Ù…Ù„Ø© pepe.
ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸Ø© ØµØ­ÙŠØ­ Ù„ØªÙ„Ù‚ÙŠ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ (â—â€¢á´—â€¢â—)</p>
            <input type="number" id="withdraw-amount" data-key-placeholder="enter_points_placeholder" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ø³Ø­Ø¨ Ø¹Ù…Ù„Ø§Øª Pepe" />
            <select id="payment-method"> 
                <option value="faucetpay" data-key="faucetpay_option">FaucetPay</option>
                <option value="other_wallet" data-key="other_wallet_option">Ø§Ù„Ø³Ø­Ø¨ Ø¥Ù„Ù‰ Ø£ÙŠ Ù…Ø­ÙØ¸Ø© Ø£Ø®Ø±Ù‰</option>
            </select>
            <input type="text" id="wallet-address" data-key-placeholder="wallet_address_placeholder" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©" /> 
            <button onclick="withdrawPoints()" data-key="withdraw_button">Ø³Ø­Ø¨</button>
            <p id="withdraw-status"></p>
        </div>
    </div>

    <!-- Reward Choice Modal -->
    <div class="reward-modal-overlay" id="reward-modal-overlay">
        <div class="reward-modal-content">
            <h3 data-key="choose_reward_title">Ø§Ø®ØªØ± Ù…ÙƒØ§ÙØ£ØªÙƒ!</h3>
            <div class="reward-modal-buttons">
                <button class="btn-3d btn-blue" id="watch-ad-for-points-btn" data-key="watch_ad_for_points">Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ù‹Ø§ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ 5 Ù†Ù‚Ø§Ø·</button>
                <button class="btn-3d btn-secondary" id="claim-one-point-btn" data-key="claim_one_point">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù†Ù‚Ø·Ø© ÙˆØ§Ø­Ø¯Ø© (Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ù„Ø§Ù†)</button>
            </div>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div class="leaderboard-modal-overlay" id="leaderboard-modal-overlay">
        <div class="leaderboard-modal-content">
            <button class="leaderboard-close-btn" onclick="hideLeaderboard()">âœ–</button>
            <h3 data-key="leaderboard_title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
            <ul id="leaderboard-list" class="leaderboard-list">
                <!-- Leaderboard items will be inserted here by JavaScript -->
                <li data-key="leaderboard_loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†...</li>
            </ul>
            <p id="my-rank-display" class="user-rank-display"></p>
        </div>
    </div>

    <!-- Referral Modal -->
    <div class="referral-modal-overlay" id="referral-modal-overlay">
        <div class="referral-modal-content">
            <button class="referral-close-btn" onclick="hideReferralModal()">âœ–</button>
            <h3 data-key="referral_modal_title">Ø¯Ø¹ÙˆØ© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h3>
            <p data-key="referral_count_display">Ø¹Ø¯Ø¯ Ø¥Ø­Ø§Ù„Ø§ØªÙƒ: <span id="my-referral-count">0</span></p>
            <p data-key="your_referral_link_label">Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:</p>
            <div class="referral-link-container" id="referral-link-container">
                <span id="referral-link-display"></span>
            </div>
            <div class="referral-buttons">
                <button class="btn-3d btn-blue" id="copy-referral-link-btn" data-key="copy_link_button">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
                <button class="btn-3d btn-secondary" id="share-referral-link-btn" data-key="share_link_button">Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø±Ø§Ø¨Ø· (ØªÙ„ÙŠØ¬Ø±Ø§Ù…)</button>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const POINTS_PER_XO_WIN_NO_AD = 1; 
        const POINTS_PER_XO_WIN_WITH_AD = 5; 
        const ADS_FOR_BONUS = 10; 
        const DAILY_GAME_LIMIT = 100; 
        const ADMIN_USER_ID = "-1002705355317"; // Ù…Ø¹Ø±Ù Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø´Ø±Ù Ø£Ùˆ Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„ØªÙŠ ØªØ³ØªÙ‚Ø¨Ù„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨
        const BOT_TOKEN = "7509054222:AAFhFhVXFCOs4kXtHQBigGU2QeNamHX42LQ"; // ØªÙˆÙƒÙ† Ø¨ÙˆØª Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ

        // Define specific minimum withdrawal points for each method
        const MIN_WITHDRAW_POINTS = 100; 
        const MIN_WITHDRAW_POINTS_FAUCETPAY = 10; 
        
        // State variables
        let totalGamesWon = 0; 
        let earnedPoints = 0.00; 
        let dailyGamePlays = 0; 
        let dailyCompetitionPoints = 0; 
        let referralCount = 0; 
        let lastActivityDate = ""; 

        // Telegram Bot Username and Mini App URL
        const telegramBotUsername = "ididkd46_bot"; 
        const telegramMiniAppUrl = "https://t.me/ididkd46_bot/xooo"; 

        // DOM Elements
        const earnedPointsEl = document.getElementById('earned-points'); 
        const dailyCompetitionPointsEl = document.getElementById('daily-competition-points'); 
        const referralCountEl = document.getElementById('referral-count'); 
        const gameProgressEl = document.getElementById('game-progress'); 
        const progressFillEl = document.getElementById('progress-fill');
        const adNotificationEl = document.getElementById('ad-notification');
        const withdrawSectionEl = document.getElementById('withdraw-section');
        const withdrawStatusEl = document.getElementById('withdraw-status');
        const showWithdrawBtn = document.getElementById('show-withdraw-btn');
        const userIdDisplayEl = document.getElementById('user-id-display');
        // appStatusMessagesEl is already defined globally in the module script

        // Reward Choice Modal Elements
        const rewardModalOverlay = document.getElementById('reward-modal-overlay');
        const watchAdForPointsBtn = document.getElementById('watch-ad-for-points-btn');
        const claimOnePointBtn = document.getElementById('claim-one-point-btn');

        // Leaderboard Modal Elements
        const leaderboardModalOverlay = document.getElementById('leaderboard-modal-overlay');
        const leaderboardListEl = document.getElementById('leaderboard-list');
        const viewLeaderboardBtn = document.getElementById('view-leaderboard-btn');
        const myRankDisplayEl = document.getElementById('my-rank-display');

        // Referral Modal Elements
        const referralModalOverlay = document.getElementById('referral-modal-overlay');
        const referralLinkDisplayEl = document.getElementById('referral-link-display');
        const copyReferralLinkBtn = document.getElementById('copy-referral-link-btn');
        const shareReferralLinkBtn = document.getElementById('share-referral-link-btn');
        const inviteFriendsBtn = document.getElementById('invite-friends-btn');

        // Constants for the XO Game
        const PLAYER_X = 'X';
        const PLAYER_O = 'O'; 
        const WINNING_COMBINATIONS = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], 
            [0, 3, 6], [1, 4, 7], [2, 5, 8], 
            [0, 4, 8], [2, 4, 6]             
        ];

        // DOM Elements for XO Game
        const gameCells = document.querySelectorAll('.cell');
        const gameStatusDisplay = document.getElementById('game-status');
        const restartGameBtn = document.getElementById('restart-game-btn');
        const claimRewardBtn = document.getElementById('claim-reward-btn'); 

        // Game state variables for XO Game
        let board = ['', '', '', '', '', '', '', '', ''];
        let currentPlayer = PLAYER_X;
        let gameActive = true; 

        // --- Translation Logic ---
        const translations = {
            ar: {
                app_title: "ØªØ·Ø¨ÙŠÙ‚ Ø¨ÙŠØ¨Ù‰ XO ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù…ÙŠÙ†ÙŠ Ù…Ø¹ Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† ÙˆØ§Ù„Ø¥Ø­Ø§Ù„Ø§Øª",
                earn_per_game_message: "Ø§Ù„Ø¹Ø¨ XO Ù„Ù„ÙÙˆØ² Ø¨Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©!",
                min_withdrawal_message_static_general: `Ø§Ù„Ø³Ø­Ø¨ Ø¹Ù† Ø·Ø±ÙŠÙ‚ FaucetPay Ù…Ù† ${MIN_WITHDRAW_POINTS_FAUCETPAY} Ø¹Ù…Ù„Ø§Øª ÙÙ‚Ø· âœ…\nØ§Ù„Ø³Ø­Ø¨ Ø¥Ù„Ù‰ Ø£ÙŠ Ù…Ø­ÙØ¸Ø© Ø£Ø®Ø±Ù‰ Ù…Ù† ${MIN_WITHDRAW_POINTS} Ø¹Ù…Ù„Ø© ÙÙ‚Ø· âœ…`, 
                earned_points_label: "Ø¹Ù…Ù„Ø§Øª Pepe Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø©", 
                daily_competition_points_label: "Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©", 
                referral_count_label: "Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª", 
                progress_to_bonus: "Ø§Ù„ØªÙ‚Ø¯Ù… Ù„Ù„Ù…ÙƒØ§ÙØ£Ø©",
                game_title: "Ø§Ù„Ø¹Ø¨ XO Ù„Ù„ÙÙˆØ² Ø¨Ù…ÙƒØ§ÙØ£Ø©!",
                game_status_x_turn: "Ø¯ÙˆØ± Ø§Ù„Ù„Ø§Ø¹Ø¨: X",
                game_status_o_turn: "Ø¯ÙˆØ± Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±: O",
                game_status_x_wins: "Ø§Ù„Ù„Ø§Ø¹Ø¨ X ÙØ§Ø²!",
                game_status_o_wins: "Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± O ÙØ§Ø²!",
                game_status_draw: "ØªØ¹Ø§Ø¯Ù„!",
                restart_game_button: "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨",
                claim_reward_button_text: "Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø¨Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©", 
                withdraw_points_btn: "Ø³Ø­Ø¨ Ø¹Ù…Ù„Ø§Øª Pepe", 
                view_leaderboard_btn: "Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†", 
                invite_friends_btn: "Ø¯Ø¹ÙˆØ© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡", 
                visit_channel_title: "Ù‚Ù… Ø¨Ø²ÙŠØ§Ø±Ø© Ù‚Ù†Ø§ØªÙ†Ø§ Ø¹Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…", 
                visit_channel_button: "Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù‚Ù†Ø§Ø©", 
                footer_text: "Ù…Ø¤Ù…Ù† Ø¨ÙˆØ§Ø³Ø·Ø© Firebase â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ø­Ù…ÙŠØ©",
                withdrawal_request_title: "Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨",
                withdrawal_warning: `ØªÙ†Ø¨ÙŠÙ‡ ğŸ™‹ğŸ»â€â™‚ï¸\nØ§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ Ø¹Ù† Ø·Ø±ÙŠÙ‚ FaucetPay Ù‡Ùˆ ${MIN_WITHDRAW_POINTS_FAUCETPAY} Ø¹Ù…Ù„Ø§Øª pepe.\nØ§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ Ø¥Ù„Ù‰ Ø£ÙŠ Ù…Ø­ÙØ¸Ø© Ø£Ø®Ø±Ù‰ Ù‡Ùˆ ${MIN_WITHDRAW_POINTS} Ø¹Ù…Ù„Ø© pepe.\nÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸Ø© ØµØ­ÙŠØ­ Ù„ØªÙ„Ù‚ÙŠ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ (â—â€¢á´—â€¢â—)`, 
                enter_points_placeholder: "Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ø³Ø­Ø¨ Ø¹Ù…Ù„Ø§Øª Pepe", 
                faucetpay_option: "FaucetPay",
                other_wallet_option: "Ø§Ù„Ø³Ø­Ø¨ Ø¥Ù„Ù‰ Ø£ÙŠ Ù…Ø­ÙØ¸Ø© Ø£Ø®Ø±Ù‰",
                wallet_address_placeholder: "Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©",
                withdraw_button: "Ø³Ø­Ø¨",
                daily_game_limit_reached: `Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (${DAILY_GAME_LIMIT}). ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ØºØ¯Ù‹Ø§.`, 
                min_withdraw_message: `Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø³Ø­Ø¨ Ø¹Ù† Ø·Ø±ÙŠÙ‚ {methodName} Ù‡Ùˆ {minAmount} Ø¹Ù…Ù„Ø© pepe.`, 
                insufficient_balance: `Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ. Ù„Ø¯ÙŠÙƒ {earnedPoints} Ø¹Ù…Ù„Ø© pepe.`, 
                enter_wallet_address: "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©.",
                withdrawal_success_message: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­!',
                telegram_send_fail: `ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨: {error}`,
                telegram_connect_error: `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø¯Ù…Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…: {error}`,
                unknown_method: "Ø·Ø±ÙŠÙ‚Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©:",
                
                // Reward choice modal
                choose_reward_title: "Ø§Ø®ØªØ± Ù…ÙƒØ§ÙØ£ØªÙƒ!",
                watch_ad_for_points: `Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ù‹Ø§ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ ${POINTS_PER_XO_WIN_WITH_AD} Ù†Ù‚Ø§Ø·`,
                claim_one_point: `Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ${POINTS_PER_XO_WIN_NO_AD} Ù†Ù‚Ø·Ø© (Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ù„Ø§Ù†)`,
                ad_loading: "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±",
                ad_completed_success: `Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†! ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${POINTS_PER_XO_WIN_WITH_AD} Ù†Ù‚Ø§Ø· Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ.`,
                ad_failed: "ÙØ´Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
                competition_point_earned_notification: `Ù„Ù‚Ø¯ Ø±Ø¨Ø­Øª ${POINTS_PER_XO_WIN_NO_AD} Ù†Ù‚Ø·Ø© Ù…Ø³Ø§Ø¨Ù‚Ø©!`, 

                // Leaderboard
                leaderboard_title: "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠØ©",
                leaderboard_loading: "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†...",
                leaderboard_no_data: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† Ø§Ù„ÙŠÙˆÙ….",
                leaderboard_loading_error: "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†.",
                your_id_prefix: "Ù…Ø¹Ø±ÙÙƒ: ",
                my_rank_display: "ØªØ±ØªÙŠØ¨Ùƒ: #{rank} (Ù†Ù‚Ø§Ø·: {points})", 
                my_rank_not_found: "Ø£Ù†Øª Ù„Ø³Øª ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„ÙŠÙˆÙ….", 

                // Referral
                referral_modal_title: "Ø¯Ø¹ÙˆØ© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡", 
                referral_count_display: "Ø¹Ø¯Ø¯ Ø¥Ø­Ø§Ù„Ø§ØªÙƒ: ", 
                your_referral_link_label: "Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:", 
                copy_link_button: "Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·", 
                share_link_button: "Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø±Ø§Ø¨Ø· (ØªÙ„ÙŠØ¬Ø±Ø§Ù…)", 
                link_copied_success: "ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!", 
                link_share_failed: "ÙØ´Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§.", 
                invite_friends_message_share: "Ø§Ù„Ø¹Ø¨ XO ÙˆØ§Ø±Ø¨Ø­ Ù†Ù‚Ø§Ø·Ù‹Ø§! Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…:"
            },
            en: {
                app_title: "Pepe XO Telegram Mini App with Leaderboard & Referrals", 
                earn_per_game_message: "Play XO to earn competition points!",
                min_withdrawal_message_static_general: `Withdrawal via FaucetPay from ${MIN_WITHDRAW_POINTS_FAUCETPAY} pepe coins only âœ…\nWithdrawal to Any Other Wallet from ${MIN_WITHDRAW_POINTS} pepe coins only âœ…`, 
                earned_points_label: "Earned Pepe Coins", 
                daily_competition_points_label: "Daily Competition Points", 
                referral_count_label: "Referral Count",
                progress_to_bonus: "Progress to Bonus",
                game_title: "Play XO to Win a Reward!",
                game_status_x_turn: "Player's Turn: X",
                game_status_o_turn: "Computer's Turn: O",
                game_status_x_wins: "Player X Wins!",
                game_status_o_wins: "Computer O Wins!",
                game_status_draw: "It's a Draw!",
                restart_game_button: "Restart Game",
                claim_reward_button_text: "Claim Reward",
                withdraw_points_btn: "Withdraw Pepe Coins",
                view_leaderboard_btn: "View Leaderboard",
                invite_friends_btn: "Invite Friends",
                visit_channel_title: "Visit Our Telegram Channel", 
                visit_channel_button: "Visit Channel", 
                footer_text: "Secured by Firebase â€¢ All transactions are protected",
                withdrawal_request_title: "Withdrawal Request",
                withdrawal_warning: `Warning ğŸ™‹ğŸ»â€â™‚ï¸\nMinimum withdrawal for FaucetPay is ${MIN_WITHDRAW_POINTS_FAUCETPAY} pepe coins.\nMinimum withdrawal for Any Other Wallet is ${MIN_WITHDRAW_POINTS} pepe coins.\nPlease ensure you enter a correct wallet address for smooth withdrawals (â—â€¢á´—â€¢â—)`, 
                enter_points_placeholder: "Enter Amount to Withdraw Pepe Coins", 
                faucetpay_option: "FaucetPay",
                other_wallet_option: "Withdraw to Any Other Wallet",
                wallet_address_placeholder: "Enter Wallet Address",
                withdraw_button: "Withdraw",
                daily_game_limit_reached: `You have reached the daily game limit (${DAILY_GAME_LIMIT}). Please try again tomorrow.`,
                min_withdraw_message: `Minimum withdrawal for {methodName} is {minAmount} pepe coins.`, 
                insufficient_balance: `Insufficient balance. You have {earnedPoints} Pepe Coins.`, 
                enter_wallet_address: "Please enter the wallet address.",
                withdrawal_success_message: 'Withdrawal request sent successfully!',
                telegram_send_fail: `Failed to send request: {error}`,
                telegram_connect_error: `Error connecting to Telegram service: {error}`,
                unknown_method: "Unknown method:",

                // Reward choice modal
                choose_reward_title: "Choose Your Reward!",
                watch_ad_for_points: `Watch Ad & Get ${POINTS_PER_XO_WIN_WITH_AD} Points`,
                claim_one_point: `Get ${POINTS_PER_XO_WIN_NO_AD} Point (No Ad)`,
                ad_loading: "Loading ad... Please wait",
                ad_completed_success: `Ad completed! ${POINTS_PER_XO_WIN_WITH_AD} points added to your account.`,
                ad_failed: "Failed to show ad. Please try again.",
                competition_point_earned_notification: `You earned ${POINTS_PER_XO_WIN_NO_AD} competition point!`,

                // Leaderboard
                leaderboard_title: "Daily Leaderboard",
                leaderboard_loading: "Loading leaderboard...",
                leaderboard_no_data: "No leaderboard data for today.",
                leaderboard_loading_error: "Error loading leaderboard.",
                your_id_prefix: "Your ID: ",
                my_rank_display: "Your Rank: #{rank} (Points: {points})",
                my_rank_not_found: "You are not on the leaderboard yet today.",

                // Referral
                referral_modal_title: "Invite Friends",
                referral_count_display: "Your Referrals: ",
                your_referral_link_label: "Your Referral Link:",
                copy_link_button: "Copy Link",
                share_link_button: "Share Link (Telegram)",
                link_copied_success: "Link copied!",
                link_share_failed: "Share failed. Please copy manually.",
                invite_friends_message_share: "Play XO and earn points! Use this link to join:"
            },
            ru: {
                app_title: "Pepe XO Telegram Mini App Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†ĞµĞ¹ Ğ»Ğ¸Ğ´ĞµÑ€Ğ¾Ğ² Ğ¸ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ°Ğ¼Ğ¸", 
                earn_per_game_message: "Ğ˜Ğ³Ñ€Ğ°Ğ¹Ñ‚Ğµ Ğ² XO, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ·Ğ°Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ¾Ñ‡ĞºĞ¸ ÑĞ¾Ñ€ĞµĞ²Ğ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ!",
                min_withdrawal_message_static_general: `Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ñ‡ĞµÑ€ĞµĞ· FaucetPay Ğ¾Ñ‚ ${MIN_WITHDRAW_POINTS_FAUCETPAY} Ğ¼Ğ¾Ğ½ĞµÑ‚ pepe Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ âœ…\nĞ’Ñ‹Ğ²Ğ¾Ğ´ Ğ½Ğ° Ğ»ÑĞ±Ğ¾Ğ¹ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ ĞºĞ¾ÑˆĞµĞ»ĞµĞº Ğ¾Ñ‚ ${MIN_WITHDRAW_POINTS} Ğ¼Ğ¾Ğ½ĞµÑ‚ pepe Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ âœ…`, 
                earned_points_label: "Ğ—Ğ°Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ½ĞµÑ‚Ñ‹ Pepe", 
                daily_competition_points_label: "Ğ•Ğ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ñ‹Ğµ Ğ¾Ñ‡ĞºĞ¸ ÑĞ¾Ñ€ĞµĞ²Ğ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ", 
                referral_count_label: "ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ğ¾Ğ²",
                progress_to_bonus: "ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ Ğº Ğ±Ğ¾Ğ½ÑƒÑÑƒ",
                game_title: "Ğ˜Ğ³Ñ€Ğ°Ğ¹Ñ‚Ğµ Ğ² XO, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ²Ñ‹Ğ¸Ğ³Ñ€Ğ°Ñ‚ÑŒ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ñƒ!",
                game_status_x_turn: "Ğ¥Ğ¾Ğ´ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°: X",
                game_status_o_turn: "Ğ¥Ğ¾Ğ´ ĞºĞ¾Ğ¼Ğ¿ÑŒÑÑ‚ĞµÑ€Ğ°: O",
                game_status_x_wins: "Ğ˜Ğ³Ñ€Ğ¾Ğº X Ğ¿Ğ¾Ğ±ĞµĞ´Ğ¸Ğ»!",
                game_status_o_wins: "ĞšĞ¾Ğ¼Ğ¿ÑŒÑÑ‚ĞµÑ€ O Ğ¿Ğ¾Ğ±ĞµĞ´Ğ¸Ğ»!",
                game_status_draw: "ĞĞ¸Ñ‡ÑŒÑ!",
                restart_game_button: "ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾",
                claim_reward_button_text: "ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ñƒ",
                withdraw_points_btn: "Ğ’Ñ‹Ğ²ĞµÑÑ‚Ğ¸ Ğ¼Ğ¾Ğ½ĞµÑ‚Ñ‹ Pepe",
                view_leaderboard_btn: "ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ Ğ»Ğ¸Ğ´ĞµÑ€Ğ¾Ğ²",
                invite_friends_btn: "ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ÑŒ Ğ´Ñ€ÑƒĞ·ĞµĞ¹",
                visit_channel_title: "ĞŸĞ¾ÑĞµÑ‚Ğ¸Ñ‚Ğµ Ğ½Ğ°Ñˆ Telegram-ĞºĞ°Ğ½Ğ°Ğ»", 
                visit_channel_button: "ĞŸĞ¾ÑĞµÑ‚Ğ¸Ñ‚ÑŒ ĞºĞ°Ğ½Ğ°Ğ»", 
                footer_text: "Ğ—Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ğ¾ Firebase â€¢ Ğ’ÑĞµ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ Ğ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ñ‹",
                withdrawal_request_title: "Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° Ğ²Ñ‹Ğ²Ğ¾Ğ´",
                withdrawal_warning: `Ğ’Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ ğŸ™‹ğŸ»â€â™‚ï¸\nĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ğ´Ğ»Ñ FaucetPay ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ ${MIN_WITHDRAW_POINTS_FAUCETPAY} Ğ¼Ğ¾Ğ½ĞµÑ‚ pepe.\nĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ğ´Ğ»Ñ Ğ»ÑĞ±Ğ¾Ğ³Ğ¾ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ³Ğ¾ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ° ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ ${MIN_WITHDRAW_POINTS} Ğ¼Ğ¾Ğ½ĞµÑ‚ pepe.\nĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, ÑƒĞ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ Ğ²Ñ‹ Ğ²Ğ²ĞµĞ»Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ°Ğ´Ñ€ĞµÑ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ° Ğ´Ğ»Ñ Ğ±ĞµÑĞ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° ÑÑ€ĞµĞ´ÑÑ‚Ğ² (â—â€¢á´—â€¢â—)`, 
                enter_points_placeholder: "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑÑƒĞ¼Ğ¼Ñƒ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ğ¼Ğ¾Ğ½ĞµÑ‚ Pepe", 
                faucetpay_option: "FaucetPay",
                other_wallet_option: "Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ½Ğ° Ğ»ÑĞ±Ğ¾Ğ¹ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ ĞºĞ¾ÑˆĞµĞ»ĞµĞº",
                wallet_address_placeholder: "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ°Ğ´Ñ€ĞµÑ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ°",
                withdraw_button: "Ğ’Ñ‹Ğ²ĞµÑÑ‚Ğ¸",
                daily_game_limit_reached: `Ğ’Ñ‹ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ³Ğ»Ğ¸ Ğ´Ğ½ĞµĞ²Ğ½Ğ¾Ğ³Ğ¾ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ° Ğ¸Ğ³Ñ€ (${DAILY_GAME_LIMIT}). ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°.`,
                min_withdraw_message: `ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ğ´Ğ»Ñ {methodName} ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ {minAmount} Ğ¼Ğ¾Ğ½ĞµÑ‚ pepe.`, 
                insufficient_balance: `ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ. Ğ£ Ğ²Ğ°Ñ {earnedPoints} Ğ¼Ğ¾Ğ½ĞµÑ‚ pepe.`, 
                enter_wallet_address: "ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ°Ğ´Ñ€ĞµÑ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ°.",
                withdrawal_success_message: 'Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° Ğ²Ñ‹Ğ²Ğ¾Ğ´ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½!',
                telegram_send_fail: `ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ: {error}`,
                telegram_connect_error: `ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº ÑĞ»ÑƒĞ¶Ğ±Ğµ Telegram: {error}`,
                unknown_method: "ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹ Ğ¼ĞµÑ‚Ğ¾Ğ´:",

                // Reward choice modal
                choose_reward_title: "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ²Ğ¾Ñ Ğ½Ğ°Ğ³Ñ€Ğ°Ğ´Ñƒ!",
                watch_ad_for_points: `ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ñƒ Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ${POINTS_PER_XO_WIN_WITH_AD} Ğ¾Ñ‡ĞºĞ¾Ğ²`,
                claim_one_point: `ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ${POINTS_PER_XO_WIN_NO_AD} Ğ¾Ñ‡ĞºĞ¾ (Ğ±ĞµĞ· Ñ€ĞµĞºĞ»Ğ°Ğ¼Ñ‹)`,
                ad_loading: "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ€ĞµĞºĞ»Ğ°Ğ¼Ñ‹... ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ",
                ad_completed_success: `Ğ ĞµĞºĞ»Ğ°Ğ¼Ğ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°! ${POINTS_PER_XO_WIN_WITH_AD} Ğ¾Ñ‡ĞºĞ¾Ğ² Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ½Ğ° Ğ²Ğ°Ñˆ ÑÑ‡ĞµÑ‚.`,
                ad_failed: "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ñƒ. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ğµ Ñ€Ğ°Ğ·.",
                competition_point_earned_notification: `Ğ’Ñ‹ Ğ·Ğ°Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»Ğ¸ ${POINTS_PER_XO_WIN_NO_AD} Ğ¾Ñ‡ĞºĞ¾ ÑĞ¾Ñ€ĞµĞ²Ğ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ!`,

                // Leaderboard
                leaderboard_title: "Ğ•Ğ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ»Ğ¸Ğ´ĞµÑ€Ğ¾Ğ²",
                leaderboard_loading: "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ Ğ»Ğ¸Ğ´ĞµÑ€Ğ¾Ğ²...",
                leaderboard_no_data: "ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ Ğ»Ğ¸Ğ´ĞµÑ€Ğ¾Ğ² Ğ·Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ.",
                leaderboard_loading_error: "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ Ğ»Ğ¸Ğ´ĞµÑ€Ğ¾Ğ².",
                your_id_prefix: "Ğ’Ğ°Ñˆ ID: ",
                my_rank_display: "Ğ’Ğ°Ñˆ Ñ€Ğ°Ğ½Ğ³: #{rank} (ĞÑ‡ĞºĞ¸: {points})",
                my_rank_not_found: "Ğ’Ğ°Ñ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ Ğ»Ğ¸Ğ´ĞµÑ€Ğ¾Ğ² ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ.",

                // Referral
                referral_modal_title: "ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑĞ¸Ñ‚ÑŒ Ğ´Ñ€ÑƒĞ·ĞµĞ¹",
                referral_count_display: "Ğ’Ğ°ÑˆĞ¸ Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»Ñ‹: ",
                your_referral_link_label: "Ğ’Ğ°ÑˆĞ° Ñ€ĞµÑ„ĞµÑ€Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑÑ‹Ğ»ĞºĞ°:",
                copy_link_button: "ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑÑ‹Ğ»ĞºÑƒ",
                share_link_button: "ĞŸĞ¾Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒÑÑ ÑÑÑ‹Ğ»ĞºĞ¾Ğ¹ (Telegram)",
                link_copied_success: "Ğ¡ÑÑ‹Ğ»ĞºĞ° ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°!",
                link_share_failed: "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ¼ĞµĞ½Ğµ. Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ.",
                invite_friends_message_share: "Play XO and earn points! Use this link to join:"
            }
        };

        let currentLanguage = localStorage.getItem('appLanguage') || 'ar'; // Default to Arabic

        // Function to get today's date inYYYY-MM-DD format
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Function to set the language
        window.setLanguage = function(lang) {
            currentLanguage = lang;
            localStorage.setItem('appLanguage', lang);
            document.documentElement.lang = lang; 

            document.querySelectorAll('.language-selector button').forEach(button => {
                if (button.dataset.lang === lang) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.dataset.key;
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'INPUT' && element.hasAttribute('data-key-placeholder')) {
                        element.placeholder = translations[lang][key];
                    } else if (key === 'referral_count_display') {
                        element.textContent = translations[lang][key]; 
                    } else {
                        element.textContent = translations[lang][key];
                    }
                }
            });

            if (myRankDisplayEl) {
                myRankDisplayEl.textContent = ''; 
            }
            if (referralCountEl) {
                document.getElementById('my-referral-count').textContent = referralCount.toFixed(0);
            }

            document.querySelectorAll('[data-key-placeholder]').forEach(element => {
                const placeholderKey = element.dataset.keyPlaceholder;
                if (translations[lang] && translations[lang][placeholderKey]) {
                    element.placeholder = translations[lang][placeholderKey];
                }
            });

            document.querySelectorAll('#payment-method option').forEach(option => {
                const key = option.dataset.key;
                if (translations[lang] && translations[lang][key]) {
                    option.textContent = translations[lang][key];
                }
            });

            updateUI(); 
            showAdNotification(''); 
            withdrawStatusEl.textContent = ''; 

            if (window.currentAppUserId) {
                userIdDisplayEl.textContent = translations[currentLanguage].your_id_prefix + window.currentAppUserId;
            } else {
                userIdDisplayEl.textContent = '';
            }

            if (gameActive) {
                gameStatusDisplay.textContent = currentPlayer === PLAYER_X ? translations[currentLanguage].game_status_x_turn : translations[currentLanguage].game_status_o_turn;
            } 
        };

        // Function for app status messages (important for debugging without console)
        const appStatusMessagesEl = document.getElementById('app-status-messages');
        let appStatusTimeout;
        // showAppStatus is now defined globally in the module script, so no need to redefine here
        // Re-assigning it to window.showAppStatus in the module script ensures all parts of the code can use it

        // Initialize the app
        function initApp() {
            if (localStorage.getItem('totalGamesWon')) { 
                totalGamesWon = parseInt(localStorage.getItem('totalGamesWon'));
                earnedPoints = parseFloat(localStorage.getItem('earnedPoints'));
            }
            
            const todayDate = getTodayDate();
            if (localStorage.getItem('lastActivityDate') === todayDate) { 
                dailyGamePlays = parseInt(localStorage.getItem('dailyGamePlays')) || 0; 
                dailyCompetitionPoints = parseFloat(localStorage.getItem('dailyCompetitionPoints')) || 0; 
                referralCount = parseInt(localStorage.getItem('referralCount')) || 0; 
            } else {
                dailyGamePlays = 0;
                dailyCompetitionPoints = 0; 
                localStorage.setItem('dailyGamePlays', dailyGamePlays);
                localStorage.setItem('dailyCompetitionPoints', dailyCompetitionPoints); 
            }
            localStorage.setItem('lastActivityDate', todayDate); 

            if (!window.currentAppUserId) {
                window.currentAppUserId = localStorage.getItem('localUserId') || 'USR-' + Math.floor(10000 + Math.random() * 90000);
                localStorage.setItem('localUserId', window.currentAppUserId);
            }
            
            setLanguage(currentLanguage); 
            updateUI();
            initGame(); 
            
            // Only attempt to get referral count if Firebase is ready
            if (window.db && window.currentAppUserId && window.auth.currentUser) { // Check for auth.currentUser too
                getAndDisplayReferralCount(); 
            } else {
                window.showAppStatus('ØªØ­Ø°ÙŠØ±: Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ù„Ø¹Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„.', 'info', 7000);
            }
        }
        
        // Update UI elements
        function updateUI() {
            earnedPointsEl.textContent = earnedPoints.toFixed(2); 
            dailyCompetitionPointsEl.textContent = dailyCompetitionPoints.toFixed(0); 
            document.getElementById('my-referral-count').textContent = referralCount.toFixed(0); 

            const progress = (totalGamesWon % ADS_FOR_BONUS) / ADS_FOR_BONUS * 100;
            gameProgressEl.textContent = `${Math.round(progress)}%`; 
            progressFillEl.style.width = `${progress}%`; 
            
            earnedPointsEl.classList.remove('pulse');
            void earnedPointsEl.offsetWidth; 
            earnedPointsEl.classList.add('pulse');
            
            dailyCompetitionPointsEl.classList.remove('pulse');
            void dailyCompetitionPointsEl.offsetWidth; 
            dailyCompetitionPointsEl.classList.add('pulse');

            document.getElementById('my-referral-count').classList.remove('pulse');
            void document.getElementById('my-referral-count').offsetWidth; 
            document.getElementById('my-referral-count').classList.add('pulse');

            if (window.currentAppUserId) {
                userIdDisplayEl.textContent = translations[currentLanguage].your_id_prefix + window.currentAppUserId;
            } else {
                userIdDisplayEl.textContent = '';
            }
        }

        // Initialize the XO game board and state
        function initGame() {
            board = ['', '', '', '', '', '', '', '', ''];
            currentPlayer = PLAYER_X;
            gameActive = true;
            gameStatusDisplay.textContent = translations[currentLanguage].game_status_x_turn;
            claimRewardBtn.style.display = 'none'; 

            gameCells.forEach(cell => {
                cell.textContent = '';
                cell.classList.remove(PLAYER_X.toLowerCase(), PLAYER_O.toLowerCase());
                cell.removeEventListener('click', handleCellClick); 
                cell.addEventListener('click', handleCellClick, { once: true }); 
            });
        }

        // Handle a cell click by the player
        function handleCellClick(event) {
            const clickedCell = event.target;
            const clickedCellIndex = parseInt(clickedCell.dataset.cellIndex);

            if (board[clickedCellIndex] !== '' || !gameActive) {
                return;
            }

            makeMove(clickedCell, clickedCellIndex, currentPlayer);

            if (checkWin()) {
                gameStatusDisplay.textContent = translations[currentLanguage].game_status_x_wins;
                gameActive = false;
                if (currentPlayer === PLAYER_X) { 
                    claimRewardBtn.style.display = 'block'; 
                    showRewardChoiceModal(); 
                }
                return;
            }

            if (checkDraw()) {
                gameStatusDisplay.textContent = translations[currentLanguage].game_status_draw;
                gameActive = false;
                return;
            }

            currentPlayer = PLAYER_O;
            gameStatusDisplay.textContent = translations[currentLanguage].game_status_o_turn;
            setTimeout(aiMove, 700); 
        }

        // Function to make a move (player or AI)
        function makeMove(cellElement, index, player) {
            board[index] = player;
            cellElement.textContent = player;
            cellElement.classList.add(player.toLowerCase());
            cellElement.removeEventListener('click', handleCellClick);
        }

        // AI's turn logic (simple random move)
        function aiMove() {
            if (!gameActive) {
                return;
            }

            let availableCells = [];
            for (let i = 0; i < board.length; i++) {
                if (board[i] === '') {
                    availableCells.push(i);
                }
            }

            if (availableCells.length > 0) {
                const randomIndex = Math.floor(Math.random() * availableCells.length);
                const move = availableCells[randomIndex];
                
                const cellElement = gameCells[move];
                makeMove(cellElement, move, currentPlayer);

                if (checkWin()) {
                    gameStatusDisplay.textContent = translations[currentLanguage].game_status_o_wins;
                    gameActive = false;
                    return;
                }

                if (checkDraw()) {
                    gameStatusDisplay.textContent = translations[currentLanguage].game_status_draw;
                    gameActive = false;
                    return;
                }
            } 
            
            currentPlayer = PLAYER_X;
            gameStatusDisplay.textContent = translations[currentLanguage].game_status_x_turn;
            gameCells.forEach((cell, index) => {
                if (board[index] === '') {
                    cell.removeEventListener('click', handleCellClick); 
                    cell.addEventListener('click', handleCellClick, { once: true });
                }
            });
        }

        // Check for a win condition
        function checkWin() {
            return WINNING_COMBINATIONS.some(combination => {
                return combination.every(index => {
                    return board[index] === currentPlayer;
                });
            });
        }

        // Check for a draw condition
        function checkDraw() {
            return board.every(cell => {
                return cell !== '';
            });
        }

        // Function to show the reward choice modal
        function showRewardChoiceModal() {
            rewardModalOverlay.classList.add('active');
        }

        // Function to hide the reward choice modal
        function hideRewardChoiceModal() {
            rewardModalOverlay.classList.remove('active');
        }

        // Function to update daily competition points in Firestore
        async function updateDailyCompetitionPointsInFirestore(pointsToAdd) {
            if (!window.db || !window.currentAppUserId || !window.auth.currentUser) {
                window.showAppStatus(translations[currentLanguage].leaderboard_loading_error + ' (Firebase DB Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ø¬Ø§Ù‡Ø²)', 'error');
                return;
            }

            const todayDate = getTodayDate();
            const userRef = window.doc(window.db, `artifacts/${window.APP_ID}/public/dailyCompetitionScores`, window.currentAppUserId);

            try {
                const docSnap = await window.getDoc(userRef);
                let currentPoints = 0;
                let lastDate = "";

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    lastDate = data.lastUpdateDate;
                    if (lastDate === todayDate) {
                        currentPoints = data.points;
                    } else {
                        currentPoints = 0;
                    }
                }
                
                const newPoints = currentPoints + pointsToAdd;

                await window.setDoc(userRef, {
                    userId: window.currentAppUserId,
                    username: window.currentTelegramUsername, 
                    points: newPoints,
                    lastUpdateDate: todayDate,
                }, { merge: true }); 

                dailyCompetitionPoints = newPoints; 
                localStorage.setItem('dailyCompetitionPoints', dailyCompetitionPoints);
                updateUI();
                window.showAppStatus(translations[currentLanguage].ad_completed_success, 'success'); 
            } catch (error) {
                window.showAppStatus(translations[currentLanguage].leaderboard_loading_error + `: ${error.message}`, 'error');
            }
        }

        // Option 1: Watch ad and get 5 points
        async function watchAdAndGetPoints() {
            hideRewardChoiceModal(); 

            if (dailyGamePlays >= DAILY_GAME_LIMIT) {
                window.showAdNotification(translations[currentLanguage].daily_game_limit_reached);
                initGame(); 
                return; 
            }

            window.showAdNotification(translations[currentLanguage].ad_loading);
            
            try {
                if (typeof window.Adsgram !== 'undefined' && typeof window.Adsgram.init === 'function') {
                    // Make sure Firebase is ready before attempting Adsgram and points update
                    if (!window.db || !window.currentAppUserId || !window.auth.currentUser) {
                        window.showAdNotification(translations[currentLanguage].ad_failed + ' (Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†)', 'error');
                        initGame();
                        return;
                    }

                    await window.Adsgram.init({ blockId: "12082" }).show(); 
                    
                    dailyGamePlays++; 
                    totalGamesWon++; 

                    localStorage.setItem('dailyGamePlays', dailyGamePlays);
                    localStorage.setItem('totalGamesWon', totalGamesWon);
                    
                    await updateDailyCompetitionPointsInFirestore(POINTS_PER_XO_WIN_WITH_AD); 
                    updateUI(); 
                    
                } else {
                    window.showAdNotification(translations[currentLanguage].ad_failed);
                }

            } catch (error) {
                window.showAdNotification(translations[currentLanguage].ad_failed + `: ${error.message}`, 'error');
            } finally {
                initGame(); 
            }
        }

        // Option 2: Claim 1 point without ad
        async function claimOnePoint() {
            hideRewardChoiceModal(); 

            if (dailyGamePlays >= DAILY_GAME_LIMIT) {
                window.showAdNotification(translations[currentLanguage].daily_game_limit_reached);
                initGame(); 
                return; 
            }

            // Make sure Firebase is ready before attempting points update
            if (!window.db || !window.currentAppUserId || !window.auth.currentUser) {
                window.showAdNotification(translations[currentLanguage].ad_failed + ' (Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø·Ø§Ù„Ø¨Ø©)', 'error');
                initGame();
                return;
            }

            dailyGamePlays++; 
            totalGamesWon++; 

            localStorage.setItem('dailyGamePlays', dailyGamePlays);
            localStorage.setItem('totalGamesWon', totalGamesWon);

            await updateDailyCompetitionPointsInFirestore(POINTS_PER_XO_WIN_NO_AD); 
            updateUI();
            window.showAdNotification(translations[currentLanguage].competition_point_earned_notification);
            initGame(); 
        }
        
        // Show general notification (temporary, disappears after 3 seconds)
        function showAdNotification(message, type = 'info') { // Added type parameter
            adNotificationEl.textContent = message;
            adNotificationEl.style.display = 'block';
            if (type === 'error') {
                adNotificationEl.style.backgroundColor = 'rgba(255, 0, 0, 0.8)';
            } else if (type === 'success') {
                adNotificationEl.style.backgroundColor = 'rgba(0, 128, 0, 0.8)';
            } else {
                adNotificationEl.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
            }
            
            setTimeout(() => {
                adNotificationEl.style.display = 'none';
            }, 3000);
        }

        // Function to show withdraw form
        window.showWithdrawForm = function() {
            withdrawSectionEl.style.display = 'block';
        }

        // Function to handle withdrawal 
        window.withdrawPoints = function() {
            // Ensure Firebase is ready for withdrawal
            if (!window.db || !window.currentAppUserId || !window.auth.currentUser) {
                showTemporaryMessage('Ø®Ø·Ø£: Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø³Ø­Ø¨.', 'red');
                return;
            }

            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const paymentMethod = document.getElementById('payment-method').value; 
            const walletAddress = document.getElementById('wallet-address').value; 

            let minRequiredPoints;
            let methodName;

            if (paymentMethod === 'faucetpay') {
                minRequiredPoints = MIN_WITHDRAW_POINTS_FAUCETPAY;
                methodName = translations[currentLanguage].faucetpay_option;
            } else { 
                minRequiredPoints = MIN_WITHDRAW_POINTS;
                methodName = translations[currentLanguage].other_wallet_option;
            }

            if (isNaN(amount) || amount < minRequiredPoints) {
                let message = translations[currentLanguage].min_withdraw_message
                    .replace('{methodName}', methodName)
                    .replace('{minAmount}', minRequiredPoints);
                showTemporaryMessage(message, 'red');
                return;
            }

            if (amount > earnedPoints) {
                let message = translations[currentLanguage].insufficient_balance.replace('{earnedPoints}', earnedPoints.toFixed(2));
                showTemporaryMessage(message, 'red');
                return;
            }

            if (!walletAddress.trim()) { 
                showTemporaryMessage(translations[currentLanguage].enter_wallet_address, 'red');
                return;
            }

            earnedPoints -= amount;
            localStorage.setItem('earnedPoints', earnedPoints.toFixed(2)); 
            updateUI(); 

            let messageToAdmin = `New Withdrawal Request:\nUser ID: ${window.currentAppUserId}\nTelegram Username: @${window.currentTelegramUsername}\nAmount: ${amount} Pepe Coins\nPayment Method: `;
            if (paymentMethod === 'faucetpay') {
                messageToAdmin += `FaucetPay\nWallet Address/Email: ${walletAddress}`;
            } else if (paymentMethod === 'other_wallet') {
                messageToAdmin += `Other Wallet\nWallet Address: ${walletAddress}`;
            } else { 
                messageToAdmin += `${translations.ar.unknown_method} ${paymentMethod}\nWallet Address: ${walletAddress}`; 
            }
            
            sendWithdrawRequestToAdmin(messageToAdmin);

            showTemporaryMessage(translations[currentLanguage].withdrawal_success_message, 'green');

            document.getElementById('withdraw-amount').value = '';
            document.getElementById('wallet-address').value = '';
        }

        // Function to send withdrawal request to admin via Telegram
        function sendWithdrawRequestToAdmin(message) {
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${ADMIN_USER_ID}&text=${encodeURIComponent(message)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                    } else {
                        let errorMessage = translations[currentLanguage].telegram_send_fail.replace('{error}', data.description || data);
                        showTemporaryMessage(errorMessage, 'red');
                    }
                })
                .catch(error => {
                    let errorMessage = translations[currentLanguage].telegram_connect_error.replace('{error}', error.message);
                    showTemporaryMessage(errorMessage, 'red');
                });
        }

        // Utility for showing temporary messages (for withdrawal status)
        let messageTimeout;
        function showTemporaryMessage(msg, color) {
            withdrawStatusEl.textContent = msg;
            withdrawStatusEl.style.color = color;
            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                withdrawStatusEl.textContent = '';
            }, 5000); 
        }

        // LEADERBOARD FUNCTIONS
        window.showLeaderboard = async function() {
            leaderboardModalOverlay.classList.add('active');
            leaderboardListEl.innerHTML = `<li data-key="leaderboard_loading">${translations[currentLanguage].leaderboard_loading}</li>`; 
            myRankDisplayEl.textContent = ''; 

            if (!window.db || !window.currentAppUserId || !window.auth.currentUser) {
                window.showAppStatus(translations[currentLanguage].leaderboard_loading_error + ' (Firebase DB Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ø¬Ø§Ù‡Ø²)', 'error');
                leaderboardListEl.innerHTML = `<li style="color:red;">${translations[currentLanguage].leaderboard_loading_error} (Firebase DB Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ø¬Ø§Ù‡Ø²)</li>`;
                return;
            }

            const todayDate = getTodayDate();
            const leaderboardColRef = window.collection(window.db, `artifacts/${window.APP_ID}/public/dailyCompetitionScores`);
            
            try {
                const q = window.query(
                    leaderboardColRef,
                    window.orderBy("points", "desc") 
                );
                
                const querySnapshot = await window.getDocs(q);
                let leaderboardData = [];
                let currentUserRank = -1;
                let currentUserPoints = 0;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.lastUpdateDate === todayDate && data.points > 0) { 
                        leaderboardData.push({
                            id: data.userId,
                            username: data.username,
                            points: data.points
                        });
                    }
                });

                leaderboardData.sort((a, b) => b.points - a.points); 

                leaderboardListEl.innerHTML = ''; 

                if (leaderboardData.length === 0) {
                    leaderboardListEl.innerHTML = `<li data-key="leaderboard_no_data">${translations[currentLanguage].leaderboard_no_data}</li>`;
                } else {
                    leaderboardData.slice(0, 100).forEach((entry, index) => { 
                        const listItem = document.createElement('li');
                        const isCurrentUser = (window.currentAppUserId === entry.id);
                        if (isCurrentUser) {
                            listItem.classList.add('current-user');
                            currentUserRank = index + 1;
                            currentUserPoints = entry.points;
                        }
                        listItem.innerHTML = `
                            <span class="rank">${index + 1}.</span>
                            <span class="user-info-entry">
                                <span class="username">@${entry.username || entry.id}</span>
                                <span class="userid-mini">${entry.id}</span>
                            </span>
                            <span class="points">${entry.points}</span>
                        `;
                        leaderboardListEl.appendChild(listItem);
                    });
                }

                if (currentUserRank !== -1) {
                    myRankDisplayEl.textContent = translations[currentLanguage].my_rank_display
                        .replace('{rank}', currentUserRank)
                        .replace('{points}', currentUserPoints);
                } else {
                    myRankDisplayEl.textContent = translations[currentLanguage].my_rank_not_found;
                }

            } catch (error) {
                window.showAppStatus(translations[currentLanguage].leaderboard_loading_error + `: ${error.message}`, 'error');
                leaderboardListEl.innerHTML = `<li style="color:red;">${translations[currentLanguage].leaderboard_loading_error}</li>`;
            }
        }

        window.hideLeaderboard = function() {
            leaderboardModalOverlay.classList.remove('active');
        }

        // REFERRAL FUNCTIONS
        window.showReferralModal = async function() {
            referralModalOverlay.classList.add('active');
            await getAndDisplayReferralCount();
            
            const baseUrl = telegramMiniAppUrl; 

            if (window.currentAppUserId) {
                const referralLink = `${baseUrl}?startapp=${window.currentAppUserId}`;
                referralLinkDisplayEl.textContent = referralLink;
            } else {
                referralLinkDisplayEl.textContent = translations[currentLanguage].your_id_prefix + "N/A"; 
            }
        }

        window.hideReferralModal = function() {
            referralModalOverlay.classList.remove('active');
        }

        // Record a referral in Firestore
        async function recordReferral(referrerId, refereeId, refereeUsername) {
            if (!window.db || !window.auth.currentUser || !referrerId || !refereeId) {
                window.showAppStatus('Ø®Ø·Ø£: Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©.', 'error', 7000);
                return;
            }

            const referralRef = window.doc(window.db, `artifacts/${window.APP_ID}/public/referrals`, refereeId); 

            try {
                const docSnap = await window.getDoc(referralRef);
                if (!docSnap.exists()) { 
                    await window.setDoc(referralRef, {
                        referrerId: referrerId,
                        refereeId: refereeId,
                        refereeUsername: refereeUsername,
                        timestamp: new Date().toISOString(), 
                    });
                    await incrementReferralCount(referrerId);
                    window.showAppStatus('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¥Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­.', 'success');
                } else {
                    window.showAppStatus('Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„.', 'info');
                }
            } catch (error) {
                window.showAppStatus(`Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø­Ø§Ù„Ø©: ${error.message}`, 'error', 7000);
            }
        }

        // Increment referrer's count
        async function incrementReferralCount(referrerId) {
            if (!window.db || !window.auth.currentUser || !referrerId) {
                window.showAppStatus('Ø®Ø·Ø£: Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ù„Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª.', 'error', 7000);
                return;
            }

            const referrerCountRef = window.doc(window.db, `artifacts/${window.APP_ID}/public/usersReferralsCount`, referrerId);

            try {
                const docSnap = await window.getDoc(referrerCountRef);
                let currentCount = 0;
                if (docSnap.exists()) {
                    currentCount = docSnap.data().count || 0;
                }
                const newCount = currentCount + 1;
                await window.setDoc(referrerCountRef, { count: newCount, userId: referrerId }, { merge: true });
                
                if (window.currentAppUserId === referrerId) {
                    referralCount = newCount;
                    localStorage.setItem('referralCount', referralCount);
                    updateUI();
                }
                window.showAppStatus('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª.', 'success');
            } catch (error) {
                window.showAppStatus(`Ø®Ø·Ø£ ÙÙŠ Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª: ${error.message}`, 'error', 7000);
            }
        }

        // Get and display the current user's referral count
        async function getAndDisplayReferralCount() {
            if (!window.db || !window.currentAppUserId || !window.auth.currentUser) {
                window.showAppStatus('ØªØ­Ø°ÙŠØ±: Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ù„Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª.', 'info', 7000);
                return;
            }

            const referrerCountRef = window.doc(window.db, `artifacts/${window.APP_ID}/public/usersReferralsCount`, window.currentAppUserId);

            try {
                const docSnap = await window.getDoc(referrerCountRef);
                if (docSnap.exists()) {
                    referralCount = docSnap.data().count || 0;
                } else {
                    referralCount = 0;
                }
                localStorage.setItem('referralCount', referralCount);
                updateUI();
                window.showAppStatus('ØªÙ… Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.', 'success');
            } catch (error) {
                window.showAppStatus(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª: ${error.message}`, 'error', 7000);
                referralCount = 0; 
                localStorage.setItem('referralCount', referralCount);
                updateUI();
            }
        }

        // NEW: Firebase Connection Test Function
        window.testFirebaseConnection = async function() {
            window.showAppStatus('Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ Firebase...', 'info', 0); // Persist status

            if (!window.firebaseApp) {
                window.showAppStatus('Ø®Ø·Ø£: Firebase Ù„Ù… ÙŠØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡ Ø¨Ø¹Ø¯.', 'error', 5000);
                return;
            }
            if (!window.auth || !window.auth.currentUser) {
                window.showAppStatus('Ø®Ø·Ø£: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø£Ùˆ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„Ø©.', 'error', 5000);
                return;
            }
            if (!window.db) {
                window.showAppStatus('Ø®Ø·Ø£: Firestore Database ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø©.', 'error', 5000);
                return;
            }

            const testDocRef = window.doc(window.db, `artifacts/${window.APP_ID}/public/testConnections`, window.currentAppUserId);
            const testData = {
                timestamp: new Date().toISOString(),
                userId: window.currentAppUserId,
                username: window.currentTelegramUsername,
                message: "Test write from app"
            };

            try {
                // Attempt to write data
                await window.setDoc(testDocRef, testData);
                window.showAppStatus('ØªÙ…Øª Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Firestore.', 'success', 3000);

                // Attempt to read data
                const docSnap = await window.getDoc(testDocRef);
                if (docSnap.exists()) {
                    const readData = docSnap.data();
                    window.showAppStatus(`ØªÙ…Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Firestore. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${readData.message}`, 'success', 5000);
                } else {
                    window.showAppStatus('Ø®Ø·Ø£: ØªÙ…Øª Ø§Ù„ÙƒØªØ§Ø¨Ø©ØŒ Ù„ÙƒÙ† Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¹Ù†Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©.', 'error', 5000);
                }
            } catch (error) {
                window.showAppStatus(`Ø®Ø·Ø£ ÙÙŠ Ø§ØªØµØ§Ù„ Firebase: ${error.message}`, 'error', 0); // Keep error persistent
            }
        };


        // Copy referral link to clipboard
        copyReferralLinkBtn.addEventListener('click', () => {
            const linkToCopy = referralLinkDisplayEl.textContent;
            if (linkToCopy) {
                const tempInput = document.createElement('textarea');
                tempInput.value = linkToCopy;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    referralLinkDisplayEl.parentNode.classList.add('copied');
                    setTimeout(() => {
                        referralLinkDisplayEl.parentNode.classList.remove('copied');
                    }, 2000);
                    showAdNotification(translations[currentLanguage].link_copied_success, 'success'); // Added type
                } catch (err) {
                    showAdNotification(translations[currentLanguage].link_share_failed, 'error'); // Added type
                }
                document.body.removeChild(tempInput);
            }
        });

        // Share referral link via Telegram Web App
        shareReferralLinkBtn.addEventListener('click', () => {
            const linkToShare = referralLinkDisplayEl.textContent;
            if (linkToShare && typeof window.Telegram !== 'undefined' && window.Telegram.WebApp && window.Telegram.WebApp.shareViaWebApp) {
                window.Telegram.WebApp.shareViaWebApp({
                    text: translations[currentLanguage].invite_friends_message_share,
                    url: linkToShare
                });
            } else if (linkToShare) {
                showAdNotification(translations[currentLanguage].link_share_failed, 'error'); // Added type
            } 
        });


        // Event Listeners
        restartGameBtn.addEventListener('click', initGame);
        claimRewardBtn.addEventListener('click', showRewardChoiceModal); 
        watchAdForPointsBtn.addEventListener('click', watchAdAndGetPoints); 
        claimOnePointBtn.addEventListener('click', claimOnePoint); 
        showWithdrawBtn.addEventListener('click', showWithdrawForm);
        viewLeaderboardBtn.addEventListener('click', showLeaderboard); 
        inviteFriendsBtn.addEventListener('click', showReferralModal); 

        // Initial app setup handled by DOMContentLoaded for Firebase init
    </script>
</body>
</html>
