<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Easy Earning Bot</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    /* Root variables for consistent theming */
    :root {
      --primary-color: #2ed914;
      --primary-hover: #3bff21;
      --secondary-color: #2a2a2e;
      --background-color: #1c1c1f;
      --text-color: #f0f0f0;
      --text-muted-color: #a0a0a0;
      --accent-color: #ff8c00;
      --card-bg: #252528;
      --error-color: #ff4d4d;
      --success-color: #4CAF50;
    }
    /* Universal box-sizing and tap-highlight prevention */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    /* Body styling for full-screen layout and centering */
    body {
      margin: 0; padding: 0; background-color: var(--background-color); color: var(--text-color);
      font-family: 'Segoe UI', 'Roboto', sans-serif; display: flex; justify-content: center; align-items: center;
      height: 100vh; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      overflow: hidden; /* Prevent body scroll */
    }
    /* Main container for the app, responsive and centered */
    .container {
      width: 100%; height: 100%; max-width: 400px; background: var(--background-color);
      display: flex; flex-direction: column; overflow: hidden; position: relative;
    }
    /* Main content area with scrollability and padding */
    main {
      flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; /* Space for footer nav */
    }
    /* View transitions for smooth navigation */
    .view { display: none; animation: fadeIn 0.4s ease-in-out; }
    .view.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    /* User header card styling */
    .user-header-card {
      background: var(--card-bg); border-radius: 16px; padding: 15px; margin-bottom: 25px;
      display: flex; align-items: center; border: 1px solid rgba(255, 255, 255, 0.05);
    }
    /* User avatar styling */
    .user-avatar {
      width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; overflow: hidden;
      background: linear-gradient(135deg, var(--primary-color), #00a651);
      display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px;
      color: #fff;
    }
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .user-info .username { font-size: 18px; font-weight: 700; margin: 0; }
    .user-info .title { font-size: 14px; color: var(--text-muted-color); margin: 0; }
    /* Balance card styling */
    .balance-card {
      background: linear-gradient(135deg, #00a651, #00753a); border-radius: 16px; padding: 20px;
      text-align: center; margin-bottom: 25px;
    }
    .balance-card .label { font-size: 16px; opacity: 0.8; margin-bottom: 5px; }
    .balance-card .balance-value { font-size: 36px; font-weight: 800; margin: 0; letter-spacing: 1px; }
    .balance-card .points-value { font-size: 16px; font-weight: 600; color: var(--accent-color); margin-top: 10px; }
    /* Section title styling */
    .section-title { font-size: 20px; font-weight: 700; margin-bottom: 15px; padding-left: 5px; border-left: 4px solid var(--primary-color); }
    /* Task card styling */
    .task-card {
      background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 15px;
      display: flex; align-items: center; cursor: pointer; transition: transform 0.2s ease, background-color 0.2s ease;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .task-card:hover { transform: translateY(-3px); background-color: var(--secondary-color); }
    .task-icon { font-size: 24px; color: var(--primary-color); margin-right: 20px; width: 30px; text-align: center; }
    .task-details h3 { margin: 0; font-size: 16px; font-weight: 600; }
    .task-details p { margin: 3px 0 0; font-size: 13px; color: var(--text-muted-color); }
    .task-arrow { margin-left: auto; font-size: 18px; color: var(--text-muted-color); }
    /* List item styling (for leaderboard and history) */
    .list-item {
      display: flex; align-items: center; background: var(--card-bg); padding: 12px 15px;
      border-radius: 10px; margin-bottom: 10px; border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .list-item .rank { font-size: 16px; font-weight: 700; color: var(--text-muted-color); width: 30px; }
    .list-item .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--secondary-color); margin-right: 15px; object-fit: cover; }
    .list-item .info { flex-grow: 1; }
    .list-item .info .name { font-weight: 600; font-size: 15px; }
    .list-item .info .detail { font-size: 13px; color: var(--text-muted-color); }
    .list-item .score { font-size: 16px; font-weight: 700; color: var(--accent-color); }
    .history-icon { color: var(--primary-color); margin-right: 15px; font-size: 18px; }
    /* Footer navigation styling */
    .footer-nav {
      position: fixed; bottom: 0; left: 0; right: 0; width: 100%; max-width: 400px; margin: 0 auto;
      display: flex; justify-content: space-around; background: var(--secondary-color);
      padding: 10px 0; border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    .nav-button {
      display: flex; flex-direction: column; align-items: center; color: var(--text-muted-color);
      background: none; border: none; font-size: 12px; transition: color 0.2s ease, transform 0.2s ease;
      cursor: pointer; padding: 5px 10px;
    }
    .nav-button .icon { font-size: 22px; margin-bottom: 4px; }
    .nav-button:hover { color: var(--text-color); }
    .nav-button.active { color: var(--primary-color); transform: scale(1.1); }
    /* Action button styling */
    .action-button {
      width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 16px; font-weight: 700;
      margin-top: 15px; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px;
    }
    .primary-button { background: var(--primary-color); color: #000; }
    .primary-button:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(46, 217, 20, 0.3); }
    .secondary-button { background: var(--secondary-color); color: var(--primary-color); }
    .secondary-button:hover { background: #3a3a3e; }
    .action-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    /* Modal overlay and content styling */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7);
      display: none; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.3s;
    }
    .modal-overlay.active { display: flex; }
    .modal-content {
      background: var(--card-bg); padding: 25px; border-radius: 16px; width: 90%; max-width: 320px;
      text-align: center; animation: slideIn 0.3s;
    }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-content h3 { margin-top: 0; font-size: 20px; }
    .modal-content p { color: var(--text-muted-color); margin-bottom: 25px; }
    .modal-actions { display: flex; gap: 10px; }

    /* Custom Notification/Message Box */
    #custom-notification {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        font-size: 14px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    #custom-notification.show {
        opacity: 1;
        visibility: visible;
    }
    #custom-notification.error {
        background-color: var(--error-color);
    }
    #custom-notification.success {
        background-color: var(--success-color);
    }

    /* Withdrawal Form Specific Styles */
    .form-group {
        margin-bottom: 15px;
        text-align: left;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        color: var(--text-muted-color);
    }
    .form-group input[type="number"],
    .form-group input[type="text"],
    .form-group select {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background-color: var(--secondary-color);
        color: var(--text-color);
        font-size: 15px;
    }
    .form-group input::placeholder {
        color: #777;
    }
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(46, 217, 20, 0.3);
    }
    .current-balance-info {
        font-size: 15px;
        color: var(--accent-color);
        margin-bottom: 20px;
        text-align: center;
    }
    .warning-message {
        font-size: 13px;
        color: var(--accent-color);
        background: rgba(255, 140, 0, 0.1);
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--accent-color);
        margin-bottom: 20px;
        white-space: pre-wrap; /* For multi-line messages */
    }

    /* Referral Section Specific Styles */
    .referral-link-container {
        display: flex;
        margin-bottom: 15px;
        background-color: var(--secondary-color);
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .referral-link-container input {
        flex-grow: 1;
        padding: 10px 15px;
        border: none;
        background: transparent;
        color: var(--text-color);
        font-size: 14px;
        outline: none;
        cursor: text;
    }
    .referral-link-container button {
        background: var(--primary-color);
        color: #000;
        padding: 10px 15px;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s ease;
        font-weight: 600;
    }
    .referral-link-container button:hover {
        background: var(--primary-hover);
    }
    .referral-stats p {
        margin: 8px 0;
        font-size: 14px;
        color: var(--text-muted-color);
    }
    .referral-stats span {
        font-weight: bold;
        color: var(--accent-color);
    }
    .back-button {
        display: block;
        width: fit-content;
        margin: 20px auto 0;
        padding: 10px 20px;
        background: var(--card-bg);
        color: var(--primary-color);
        border-radius: 10px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 600;
        transition: background-color 0.2s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .back-button:hover {
        background: var(--secondary-color);
    }

    /* Loading Overlay Styles */
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        color: white;
        font-size: 1.2em;
        text-align: center;
    }
    #loading-overlay .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    #loading-overlay.hidden {
        display: none;
    }
  </style>

  <!-- Firebase SDKs -->
  <script type="module" src="https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js"></script> 
  <script src='//libtl.com/sdk.js' data-zone='9459352' data-sdk='show_9459352'></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">
    <main id="main-content">

      <!-- HOME VIEW -->
      <div id="home-view" class="view active">
        <div class="user-header-card">
          <div class="user-avatar" id="profile-pic">EE</div>
          <div class="user-info">
            <h2 class="username" id="username">Loading...</h2>
            <p class="title">Welcome Back!</p>
          </div>
        </div>
        <div class="balance-card">
            <p class="label">Total Balance</p>
            <h1 class="balance-value" id="balance-value">$0.00</h1>
            <p class="points-value"><i class="fa-solid fa-coins"></i> <span id="points-value">0</span> Points</p>
        </div>
        <h2 class="section-title">Quick Actions</h2>
        <div class="task-card" onclick="showView('tasks-view')">
            <div class="task-icon"><i class="fa-solid fa-list-check"></i></div>
            <div class="task-details"><h3>View Tasks</h3><p>Watch ads and complete tasks to earn points.</p></div>
            <div class="task-arrow"><i class="fa-solid fa-chevron-right"></i></div>
        </div>
        <div class="task-card" onclick="showView('withdraw-view')">
            <div class="task-icon"><i class="fa-solid fa-wallet"></i></div>
            <div class="task-details"><h3>Withdraw Funds</h3><p>Request to withdraw your available balance.</p></div>
            <div class="task-arrow"><i class="fa-solid fa-chevron-right"></i></div>
        </div>
        <!-- New AI-powered Earning Tips Card -->
        <div class="task-card" onclick="showEarningTips()">
            <div class="task-icon"><i class="fa-solid fa-lightbulb"></i></div>
            <div class="task-details"><h3>✨ نصائح للربح</h3><p>احصل على استراتيجيات مخصصة لزيادة أرباحك.</p></div>
            <div class="task-arrow"><i class="fa-solid fa-chevron-right"></i></div>
        </div>
      </div>

      <!-- TASKS VIEW -->
      <div id="tasks-view" class="view">
        <h2 class="section-title">Earning Tasks</h2>
        <div class="task-card" onclick="showRewardedInterstitial()">
            <div class="task-icon"><i class="fa-solid fa-rectangle-ad"></i></div>
            <div class="task-details"><h3>Rewarded Interstitial</h3><p>Watch a full-screen ad to earn rewards.</p></div>
            <div class="task-arrow"><i class="fa-solid fa-play"></i></div>
        </div>
        <div class="task-card" onclick="showRewardedPopup()">
            <div class="task-icon"><i class="fa-solid fa-window-restore"></i></div>
            <div class="task-details"><h3>Rewarded Popup</h3><p>View a popup ad for quick points.</p></div>
            <div class="task-arrow"><i class="fa-solid fa-play"></i></div>
        </div>
      </div>

      <!-- LEADERBOARD VIEW -->
      <div id="leaderboard-view" class="view">
        <h2 class="section-title">Top Earners</h2>
        <div id="leaderboard-list"><!-- Leaderboard items will be generated here by JS --></div>
      </div>

      <!-- HISTORY VIEW -->
      <div id="history-view" class="view">
        <h2 class="section-title">Recent Activity</h2>
        <div id="history-list"><!-- History items will be generated here by JS --></div>
      </div>

      <!-- WITHDRAWAL VIEW -->
      <div id="withdraw-view" class="view">
        <h2 class="section-title">Withdraw Funds</h2>
        <p class="current-balance-info">Your Current Balance: <span id="current-withdraw-balance">0.00</span> Points ($<span id="current-withdraw-usd">0.00</span>)</p>
        <p class="warning-message" id="withdraw-warning-message">
            Minimum withdrawal for FaucetPay is 10 points.
            Minimum withdrawal for Any Other Wallet is 100 points.
            Please ensure you enter a correct wallet address for smooth withdrawals.
        </p>

        <div class="form-group">
            <label for="withdraw-amount">Amount to Withdraw (Points)</label>
            <input type="number" id="withdraw-amount" placeholder="Enter points to withdraw" min="1">
        </div>
        <div class="form-group">
            <label for="payment-method">Payment Method</label>
            <select id="payment-method">
                <option value="faucetpay">FaucetPay</option>
                <option value="other_wallet">Any Other Wallet</option>
            </select>
        </div>
        <div class="form-group">
            <label for="wallet-address">Wallet Address</label>
            <input type="text" id="wallet-address" placeholder="Enter your wallet address">
        </div>
        <button class="action-button primary-button" onclick="requestWithdraw()">Request Withdrawal</button>
        <button class="action-button secondary-button back-button" onclick="showView('home-view')">Back to Home</button>
      </div>

      <!-- REFERRAL VIEW -->
      <div id="referral-view" class="view">
        <h2 class="section-title">Referral Program</h2>
        <p>Invite your friends and earn <span id="referral-percentage"></span>% of their earnings!</p>
        <div class="referral-link-container">
            <input type="text" id="referral-link" readonly />
            <button onclick="copyReferralLink()">Copy Link</button>
        </div>
        <div class="referral-stats">
            <p>Total Referrals: <span id="total-referrals">0</span></p>
            <p>Earned from Referrals: <span id="earned-from-referrals">0.00</span> Points</p>
        </div>
        <button class="action-button secondary-button back-button" onclick="showView('home-view')">Back to Home</button>
      </div>

      <!-- EARNING TIPS VIEW (New AI-powered feature) -->
      <div id="earning-tips-view" class="view">
          <h2 class="section-title">✨ نصائح للربح</h2>
          <div class="card-bg p-4 rounded-lg shadow-md mb-4 text-center">
              <p id="tips-display" class="text-muted-color">انقر على الزر أدناه للحصول على نصائح مخصصة!</p>
              <div id="tips-loading" class="text-center text-primary-color mt-4 hidden">
                  <i class="fas fa-spinner fa-spin"></i> جاري توليد النصائح...
              </div>
          </div>
          <button class="action-button primary-button" onclick="generateEarningTips()">توليد نصائح جديدة</button>
          <button class="action-button secondary-button back-button" onclick="showView('home-view')">العودة إلى الرئيسية</button>
      </div>

    </main>

    <nav class="footer-nav">
      <button class="nav-button active" onclick="showView('home-view')"><i class="icon fa-solid fa-house"></i>Home</button>
      <button class="nav-button" onclick="showView('tasks-view')"><i class="icon fa-solid fa-list-check"></i>Tasks</button>
      <button class="nav-button" onclick="showView('leaderboard-view')"><i class="icon fa-solid fa-trophy"></i>Leaders</button>
      <button class="nav-button" onclick="showView('history-view')"><i class="icon fa-solid fa-clock-rotate-left"></i>History</button>
      <button class="nav-button" onclick="showView('referral-view')"><i class="icon fa-solid fa-users"></i>Referral</button>
    </nav>
  </div>

  <!-- Custom Notification Display -->
  <div id="custom-notification" class="custom-notification"></div>

  <!-- Loading Overlay -->
  <div id="loading-overlay">
      <div class="spinner"></div>
      <p>جاري تهيئة التطبيق...</p>
  </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js"; 

    // --- Firebase Configuration (Provided by user) ---
    // Make sure these values are correct for your Firebase project
    const firebaseConfig = {
      apiKey: "AIzaSyCydJckf37-5tcuEui380_B1Z2lQSgg5gc",
      authDomain: "alhdad-c435e.firebaseapp.com",
      projectId: "alhdad-c435e",
      storageBucket: "alhdad-c435e.firebasestorage.app",
      messagingSenderId: "598507430930",
      appId: "1:598507430930:web:12dbf6386bd6dbf0da64cb"
    };

    // Using projectId as appId for Firestore paths as per rules
    const appId = firebaseConfig.projectId; 

    // Global Firebase and Telegram Mini App variables
    let firebaseApp = null;
    let db = null;
    let auth = null; 
    let firebaseAuthUid = null; // Firebase Auth User ID (will be used for Firestore doc IDs)
    let telegramUserInitData = null; // Store full Telegram user init data from WebApp.initDataUnsafe.user

    let isAppReady = false;

    // --- Constants ---
    const POINTS_PER_AD = 1; 
    const RATE_PER_POINT = 0.05; 
    const MIN_WITHDRAW_POINTS_FAUCETPAY = 10;
    const MIN_WITHDRAW_POINTS_OTHER_WALLET = 100;
    const REFERRAL_PERCENTAGE = 0.10; 

    // Telegram Bot API details (Replace with your actual bot token and admin ID)
    const BOT_TOKEN = '7201062892:AAGewLnDhE6l7buTuXAIScVhI4d-XJZZ5Hs'; 
    const ADMIN_USER_ID = '6357701459'; 

    // --- State Variables (Managed by Firestore) ---
    let points = 0;
    let balance = 0.00; 
    let historyLog = []; 
    let referrerTelegramId = null; // This will store the Telegram ID of the referrer
    let totalReferrals = 0;
    let earnedFromReferrals = 0.00;

    // --- DOM Elements ---
    const usernameEl = document.getElementById('username');
    const profilePicDiv = document.getElementById('profile-pic');
    const pointsValueEl = document.getElementById('points-value');
    const balanceValueEl = document.getElementById('balance-value');
    const leaderboardListEl = document.getElementById('leaderboard-list');
    const historyListEl = document.getElementById('history-list');
    const customNotificationEl = document.getElementById('custom-notification');
    const loadingOverlayEl = document.getElementById('loading-overlay'); // Loading overlay element

    // Withdrawal View Elements
    const currentWithdrawBalanceEl = document.getElementById('current-withdraw-balance');
    const currentWithdrawUsdEl = document.getElementById('current-withdraw-usd');
    const withdrawAmountInput = document.getElementById('withdraw-amount');
    const paymentMethodSelect = document.getElementById('payment-method');
    const walletAddressInput = document.getElementById('wallet-address');
    const withdrawWarningMessageEl = document.getElementById('withdraw-warning-message');

    // Referral View Elements
    const referralPercentageEl = document.getElementById('referral-percentage');
    const referralLinkInput = document.getElementById('referral-link');
    const totalReferralsEl = document.getElementById('total-referrals');
    const earnedFromReferralsEl = document.getElementById('earned-from-referrals');

    // Earning Tips View Elements
    const earningTipsViewEl = document.getElementById('earning-tips-view');
    const tipsDisplayEl = document.getElementById('tips-display');
    const tipsLoadingEl = document.getElementById('tips-loading');

    // --- Core App Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        initApp();
    });

    async function initApp() {
        showLoadingOverlay('جاري تهيئة التطبيق...');
        try {
            // Initialize Telegram WebApp
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                Telegram.WebApp.BackButton.onClick(handleBackButtonClick); 
                Telegram.WebApp.onEvent('backButtonClicked', handleBackButtonClick); 
                
                telegramUserInitData = Telegram.WebApp.initDataUnsafe.user; 
                if (!telegramUserInitData || !telegramUserInitData.id) {
                    showNotification("معرف مستخدم Telegram غير متاح. قد لا يكون التطبيق يعمل في Telegram.", 'error');
                    isAppReady = false;
                    hideLoadingOverlay();
                    return;
                }
                console.log("Telegram User ID:", telegramUserInitData.id);
                console.log("Telegram Username:", telegramUserInitData.username || 'N/A');

                // Initialize Firebase App and Services
                firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp); 
                console.log("Firebase initialized.");

                // Sign in anonymously to get a Firebase UID. This is crucial for Firestore security rules.
                const userCredential = await signInAnonymously(auth);
                firebaseAuthUid = userCredential.user.uid;
                console.log("Signed in anonymously with Firebase UID:", firebaseAuthUid);
                
                // Load user data from Firestore using the Firebase UID as the document ID
                // This onSnapshot will keep the local state updated in real-time
                const userDocRef = doc(db, `artifacts/${appId}/users/${firebaseAuthUid}`);
                onSnapshot(userDocRef, async (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        points = data.points || 0;
                        balance = data.balance || 0.00;
                        historyLog = data.historyLog || [];
                        referrerTelegramId = data.referrerTelegramId || null; 
                        totalReferrals = data.totalReferrals || 0;
                        earnedFromReferrals = data.earnedFromReferrals || 0.00;

                        console.log("User data loaded/updated from Firestore (onSnapshot):", data);
                    } else {
                        console.log("User document not found, creating new one for Firebase UID:", firebaseAuthUid);
                        points = 0;
                        balance = 0.00;
                        historyLog = [];
                        totalReferrals = 0;
                        earnedFromReferrals = 0.00;

                        // Check for referrer from initData only if this is a new user document creation
                        let initialReferrerTelegramId = null;
                        const urlParams = new URLSearchParams(Telegram.WebApp.initData);
                        const startParam = urlParams.get('start_param');
                        if (startParam && startParam.startsWith('ref_')) {
                            const foundReferrerId = startParam.substring(4);
                            if (foundReferrerId !== telegramUserInitData.id.toString()) { // Prevent self-referral
                                initialReferrerTelegramId = foundReferrerId;
                                console.log(`Initial referrer Telegram ID ${initialReferrerTelegramId} captured for new user.`);
                            }
                        }

                        // Set initial data, including the Telegram ID for lookup purposes
                        await setDoc(userDocRef, {
                            telegramId: telegramUserInitData.id.toString(), // Store Telegram ID as a field
                            username: telegramUserInitData.username || '',
                            firstName: telegramUserInitData.first_name || '',
                            points: points,
                            balance: balance,
                            historyLog: historyLog,
                            referrerTelegramId: initialReferrerTelegramId, 
                            totalReferrals: totalReferrals,
                            earnedFromReferrals: earnedFromReferrals
                        });
                        console.log("New user document created successfully for Firebase UID.");

                        // If a referrer was found and this is a new user, increment referrer's totalReferrals
                        if (initialReferrerTelegramId) {
                            const referrerQuery = query(collection(db, `artifacts/${appId}/users`), where("telegramId", "==", initialReferrerTelegramId));
                            const referrerSnapshot = await getDocs(referrerQuery);
                            if (!referrerSnapshot.empty) {
                                const referrerDoc = referrerSnapshot.docs[0];
                                await updateDoc(referrerDoc.ref, { totalReferrals: increment(1) });
                                console.log(`Referrer (Firebase UID: ${referrerDoc.id})'s totalReferrals incremented for new referral.`);
                            } else {
                                console.warn(`Referrer with Telegram ID ${initialReferrerTelegramId} not found in Firestore during new user creation. Cannot increment totalReferrals.`);
                            }
                        }
                    }
                    updateUI(); // Always update UI after data changes
                    hideLoadingOverlay(); // Hide loading overlay once initial data is loaded
                }, (error) => {
                    console.error("Error listening to user document in Firestore:", error);
                    showNotification(`خطأ في تحميل بيانات المستخدم: ${error.message}`, 'error');
                    hideLoadingOverlay();
                });

                isAppReady = true;
                showNotification('تم تحميل التطبيق بنجاح!', 'success');
            } else {
                showNotification("لم يتم العثور على Telegram WebApp SDK. يعمل في الوضع المستقل (للتطوير).", 'info');
                // For standalone testing/development, mock Telegram user data and sign in anonymously
                telegramUserInitData = { id: 123456789, first_name: 'Test', username: 'testuser' };
                
                firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);
                console.log("Firebase initialized in standalone mode.");

                const userCredential = await signInAnonymously(auth);
                firebaseAuthUid = userCredential.user.uid;
                console.log("Signed in anonymously (standalone) with Firebase UID:", firebaseAuthUid);

                // Set up onSnapshot listener for standalone mode
                const userDocRef = doc(db, `artifacts/${appId}/users/${firebaseAuthUid}`);
                onSnapshot(userDocRef, async (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        points = data.points || 0;
                        balance = data.balance || 0.00;
                        historyLog = data.historyLog || [];
                        referrerTelegramId = data.referrerTelegramId || null; 
                        totalReferrals = data.totalReferrals || 0;
                        earnedFromReferrals = data.earnedFromReferrals || 0.00;
                        console.log("User data loaded/updated from Firestore (onSnapshot - standalone):", data);
                    } else {
                        console.log("User document not found, creating new one for Firebase UID (standalone):", firebaseAuthUid);
                        points = 0;
                        balance = 0.00;
                        historyLog = [];
                        totalReferrals = 0;
                        earnedFromReferrals = 0.00;
                        await setDoc(userDocRef, {
                            telegramId: telegramUserInitData.id.toString(),
                            username: telegramUserInitData.username || '',
                            firstName: telegramUserInitData.first_name || '',
                            points: points,
                            balance: balance,
                            historyLog: historyLog,
                            referrerTelegramId: null, // No referrer in standalone mock
                            totalReferrals: totalReferrals,
                            earnedFromReferrals: earnedFromReferrals
                        });
                        console.log("New user document created successfully (standalone).");
                    }
                    updateUI();
                    hideLoadingOverlay();
                }, (error) => {
                    console.error("Error listening to user document in Firestore (standalone):", error);
                    showNotification(`خطأ في تحميل بيانات المستخدم (وضع مستقل): ${error.message}`, 'error');
                    hideLoadingOverlay();
                });

                isAppReady = true;
                showNotification('تم تحميل التطبيق بنجاح (وضع مستقل)!', 'success');
            }
        } catch (error) {
            console.error("Error initializing app (outer catch):", error);
            showNotification(`فشل تهيئة التطبيق: ${error.message}`, 'error');
            isAppReady = false;
            hideLoadingOverlay();
        } finally {
            // Initial UI update is now handled by the onSnapshot callback
            // renderLeaderboard(); // Render static leaderboard
            // updateWithdrawalWarning(); // Update withdrawal warning message
            // initializeInAppAds(); // This can run independently
        }

        initializeInAppAds(); // Keep ad initialization here
        renderLeaderboard(); // Keep leaderboard render here
    }

    // --- Loading Overlay Functions ---
    function showLoadingOverlay(message) {
        loadingOverlayEl.classList.remove('hidden');
        loadingOverlayEl.querySelector('p').textContent = message;
    }

    function hideLoadingOverlay() {
        loadingOverlayEl.classList.add('hidden');
    }

    // --- View Management ---
    function showView(viewId) {
        document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        
        document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector(`.nav-button[onclick="showView('${viewId}')"]`);
        if(activeBtn) activeBtn.classList.add('active');
        
        // Update specific view contents when activated
        if (viewId === 'history-view') renderHistory();
        if (viewId === 'withdraw-view') updateWithdrawalView();
        if (viewId === 'referral-view') updateReferralView();
        if (viewId === 'earning-tips-view') updateEarningTipsView(); 

        // Manage Telegram BackButton visibility
        if (window.Telegram && Telegram.WebApp && Telegram.WebApp.BackButton) {
            if (viewId === 'home-view') {
                Telegram.WebApp.BackButton.hide();
            } else {
                Telegram.WebApp.BackButton.show();
            }
        }
    }

    // Handles Telegram's native back button click
    function handleBackButtonClick() {
        const currentActiveView = document.querySelector('.view.active');
        if (currentActiveView && currentActiveView.id !== 'home-view') {
            showView('home-view');
        } else {
            // If on home view, close the Mini App
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.close();
            }
        }
    }

    // --- Data Display Update ---
    function updateUI() {
        // Use telegramUserInitData for display, firebaseAuthUid for Firestore operations
        if (!telegramUserInitData || !firebaseAuthUid) {
            usernameEl.textContent = "جاري التحميل...";
            profilePicDiv.textContent = "EE";
            pointsValueEl.textContent = "0";
            balanceValueEl.textContent = "$0.00";
            return;
        }

        usernameEl.textContent = telegramUserInitData.username || telegramUserInitData.first_name || 'مستخدم Telegram';
        if (telegramUserInitData.photo_url) {
            profilePicDiv.innerHTML = `<img src="${telegramUserInitData.photo_url}" alt="P">`;
        } else {
            profilePicDiv.textContent = (telegramUserInitData.first_name || 'U').charAt(0);
        }

        pointsValueEl.textContent = points;
        balanceValueEl.textContent = `$${balance.toFixed(2)}`;
        
        if (document.getElementById('withdraw-view').classList.contains('active')) {
            updateWithdrawalView();
        }
        if (document.getElementById('referral-view').classList.contains('active')) {
            updateReferralView();
        }
        if (document.getElementById('earning-tips-view').classList.contains('active')) {
            updateEarningTipsView();
        }
        console.log("UI Updated: Points =", points, "Balance =", balance.toFixed(2), "Referrals =", totalReferrals);
    }

    // --- History Logic ---
    async function addToHistory(type, detail) {
        if (!db || !firebaseAuthUid) {
            console.error("Firestore أو معرف Firebase UID غير جاهز لتحديث السجل.");
            return;
        }
        const timestamp = new Date().toISOString();
        const newEntry = { type, detail, timestamp };
        
        const updatedHistory = [newEntry, ...historyLog].slice(0, 50);
        
        const userDocRef = doc(db, `artifacts/${appId}/users/${firebaseAuthUid}`);
        try {
            await updateDoc(userDocRef, { historyLog: updatedHistory });
            historyLog = updatedHistory; 
            console.log("تم تحديث السجل في Firestore.");
        } catch (error) {
            console.error("خطأ في تحديث السجل في Firestore:", error);
        }
    }

    function renderHistory() {
        const list = historyListEl;
        if (historyLog.length === 0) {
            list.innerHTML = `<div class="list-item"><div class="info"><div class="name">لا يوجد نشاط بعد.</div><div class="detail">شاهد بعض الإعلانات للبدء!</div></div></div>`;
            return;
        }
        
        list.innerHTML = historyLog.map(item => {
            const icon = item.type === 'earn' 
                ? '<i class="fa-solid fa-plus-circle" style="color: var(--primary-color);"></i>' 
                : '<i class="fa-solid fa-paper-plane" style="color: var(--accent-color);"></i>';
            return `
                <div class="list-item">
                    <div class="history-icon">${icon}</div>
                    <div class="info">
                        <div class="name">${item.detail}</div>
                        <div class="detail">${new Date(item.timestamp).toLocaleString('ar-EG')}</div>
                    </div>
                </div>`;
        }).join('');
    }

    // --- Leaderboard Logic (Static for now, can be dynamic with Firestore) ---
    function renderLeaderboard() {
        const leaderboardData = [
            { name: "CryptoKing", score: 2540, avatar: "https://i.pravatar.cc/150?img=1" },
            { name: "Elena", score: 2210, avatar: "https://i.pravatar.cc/150?img=2" },
            { name: "ProMiner", score: 1980, avatar: "https://i.pravatar.cc/150?img=3" },
            { name: "Aisha", score: 1750, avatar: "https://i.pravatar.cc/150?img=4" },
            { name: "BotMaster", score: 1530, avatar: "https://i.pravatar.cc/150?img=5" },
        ];
        
        leaderboardListEl.innerHTML = leaderboardData.map((user, index) => `
            <div class="list-item">
                <div class="rank">#${index + 1}</div>
                <img src="${user.avatar}" class="avatar" alt="Avatar">
                <div class="info"><div class="name">${user.name}</div></div>
                <div class="score">${user.score} pts</div>
            </div>
        `).join('');
    }

    // --- Earning Functions ---
    async function grantReward() {
        if (!isAppReady || !firebaseAuthUid) {
            showNotification("التطبيق غير جاهز. يرجى الانتظار.", 'error');
            return;
        }

        const userDocRef = doc(db, `artifacts/${appId}/users/${firebaseAuthUid}`);
        let pointsToAdd = POINTS_PER_AD;
        let usdToAdd = pointsToAdd * RATE_PER_POINT;

        try {
            // Update current user's points and balance
            await updateDoc(userDocRef, {
                points: increment(pointsToAdd),
                balance: increment(usdToAdd)
            });
            console.log(`User ${firebaseAuthUid} earned ${pointsToAdd} points ($${usdToAdd.toFixed(2)}).`);

            // Handle referral earnings
            if (referrerTelegramId && referrerTelegramId !== telegramUserInitData.id.toString()) {
                const referrerEarnPoints = pointsToAdd * REFERRAL_PERCENTAGE;
                const referrerEarnUSD = usdToAdd * REFERRAL_PERCENTAGE;
                
                // Find the referrer's Firebase UID using their Telegram ID
                const referrerQuery = query(collection(db, `artifacts/${appId}/users`), where("telegramId", "==", referrerTelegramId));
                const referrerSnapshot = await getDocs(referrerQuery);

                if (!referrerSnapshot.empty) {
                    const referrerDoc = referrerSnapshot.docs[0];
                    await updateDoc(referrerDoc.ref, {
                        earnedFromReferrals: increment(referrerEarnPoints),
                        points: increment(referrerEarnPoints), 
                        balance: increment(referrerEarnUSD) 
                    });
                    console.log(`Referrer (Firebase UID: ${referrerDoc.id}) earned ${referrerEarnPoints} points ($${referrerEarnUSD.toFixed(2)}) from referral.`);
                } else {
                    console.warn(`Referrer with Telegram ID ${referrerTelegramId} not found in Firestore. Cannot grant referral earnings.`);
                }
            }

            showNotification(`تهانينا! لقد ربحت +${pointsToAdd} نقطة.`, 'success');
            addToHistory('earn', `+${pointsToAdd} نقطة من الإعلان`);
            Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        } catch (error) {
            console.error("خطأ في منح المكافأة أو تحديث Firestore:", error);
            showNotification(`فشل ربح المكافأة: ${error.message}`, 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        }
    }

    function showRewardedInterstitial() {
        if (!isAppReady) {
            showNotification("التطبيق لم يتم تحميله بالكامل بعد. يرجى الانتظار.", 'info');
            return;
        }
        if (typeof show_9459352 !== 'function') {
            showNotification('مزود الإعلانات غير جاهز. يرجى المحاولة مرة أخرى.', 'error');
            return;
        }
        showNotification('جاري تحميل الإعلان...', 'info');
        show_9459352().then(grantReward).catch(e => {
            console.error("فشل الإعلان البيني بمكافأة:", e);
            showNotification('تعذر عرض الإعلان. يرجى المحاولة مرة أخرى.', 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        });
    }

    function showRewardedPopup() {
        if (!isAppReady) {
            showNotification("التطبيق لم يتم تحميله بالكامل بعد. يرجى الانتظار.", 'info');
            return;
        }
        if (typeof show_9459352 !== 'function') {
            showNotification('مزود الإعلانات غير جاهز. يرجى المحاولة مرة أخرى.', 'error');
            return;
        }
        showNotification('جاري تحميل الإعلان...', 'info');
        show_9459352('pop').then(grantReward).catch(e => {
            console.error("فشل الإعلان المنبثق بمكافأة:", e);
            showNotification('تعذر عرض الإعلان. يرجى المحاولة مرة أخرى.', 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        });
    }

    // --- Custom Notification Function ---
    let notificationTimeout;
    function showNotification(message, type = 'info', duration = 3000) {
        customNotificationEl.textContent = message;
        customNotificationEl.className = 'custom-notification show'; 
        if (type === 'error') {
            customNotificationEl.classList.add('error');
        } else if (type === 'success') {
            customNotificationEl.classList.add('success');
        }
        
        clearTimeout(notificationTimeout);
        notificationTimeout = setTimeout(() => {
            customNotificationEl.classList.remove('show');
        }, duration);
    }

    // --- Withdrawal Logic ---
    function updateWithdrawalView() {
        currentWithdrawBalanceEl.textContent = points.toFixed(0);
        currentWithdrawUsdEl.textContent = balance.toFixed(2);
        updateWithdrawalWarning();
    }

    function updateWithdrawalWarning() {
        const selectedMethod = paymentMethodSelect.value;
        let minPoints = 0;
        if (selectedMethod === 'faucetpay') {
            minPoints = MIN_WITHDRAW_POINTS_FAUCETPAY;
        } else {
            minPoints = MIN_WITHDRAW_POINTS_OTHER_WALLET;
        }
        withdrawWarningMessageEl.innerHTML = `
            الحد الأدنى للسحب لـ FaucetPay هو ${MIN_WITHDRAW_POINTS_FAUCETPAY} نقطة.<br>
            الحد الأدنى للسحب لأي محفظة أخرى هو ${MIN_WITHDRAW_POINTS_OTHER_WALLET} نقطة.<br>
            رصيدك الحالي: ${points.toFixed(0)} نقطة ($${balance.toFixed(2)}).<br>
            يرجى التأكد من إدخال عنوان محفظة صحيح لعمليات سحب سلسة.
        `;
    }

    paymentMethodSelect.addEventListener('change', updateWithdrawalWarning);

    async function requestWithdraw() {
        if (!isAppReady || !firebaseAuthUid) {
            showNotification("التطبيق غير جاهز. يرجى الانتظار.", 'error');
            return;
        }

        const amount = parseFloat(withdrawAmountInput.value);
        const paymentMethod = paymentMethodSelect.value;
        const walletAddress = walletAddressInput.value.trim();

        let minRequiredPoints;
        let methodNameDisplay;

        if (paymentMethod === 'faucetpay') {
            minRequiredPoints = MIN_WITHDRAW_POINTS_FAUCETPAY;
            methodNameDisplay = 'FaucetPay';
        } else {
            minRequiredPoints = MIN_WITHDRAW_POINTS_OTHER_WALLET;
            methodNameDisplay = 'أي محفظة أخرى';
        }

        if (isNaN(amount) || amount <= 0) {
            showNotification("يرجى إدخال مبلغ صالح.", 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            return;
        }

        if (amount < minRequiredPoints) {
            showNotification(`الحد الأدنى للسحب لـ ${methodNameDisplay} هو ${minRequiredPoints} نقطة.`, 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            return;
        }

        if (amount > points) {
            showNotification(`رصيد غير كافٍ. لديك ${points.toFixed(0)} نقطة.`, 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            return;
        }

        if (!walletAddress) {
            showNotification("يرجى إدخال عنوان محفظتك.", 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            return;
        }

        try {
            const userDocRef = doc(db, `artifacts/${appId}/users/${firebaseAuthUid}`);
            const usdAmount = amount * RATE_PER_POINT;

            // Deduct points and balance in Firestore
            await updateDoc(userDocRef, {
                points: increment(-amount),
                balance: increment(-usdAmount)
            });
            console.log(`تم خصم ${amount} نقطة ($${usdAmount.toFixed(2)}) من المستخدم ${firebaseAuthUid}.`);

            // Send withdrawal request to admin via Telegram Bot API
            const userInfo = telegramUserInitData.username ? `@${telegramUserInitData.username} (ID: ${telegramUserInitData.id})` : `معرف المستخدم: ${telegramUserInitData.id}`;
            const messageToAdmin = `💸 *طلب سحب جديد*\n\n👤 *المستخدم:* ${userInfo}\n💰 *المبلغ:* ${amount} نقطة ($${usdAmount.toFixed(2)})\n💳 *الطريقة:* ${methodNameDisplay}\n✉️ *عنوان المحفظة:* \`${walletAddress}\`\n\n_يرجى معالجة هذا الطلب._`;

            sendWithdrawRequestToAdmin(messageToAdmin, telegramUserInitData.id.toString(), amount, usdAmount);

            showNotification("تم إرسال طلب السحب الخاص بك بنجاح!", 'success');
            addToHistory('withdraw', `طلب ${amount} نقطة ($${usdAmount.toFixed(2)}) عبر ${methodNameDisplay}`);
            Telegram.WebApp.HapticFeedback.notificationOccurred('success');

            // Clear form fields
            withdrawAmountInput.value = '';
            walletAddressInput.value = '';

        } catch (error) {
            console.error("خطأ أثناء عملية السحب:", error);
            showNotification(`فشل السحب: ${error.message}`, 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        }
    }

    function sendWithdrawRequestToAdmin(message, telegramUserIdForAdmin, pointsAmount, usdAmount) {
        // Callback data format: approve_withdraw_<telegram_user_id>_<points>_<usd>
        const callbackData = `approve_withdraw_${telegramUserIdForAdmin}_${pointsAmount}_${usdAmount.toFixed(2)}`;
        
        const inlineKeyboard = {
            inline_keyboard: [
                [{ text: "✅ الموافقة على السحب", callback_data: callbackData }]
            ]
        };
        const replyMarkup = encodeURIComponent(JSON.stringify(inlineKeyboard));

        fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${ADMIN_USER_ID}&text=${encodeURIComponent(message)}&parse_mode=Markdown&reply_markup=${replyMarkup}`)
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    console.log('Telegram Bot API: تم إرسال الرسالة مع زر الموافقة إلى المسؤول بنجاح.');
                } else {
                    console.error('خطأ Telegram Bot API: فشل إرسال الرسالة إلى Telegram:', data.description || JSON.stringify(data));
                    showNotification('فشل إخطار المسؤول بخصوص السحب.', 'error');
                }
            })
            .catch(error => {
                console.error('خطأ Telegram Bot API: خطأ في الشبكة أثناء جلب API Telegram:', error);
                showNotification('خطأ في الشبكة عند إرسال إشعار السحب.', 'error');
            });
    }

    // --- Share & Referral ---
    function updateReferralView() {
        referralPercentageEl.textContent = (REFERRAL_PERCENTAGE * 100).toFixed(0);
        referralLinkInput.value = generateReferralLink();
        totalReferralsEl.textContent = totalReferrals;
        earnedFromReferralsEl.textContent = earnedFromReferrals.toFixed(0);
    }

    function generateReferralLink() {
        const botUsername = "Easyearing99_bot"; // Replace with your bot's actual username
        if (telegramUserInitData && telegramUserInitData.id) {
            return `https://t.me/${botUsername}?startapp=ref_${telegramUserInitData.id}`;
        }
        return "جاري تحميل رابط الإحالة...";
    }

    window.copyReferralLink = function() {
        if (!isAppReady || !telegramUserInitData) {
            showNotification("التطبيق غير جاهز لنسخ الرابط. يرجى الانتظار.", 'error');
            return;
        }
        referralLinkInput.select();
        document.execCommand('copy');
        showNotification("تم نسخ رابط الإحالة بنجاح!", 'success');
        Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    }

    // This function is for the 'Share' button in the footer nav
    function shareApp() {
        if (!telegramUserInitData) {
            showNotification("تعذر الحصول على بيانات المستخدم من Telegram.", 'error');
            return;
        }
        const referralLink = generateReferralLink();
        const text = `🎉 انضم إلى هذا البوت الرائع وابدأ في الكسب! استخدم رابطي للحصول على مكافأة خاصة:`;
        const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=${encodeURIComponent(text)}`;
        Telegram.WebApp.openTelegramLink(shareUrl);
    }

    // --- New AI-Powered Earning Tips Logic ---
    function updateEarningTipsView() {
        tipsDisplayEl.textContent = 'انقر على الزر أدناه للحصول على نصائح مخصصة!';
        tipsLoadingEl.classList.add('hidden');
    }

    window.showEarningTips = function() {
        showView('earning-tips-view');
    }

    window.generateEarningTips = async function() {
        if (!isAppReady || !firebaseAuthUid) {
            showNotification("التطبيق غير جاهز. يرجى الانتظار.", 'error');
            return;
        }

        tipsDisplayEl.textContent = ''; 
        tipsLoadingEl.classList.remove('hidden'); 

        const prompt = `أنا مستخدم في تطبيق ربح النقاط. لدي حاليًا ${points} نقطة ورصيدي بالدولار هو ${balance.toFixed(2)} دولار. نسبة الربح من الإحالات هي ${REFERRAL_PERCENTAGE * 100}%. الحد الأدنى للسحب إلى FaucetPay هو ${MIN_WITHDRAW_POINTS_FAUCETPAY} نقطة، وإلى أي محفظة أخرى هو ${MIN_WITHDRAW_POINTS_OTHER_WALLET} نقطة.
        أعطني 3 نصائح موجزة ومبتكرة (في شكل نقاط) حول كيفية زيادة أرباحي في هذا التطبيق. ركز على استراتيجيات الربح من الإعلانات والإحالات. اجعل النصائح عملية ومحفزة ومباشرة.`;

        try {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }]
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                tipsDisplayEl.textContent = text;
                showNotification("تم توليد النصائح بنجاح!", 'success');
            } else {
                tipsDisplayEl.textContent = "عذراً، لم أتمكن من توليد نصائح في الوقت الحالي. يرجى المحاولة مرة أخرى.";
                showNotification("فشل توليد النصائح.", 'error');
                console.error("Gemini API response structure unexpected:", result);
            }
        } catch (error) {
            tipsDisplayEl.textContent = "حدث خطأ أثناء الاتصال بخدمة النصائح. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.";
            showNotification("خطأ في الاتصال بخدمة النصائح.", 'error');
            console.error("Error calling Gemini API:", error);
        } finally {
            tipsLoadingEl.classList.add('hidden'); 
        }
    }
</script>

</body>
</html>
