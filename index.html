<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Easy Earning Bot</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    /* Root variables for consistent theming */
    :root {
      --primary-color: #2ed914;
      --primary-hover: #3bff21;
      --secondary-color: #2a2a2e;
      --background-color: #1c1c1f;
      --text-color: #f0f0f0;
      --text-muted-color: #a0a0a0;
      --accent-color: #ff8c00;
      --card-bg: #252528;
      --error-color: #ff4d4d;
      --success-color: #4CAF50;
    }
    /* Universal box-sizing and tap-highlight prevention */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    /* Body styling for full-screen layout and centering */
    body {
      margin: 0; padding: 0; background-color: var(--background-color); color: var(--text-color);
      font-family: 'Segoe UI', 'Roboto', sans-serif; display: flex; justify-content: center; align-items: center;
      height: 100vh; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      overflow: hidden; /* Prevent body scroll */
    }
    /* Main container for the app, responsive and centered */
    .container {
      width: 100%; height: 100%; max-width: 400px; background: var(--background-color);
      display: flex; flex-direction: column; overflow: hidden; position: relative;
    }
    /* Main content area with scrollability and padding */
    main {
      flex-grow: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; /* Space for footer nav */
    }
    /* View transitions for smooth navigation */
    .view { display: none; animation: fadeIn 0.4s ease-in-out; }
    .view.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    /* User header card styling */
    .user-header-card {
      background: var(--card-bg); border-radius: 16px; padding: 15px; margin-bottom: 25px;
      display: flex; align-items: center; border: 1px solid rgba(255, 255, 255, 0.05);
    }
    /* User avatar styling */
    .user-avatar {
      width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; overflow: hidden;
      background: linear-gradient(135deg, var(--primary-color), #00a651);
      display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px;
      color: #fff;
    }
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .user-info .username { font-size: 18px; font-weight: 700; margin: 0; }
    .user-info .title { font-size: 14px; color: var(--text-muted-color); margin: 0; }
    /* Balance card styling */
    .balance-card {
      background: linear-gradient(135deg, #00a651, #00753a); border-radius: 16px; padding: 20px;
      text-align: center; margin-bottom: 25px;
    }
    .balance-card .label { font-size: 16px; opacity: 0.8; margin-bottom: 5px; }
    .balance-card .balance-value { font-size: 36px; font-weight: 800; margin: 0; letter-spacing: 1px; }
    .balance-card .points-value { font-size: 16px; font-weight: 600; color: var(--accent-color); margin-top: 10px; }
    /* Section title styling */
    .section-title { font-size: 20px; font-weight: 700; margin-bottom: 15px; padding-left: 5px; border-left: 4px solid var(--primary-color); }
    /* Task card styling */
    .task-card {
      background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 15px;
      display: flex; align-items: center; cursor: pointer; transition: transform 0.2s ease, background-color 0.2s ease;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .task-card:hover { transform: translateY(-3px); background-color: var(--secondary-color); }
    .task-icon { font-size: 24px; color: var(--primary-color); margin-right: 20px; width: 30px; text-align: center; }
    .task-details h3 { margin: 0; font-size: 16px; font-weight: 600; }
    .task-details p { margin: 3px 0 0; font-size: 13px; color: var(--text-muted-color); }
    .task-arrow { margin-left: auto; font-size: 18px; color: var(--text-muted-color); }
    /* List item styling (for leaderboard and history) */
    .list-item {
      display: flex; align-items: center; background: var(--card-bg); padding: 12px 15px;
      border-radius: 10px; margin-bottom: 10px; border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .list-item .rank { font-size: 16px; font-weight: 700; color: var(--text-muted-color); width: 30px; }
    .list-item .avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--secondary-color); margin-right: 15px; object-fit: cover; }
    .list-item .info { flex-grow: 1; }
    .list-item .info .name { font-weight: 600; font-size: 15px; }
    .list-item .info .detail { font-size: 13px; color: var(--text-muted-color); }
    .list-item .score { font-size: 16px; font-weight: 700; color: var(--accent-color); }
    .history-icon { color: var(--primary-color); margin-right: 15px; font-size: 18px; }
    /* Footer navigation styling */
    .footer-nav {
      position: fixed; bottom: 0; left: 0; right: 0; width: 100%; max-width: 400px; margin: 0 auto;
      display: flex; justify-content: space-around; background: var(--secondary-color);
      padding: 10px 0; border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    .nav-button {
      display: flex; flex-direction: column; align-items: center; color: var(--text-muted-color);
      background: none; border: none; font-size: 12px; transition: color 0.2s ease, transform 0.2s ease;
      cursor: pointer; padding: 5px 10px;
    }
    .nav-button .icon { font-size: 22px; margin-bottom: 4px; }
    .nav-button:hover { color: var(--text-color); }
    .nav-button.active { color: var(--primary-color); transform: scale(1.1); }
    /* Action button styling */
    .action-button {
      width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 16px; font-weight: 700;
      margin-top: 15px; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px;
    }
    .primary-button { background: var(--primary-color); color: #000; }
    .primary-button:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(46, 217, 20, 0.3); }
    .secondary-button { background: var(--secondary-color); color: var(--primary-color); }
    .secondary-button:hover { background: #3a3a3e; }
    .action-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    /* Modal overlay and content styling */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7);
      display: none; align-items: center; justify-content: center; z-index: 1000; animation: fadeIn 0.3s;
    }
    .modal-overlay.active { display: flex; }
    .modal-content {
      background: var(--card-bg); padding: 25px; border-radius: 16px; width: 90%; max-width: 320px;
      text-align: center; animation: slideIn 0.3s;
    }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-content h3 { margin-top: 0; font-size: 20px; }
    .modal-content p { color: var(--text-muted-color); margin-bottom: 25px; }
    .modal-actions { display: flex; gap: 10px; }

    /* Custom Notification/Message Box */
    #custom-notification {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        font-size: 14px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    #custom-notification.show {
        opacity: 1;
        visibility: visible;
    }
    #custom-notification.error {
        background-color: var(--error-color);
    }
    #custom-notification.success {
        background-color: var(--success-color);
    }

    /* Withdrawal Form Specific Styles */
    .form-group {
        margin-bottom: 15px;
        text-align: left;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        color: var(--text-muted-color);
    }
    .form-group input[type="number"],
    .form-group input[type="text"],
    .form-group select {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background-color: var(--secondary-color);
        color: var(--text-color);
        font-size: 15px;
    }
    .form-group input::placeholder {
        color: #777;
    }
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(46, 217, 20, 0.3);
    }
    .current-balance-info {
        font-size: 15px;
        color: var(--accent-color);
        margin-bottom: 20px;
        text-align: center;
    }
    .warning-message {
        font-size: 13px;
        color: var(--accent-color);
        background: rgba(255, 140, 0, 0.1);
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--accent-color);
        margin-bottom: 20px;
        white-space: pre-wrap; /* For multi-line messages */
    }

    /* Referral Section Specific Styles */
    .referral-link-container {
        display: flex;
        margin-bottom: 15px;
        background-color: var(--secondary-color);
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .referral-link-container input {
        flex-grow: 1;
        padding: 10px 15px;
        border: none;
        background: transparent;
        color: var(--text-color);
        font-size: 14px;
        outline: none;
        cursor: text;
    }
    .referral-link-container button {
        background: var(--primary-color);
        color: #000;
        padding: 10px 15px;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s ease;
        font-weight: 600;
    }
    .referral-link-container button:hover {
        background: var(--primary-hover);
    }
    .referral-stats p {
        margin: 8px 0;
        font-size: 14px;
        color: var(--text-muted-color);
    }
    .referral-stats span {
        font-weight: bold;
        color: var(--accent-color);
    }
    .back-button {
        display: block;
        width: fit-content;
        margin: 20px auto 0;
        padding: 10px 20px;
        background: var(--card-bg);
        color: var(--primary-color);
        border-radius: 10px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 600;
        transition: background-color 0.2s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .back-button:hover {
        background: var(--secondary-color);
    }
  </style>

  <!-- Firebase SDKs -->
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src='//libtl.com/sdk.js' data-zone='9459352' data-sdk='show_9459352'></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">
    <main id="main-content">

      <!-- HOME VIEW -->
      <div id="home-view" class="view active">
        <div class="user-header-card">
          <div class="user-avatar" id="profile-pic">EE</div>
          <div class="user-info">
            <h2 class="username" id="username">Loading...</h2>
            <p class="title">Welcome Back!</p>
          </div>
        </div>
        <div class="balance-card">
            <p class="label">Total Balance</p>
            <h1 class="balance-value" id="balance-value">$0.00</h1>
            <p class="points-value"><i class="fa-solid fa-coins"></i> <span id="points-value">0</span> Points</p>
        </div>
        <h2 class="section-title">Quick Actions</h2>
        <div class="task-card" onclick="showView('tasks-view')">
            <div class="task-icon"><i class="fa-solid fa-list-check"></i></div>
            <div class="task-details"><h3>View Tasks</h3><p>Watch ads and complete tasks to earn points.</p></div>
            <div class="task-arrow"><i class="fa-solid fa-chevron-right"></i></div>
        </div>
        <div class="task-card" onclick="showView('withdraw-view')">
            <div class="task-icon"><i class="fa-solid fa-wallet"></i></div>
            <div class="task-details"><h3>Withdraw Funds</h3><p>Request to withdraw your available balance.</p></div>
            <div class="task-arrow"><i class="fa-solid fa-chevron-right"></i></div>
        </div>
        <!-- New AI-powered Earning Tips Card -->
        <div class="task-card" onclick="showEarningTips()">
            <div class="task-icon"><i class="fa-solid fa-lightbulb"></i></div>
            <div class="task-details"><h3>‚ú® ŸÜÿµÿßÿ¶ÿ≠ ŸÑŸÑÿ±ÿ®ÿ≠</h3><p>ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ÿßÿ≥ÿ™ÿ±ÿßÿ™Ÿäÿ¨Ÿäÿßÿ™ ŸÖÿÆÿµÿµÿ© ŸÑÿ≤ŸäÿßÿØÿ© ÿ£ÿ±ÿ®ÿßÿ≠ŸÉ.</p></div>
            <div class="task-arrow"><i class="fa-solid fa-chevron-right"></i></div>
        </div>
      </div>

      <!-- TASKS VIEW -->
      <div id="tasks-view" class="view">
        <h2 class="section-title">Earning Tasks</h2>
        <div class="task-card" onclick="showRewardedInterstitial()">
            <div class="task-icon"><i class="fa-solid fa-rectangle-ad"></i></div>
            <div class="task-details"><h3>Rewarded Interstitial</h3><p>Watch a full-screen ad to earn rewards.</p></div>
            <div class="task-arrow"><i class="fa-solid fa-play"></i></div>
        </div>
        <div class="task-card" onclick="showRewardedPopup()">
            <div class="task-icon"><i class="fa-solid fa-window-restore"></i></div>
            <div class="task-details"><h3>Rewarded Popup</h3><p>View a popup ad for quick points.</p></div>
            <div class="task-arrow"><i class="fa-solid fa-play"></i></div>
        </div>
      </div>

      <!-- LEADERBOARD VIEW -->
      <div id="leaderboard-view" class="view">
        <h2 class="section-title">Top Earners</h2>
        <div id="leaderboard-list"><!-- Leaderboard items will be generated here by JS --></div>
      </div>

      <!-- HISTORY VIEW -->
      <div id="history-view" class="view">
        <h2 class="section-title">Recent Activity</h2>
        <div id="history-list"><!-- History items will be generated here by JS --></div>
      </div>

      <!-- WITHDRAWAL VIEW -->
      <div id="withdraw-view" class="view">
        <h2 class="section-title">Withdraw Funds</h2>
        <p class="current-balance-info">Your Current Balance: <span id="current-withdraw-balance">0.00</span> Points ($<span id="current-withdraw-usd">0.00</span>)</p>
        <p class="warning-message" id="withdraw-warning-message">
            Minimum withdrawal for FaucetPay is 10 points.
            Minimum withdrawal for Any Other Wallet is 100 points.
            Please ensure you enter a correct wallet address for smooth withdrawals.
        </p>

        <div class="form-group">
            <label for="withdraw-amount">Amount to Withdraw (Points)</label>
            <input type="number" id="withdraw-amount" placeholder="Enter points to withdraw" min="1">
        </div>
        <div class="form-group">
            <label for="payment-method">Payment Method</label>
            <select id="payment-method">
                <option value="faucetpay">FaucetPay</option>
                <option value="other_wallet">Any Other Wallet</option>
            </select>
        </div>
        <div class="form-group">
            <label for="wallet-address">Wallet Address</label>
            <input type="text" id="wallet-address" placeholder="Enter your wallet address">
        </div>
        <button class="action-button primary-button" onclick="requestWithdraw()">Request Withdrawal</button>
        <button class="action-button secondary-button back-button" onclick="showView('home-view')">Back to Home</button>
      </div>

      <!-- REFERRAL VIEW -->
      <div id="referral-view" class="view">
        <h2 class="section-title">Referral Program</h2>
        <p>Invite your friends and earn <span id="referral-percentage"></span>% of their earnings!</p>
        <div class="referral-link-container">
            <input type="text" id="referral-link" readonly />
            <button onclick="copyReferralLink()">Copy Link</button>
        </div>
        <div class="referral-stats">
            <p>Total Referrals: <span id="total-referrals">0</span></p>
            <p>Earned from Referrals: <span id="earned-from-referrals">0.00</span> Points</p>
        </div>
        <button class="action-button secondary-button back-button" onclick="showView('home-view')">Back to Home</button>
      </div>

      <!-- EARNING TIPS VIEW (New AI-powered feature) -->
      <div id="earning-tips-view" class="view">
          <h2 class="section-title">‚ú® ŸÜÿµÿßÿ¶ÿ≠ ŸÑŸÑÿ±ÿ®ÿ≠</h2>
          <div class="card-bg p-4 rounded-lg shadow-md mb-4 text-center">
              <p id="tips-display" class="text-muted-color">ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑÿ≤ÿ± ÿ£ÿØŸÜÿßŸá ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÜÿµÿßÿ¶ÿ≠ ŸÖÿÆÿµÿµÿ©!</p>
              <div id="tips-loading" class="text-center text-primary-color mt-4 hidden">
                  <i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿ™ŸàŸÑŸäÿØ ÿßŸÑŸÜÿµÿßÿ¶ÿ≠...
              </div>
          </div>
          <button class="action-button primary-button" onclick="generateEarningTips()">ÿ™ŸàŸÑŸäÿØ ŸÜÿµÿßÿ¶ÿ≠ ÿ¨ÿØŸäÿØÿ©</button>
          <button class="action-button secondary-button back-button" onclick="showView('home-view')">ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</button>
      </div>

    </main>

    <nav class="footer-nav">
      <button class="nav-button active" onclick="showView('home-view')"><i class="icon fa-solid fa-house"></i>Home</button>
      <button class="nav-button" onclick="showView('tasks-view')"><i class="icon fa-solid fa-list-check"></i>Tasks</button>
      <button class="nav-button" onclick="showView('leaderboard-view')"><i class="icon fa-solid fa-trophy"></i>Leaders</button>
      <button class="nav-button" onclick="showView('history-view')"><i class="icon fa-solid fa-clock-rotate-left"></i>History</button>
      <button class="nav-button" onclick="showView('referral-view')"><i class="icon fa-solid fa-users"></i>Referral</button>
    </nav>
  </div>

  <!-- Custom Notification Display -->
  <div id="custom-notification" class="custom-notification"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- Firebase Configuration (Replace with your actual config) ---
    // IMPORTANT: Use __firebase_config and __app_id global variables provided by the Canvas environment.
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'easy-earning-bot-default';

    // Global Firebase and Telegram Mini App variables
    let firebaseApp = null;
    let db = null;
    let telegramUserId = null;
    let telegramUsername = null;
    let isAppReady = false;

    // --- Constants ---
    const POINTS_PER_AD = 1; // Points earned per ad view (from second script)
    const RATE_PER_POINT = 0.05; // USD value per point (from second script)
    const MIN_WITHDRAW_POINTS_FAUCETPAY = 10;
    const MIN_WITHDRAW_POINTS_OTHER_WALLET = 100;
    const REFERRAL_PERCENTAGE = 0.10; // 10% referral earnings

    // Telegram Bot API details (Replace with your actual bot token and admin ID)
    const BOT_TOKEN = '7201062892:AAGewLnDhE6l7buTuXAIScVhI4d-XJZZ5Hs'; // Your bot token
    const ADMIN_USER_ID = '6357701459'; // Your Telegram Admin User ID

    // --- State Variables (Managed by Firestore) ---
    let points = 0;
    let balance = 0.00; // USD balance
    let historyLog = []; // Stored in Firestore as part of user document
    let referrerId = null;
    let totalReferrals = 0;
    let earnedFromReferrals = 0.00;

    // --- DOM Elements ---
    const usernameEl = document.getElementById('username');
    const profilePicDiv = document.getElementById('profile-pic');
    const pointsValueEl = document.getElementById('points-value');
    const balanceValueEl = document.getElementById('balance-value');
    const leaderboardListEl = document.getElementById('leaderboard-list');
    const historyListEl = document.getElementById('history-list');
    const customNotificationEl = document.getElementById('custom-notification');

    // Withdrawal View Elements
    const currentWithdrawBalanceEl = document.getElementById('current-withdraw-balance');
    const currentWithdrawUsdEl = document.getElementById('current-withdraw-usd');
    const withdrawAmountInput = document.getElementById('withdraw-amount');
    const paymentMethodSelect = document.getElementById('payment-method');
    const walletAddressInput = document.getElementById('wallet-address');
    const withdrawWarningMessageEl = document.getElementById('withdraw-warning-message');

    // Referral View Elements
    const referralPercentageEl = document.getElementById('referral-percentage');
    const referralLinkInput = document.getElementById('referral-link');
    const totalReferralsEl = document.getElementById('total-referrals');
    const earnedFromReferralsEl = document.getElementById('earned-from-referrals');

    // Earning Tips View Elements
    const earningTipsViewEl = document.getElementById('earning-tips-view');
    const tipsDisplayEl = document.getElementById('tips-display');
    const tipsLoadingEl = document.getElementById('tips-loading');

    // --- Core App Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        initApp();
    });

    async function initApp() {
        showNotification('Loading app...', 'info');
        try {
            // Initialize Telegram WebApp
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                Telegram.WebApp.BackButton.onClick(handleBackButtonClick); // Set up back button listener
                Telegram.WebApp.onEvent('backButtonClicked', handleBackButtonClick); // Fallback/alternative
                
                const initDataUnsafe = Telegram.WebApp.initDataUnsafe;
                if (initDataUnsafe && initDataUnsafe.user && initDataUnsafe.user.id) {
                    telegramUserId = initDataUnsafe.user.id.toString();
                    telegramUsername = initDataUnsafe.user.username || '';
                    console.log("Telegram User ID:", telegramUserId);
                    console.log("Telegram Username:", telegramUsername);

                    // Initialize Firebase
                    if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                        showNotification("Firebase config is missing or incomplete. Cannot load user data.", 'error');
                        isAppReady = false;
                        return;
                    }
                    firebaseApp = initializeApp(firebaseConfig);
                    db = getFirestore(firebaseApp);
                    console.log("Firebase initialized.");

                    // Load user data and set up real-time listener
                    await loadUserDataFromFirestore(appId, telegramUserId);

                    // Process referral parameter from Telegram initData
                    const urlParams = new URLSearchParams(Telegram.WebApp.initData);
                    const startParam = urlParams.get('start_param');
                    if (startParam && startParam.startsWith('ref_')) {
                        const foundReferrerId = startParam.substring(4);
                        if (foundReferrerId !== telegramUserId) { // Prevent self-referral
                            const userDocRef = doc(db, `artifacts/${appId}/users/${telegramUserId}`);
                            const userDocSnap = await getDoc(userDocRef);
                            if (userDocSnap.exists() && !userDocSnap.data().referrerId) {
                                await updateDoc(userDocRef, { referrerId: foundReferrerId });
                                console.log(`Referrer ID ${foundReferrerId} set for user ${telegramUserId}.`);
                                // Increment referrer's totalReferrals
                                const referrerRef = doc(db, `artifacts/${appId}/users/${foundReferrerId}`);
                                await updateDoc(referrerRef, { totalReferrals: increment(1) });
                                console.log(`Referrer ${foundReferrerId}'s totalReferrals incremented.`);
                            } else if (!userDocSnap.exists()) {
                                // If user doc doesn't exist yet, referrerId will be set during doc creation
                                referrerId = foundReferrerId; // Store temporarily
                            }
                        }
                    }

                    isAppReady = true;
                    showNotification('App loaded successfully!', 'success');
                } else {
                    showNotification("Telegram User ID not available. App may not be running in Telegram.", 'error');
                    isAppReady = false;
                }
            } else {
                showNotification("Telegram WebApp SDK not found. Running in standalone mode.", 'info');
                // For standalone testing, you might mock telegramUserId
                telegramUserId = 'test_user_123';
                telegramUsername = 'testuser';
                
                // Initialize Firebase for standalone mode
                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                    showNotification("Firebase config is missing or incomplete. Cannot load user data.", 'error');
                    isAppReady = false;
                    return;
                }
                firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                console.log("Firebase initialized in standalone mode.");
                await loadUserDataFromFirestore(appId, telegramUserId);
                isAppReady = true;
                showNotification('App loaded successfully (standalone)!', 'success');
            }
        } catch (error) {
            console.error("Error initializing app:", error);
            showNotification(`Failed to initialize app: ${error.message}`, 'error');
            isAppReady = false;
        } finally {
            updateUI(); // Initial UI update
            renderLeaderboard(); // Render static leaderboard
            updateWithdrawalWarning(); // Update withdrawal warning message
        }

        // Initialize Automatic Ads (Monetag SDK)
        initializeInAppAds();
    }

    async function loadUserDataFromFirestore(appId, userId) {
        if (!db || !userId || !appId) {
            console.warn("Firestore, User ID, or App ID not ready. Skipping data load.");
            return;
        }

        const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);

        onSnapshot(userDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                points = data.points || 0;
                balance = data.balance || 0.00;
                historyLog = data.historyLog || [];
                referrerId = data.referrerId || null; // Load referrerId if exists
                totalReferrals = data.totalReferrals || 0;
                earnedFromReferrals = data.earnedFromReferrals || 0.00;

                // If user document was just created and we had a referrerId from initData
                if (!data.referrerId && referrerId && referrerId !== userId) {
                    updateDoc(userDocRef, { referrerId: referrerId })
                        .then(() => console.log(`Referrer ID ${referrerId} set for new user ${userId}.`))
                        .catch(e => console.error("Error setting referrer for new user:", e));
                }

                console.log("User data loaded/updated from Firestore:", data);
            } else {
                console.log("User document not found, creating new one for user:", userId);
                points = 0;
                balance = 0.00;
                historyLog = [];
                totalReferrals = 0;
                earnedFromReferrals = 0.00;

                setDoc(userDocRef, {
                    points: points,
                    balance: balance,
                    historyLog: historyLog,
                    referrerId: referrerId, // Set referrerId if it came from initData
                    totalReferrals: totalReferrals,
                    earnedFromReferrals: earnedFromReferrals
                })
                .then(() => console.log("New user document created successfully."))
                .catch(e => console.error("Error creating user document:", e));
            }
            updateUI();
        }, (error) => {
            console.error("Error listening to user document in Firestore:", error);
            showNotification(`Error loading user data: ${error.message}`, 'error');
        });
    }

    // --- Initialize Automatic Ads ---
    function initializeInAppAds() {
        if (typeof show_9459352 === 'function') {
            show_9459352({
              type: 'inApp',
              inAppSettings: {
                frequency: 2,
                capping: 0.1,
                interval: 30,
                timeout: 5,
                everyPage: false
              }
            });
            console.log("Automatic In-App Interstitial Ads Initialized.");
        } else {
            console.warn("Monetag SDK not ready for In-App Ads. Retrying...");
            setTimeout(initializeInAppAds, 2000);
        }
    }

    // --- View Management ---
    function showView(viewId) {
        document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        
        document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector(`.nav-button[onclick="showView('${viewId}')"]`);
        if(activeBtn) activeBtn.classList.add('active');
        
        // Update specific view contents when activated
        if (viewId === 'history-view') renderHistory();
        if (viewId === 'withdraw-view') updateWithdrawalView();
        if (viewId === 'referral-view') updateReferralView();
        if (viewId === 'earning-tips-view') updateEarningTipsView(); // New: Update tips view

        // Manage Telegram BackButton visibility
        if (window.Telegram && Telegram.WebApp && Telegram.WebApp.BackButton) {
            if (viewId === 'home-view') {
                Telegram.WebApp.BackButton.hide();
            } else {
                Telegram.WebApp.BackButton.show();
            }
        }
    }

    // Handles Telegram's native back button click
    function handleBackButtonClick() {
        const currentActiveView = document.querySelector('.view.active');
        if (currentActiveView && currentActiveView.id !== 'home-view') {
            showView('home-view');
        } else {
            // If on home view, close the Mini App
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.close();
            }
        }
    }

    // --- Data Display Update ---
    function updateUI() {
        if (!telegramUserId) {
            usernameEl.textContent = "Loading...";
            profilePicDiv.textContent = "EE";
            pointsValueEl.textContent = "0";
            balanceValueEl.textContent = "$0.00";
            return;
        }

        usernameEl.textContent = telegramUsername || 'Telegram User';
        if (Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user && Telegram.WebApp.initDataUnsafe.user.photo_url) {
            profilePicDiv.innerHTML = `<img src="${Telegram.WebApp.initDataUnsafe.user.photo_url}" alt="P">`;
        } else {
            profilePicDiv.textContent = (telegramUsername || 'U').charAt(0);
        }

        pointsValueEl.textContent = points;
        balanceValueEl.textContent = `$${balance.toFixed(2)}`;
        
        // Update withdrawal view if it's active
        if (document.getElementById('withdraw-view').classList.contains('active')) {
            updateWithdrawalView();
        }
        // Update referral view if it's active
        if (document.getElementById('referral-view').classList.contains('active')) {
            updateReferralView();
        }
        // Update earning tips view if it's active
        if (document.getElementById('earning-tips-view').classList.contains('active')) {
            updateEarningTipsView();
        }
    }

    // --- History Logic ---
    async function addToHistory(type, detail) {
        if (!db || !telegramUserId) {
            console.error("Firestore or user ID not ready for history update.");
            return;
        }
        const timestamp = new Date().toISOString();
        const newEntry = { type, detail, timestamp };
        
        // Prepend new entry and limit history to 50 items
        const updatedHistory = [newEntry, ...historyLog].slice(0, 50);
        
        const userDocRef = doc(db, `artifacts/${appId}/users/${telegramUserId}`);
        try {
            await updateDoc(userDocRef, { historyLog: updatedHistory });
            historyLog = updatedHistory; // Update local state after successful Firestore update
            console.log("History updated in Firestore.");
        } catch (error) {
            console.error("Error updating history in Firestore:", error);
        }
    }

    function renderHistory() {
        const list = historyListEl;
        if (historyLog.length === 0) {
            list.innerHTML = `<div class="list-item"><div class="info"><div class="name">No activity yet.</div><div class="detail">Watch some ads to get started!</div></div></div>`;
            return;
        }
        
        list.innerHTML = historyLog.map(item => {
            const icon = item.type === 'earn' 
                ? '<i class="fa-solid fa-plus-circle" style="color: var(--primary-color);"></i>' 
                : '<i class="fa-solid fa-paper-plane" style="color: var(--accent-color);"></i>';
            return `
                <div class="list-item">
                    <div class="history-icon">${icon}</div>
                    <div class="info">
                        <div class="name">${item.detail}</div>
                        <div class="detail">${new Date(item.timestamp).toLocaleString()}</div>
                    </div>
                </div>`;
        }).join('');
    }

    // --- Leaderboard Logic (Static for now, can be dynamic with Firestore) ---
    function renderLeaderboard() {
        const leaderboardData = [
            { name: "CryptoKing", score: 2540, avatar: "https://i.pravatar.cc/150?img=1" },
            { name: "Elena", score: 2210, avatar: "https://i.pravatar.cc/150?img=2" },
            { name: "ProMiner", score: 1980, avatar: "https://i.pravatar.cc/150?img=3" },
            { name: "Aisha", score: 1750, avatar: "https://i.pravatar.cc/150?img=4" },
            { name: "BotMaster", score: 1530, avatar: "https://i.pravatar.cc/150?img=5" },
        ];
        
        leaderboardListEl.innerHTML = leaderboardData.map((user, index) => `
            <div class="list-item">
                <div class="rank">#${index + 1}</div>
                <img src="${user.avatar}" class="avatar" alt="Avatar">
                <div class="info"><div class="name">${user.name}</div></div>
                <div class="score">${user.score} pts</div>
            </div>
        `).join('');
    }

    // --- Earning Functions ---
    async function grantReward() {
        if (!db || !telegramUserId) {
            showNotification("App not ready. Please wait.", 'error');
            return;
        }

        const userDocRef = doc(db, `artifacts/${appId}/users/${telegramUserId}`);
        let pointsToAdd = POINTS_PER_AD;
        let usdToAdd = pointsToAdd * RATE_PER_POINT;

        try {
            // Update current user's points and balance
            await updateDoc(userDocRef, {
                points: increment(pointsToAdd),
                balance: increment(usdToAdd)
            });
            console.log(`User ${telegramUserId} earned ${pointsToAdd} points ($${usdToAdd.toFixed(2)}).`);

            // Handle referral earnings
            if (referrerId && referrerId !== telegramUserId) {
                const referrerEarnPoints = pointsToAdd * REFERRAL_PERCENTAGE;
                const referrerEarnUSD = usdToAdd * REFERRAL_PERCENTAGE;
                const referrerDocRef = doc(db, `artifacts/${appId}/users/${referrerId}`);
                
                await updateDoc(referrerDocRef, {
                    earnedFromReferrals: increment(referrerEarnPoints),
                    points: increment(referrerEarnPoints), // Add referral points to referrer's main points too
                    balance: increment(referrerEarnUSD) // Add referral USD to referrer's main balance too
                });
                console.log(`Referrer ${referrerId} earned ${referrerEarnPoints} points ($${referrerEarnUSD.toFixed(2)}) from referral.`);
            }

            showNotification(`Congratulations! You've earned +${pointsToAdd} point.`, 'success');
            addToHistory('earn', `+${pointsToAdd} Point(s) from Ad`);
            Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        } catch (error) {
            console.error("Error granting reward or updating Firestore:", error);
            showNotification(`Failed to earn reward: ${error.message}`, 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        }
    }

    function showRewardedInterstitial() {
        if (!isAppReady) {
            showNotification("App is not fully loaded yet. Please wait.", 'info');
            return;
        }
        if (typeof show_9459352 !== 'function') {
            showNotification('Ad provider is not ready. Please try again.', 'error');
            return;
        }
        showNotification('Loading ad...', 'info');
        show_9459352().then(grantReward).catch(e => {
            console.error("Rewarded Interstitial Ad failed:", e);
            showNotification('Ad could not be shown. Please try again.', 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        });
    }

    function showRewardedPopup() {
        if (!isAppReady) {
            showNotification("App is not fully loaded yet. Please wait.", 'info');
            return;
        }
        if (typeof show_9459352 !== 'function') {
            showNotification('Ad provider is not ready. Please try again.', 'error');
            return;
        }
        showNotification('Loading ad...', 'info');
        show_9459352('pop').then(grantReward).catch(e => {
            console.error("Rewarded Popup Ad failed:", e);
            showNotification('Ad could not be shown. Please try again.', 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        });
    }

    // --- Custom Notification Function ---
    let notificationTimeout;
    function showNotification(message, type = 'info', duration = 3000) {
        customNotificationEl.textContent = message;
        customNotificationEl.className = 'custom-notification show'; // Reset classes
        if (type === 'error') {
            customNotificationEl.classList.add('error');
        } else if (type === 'success') {
            customNotificationEl.classList.add('success');
        }
        
        clearTimeout(notificationTimeout);
        notificationTimeout = setTimeout(() => {
            customNotificationEl.classList.remove('show');
        }, duration);
    }

    // --- Withdrawal Logic ---
    function updateWithdrawalView() {
        currentWithdrawBalanceEl.textContent = points.toFixed(0);
        currentWithdrawUsdEl.textContent = balance.toFixed(2);
        updateWithdrawalWarning();
    }

    function updateWithdrawalWarning() {
        const selectedMethod = paymentMethodSelect.value;
        let minPoints = 0;
        if (selectedMethod === 'faucetpay') {
            minPoints = MIN_WITHDRAW_POINTS_FAUCETPAY;
        } else {
            minPoints = MIN_WITHDRAW_POINTS_OTHER_WALLET;
        }
        withdrawWarningMessageEl.innerHTML = `
            Minimum withdrawal for FaucetPay is ${MIN_WITHDRAW_POINTS_FAUCETPAY} points.
            Minimum withdrawal for Any Other Wallet is ${MIN_WITHDRAW_POINTS_OTHER_WALLET} points.<br>
            Your current balance: ${points.toFixed(0)} points ($${balance.toFixed(2)}).<br>
            Please ensure you enter a correct wallet address for smooth withdrawals.
        `;
    }

    paymentMethodSelect.addEventListener('change', updateWithdrawalWarning);

    async function requestWithdraw() {
        if (!isAppReady || !telegramUserId) {
            showNotification("App not ready. Please wait.", 'error');
            return;
        }

        const amount = parseFloat(withdrawAmountInput.value);
        const paymentMethod = paymentMethodSelect.value;
        const walletAddress = walletAddressInput.value.trim();

        let minRequiredPoints;
        let methodNameDisplay;

        if (paymentMethod === 'faucetpay') {
            minRequiredPoints = MIN_WITHDRAW_POINTS_FAUCETPAY;
            methodNameDisplay = 'FaucetPay';
        } else {
            minRequiredPoints = MIN_WITHDRAW_POINTS_OTHER_WALLET;
            methodNameDisplay = 'Any Other Wallet';
        }

        if (isNaN(amount) || amount <= 0) {
            showNotification("Please enter a valid amount.", 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            return;
        }

        if (amount < minRequiredPoints) {
            showNotification(`Minimum withdrawal for ${methodNameDisplay} is ${minRequiredPoints} points.`, 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            return;
        }

        if (amount > points) {
            showNotification(`Insufficient balance. You have ${points.toFixed(0)} points.`, 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            return;
        }

        if (!walletAddress) {
            showNotification("Please enter your wallet address.", 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            return;
        }

        try {
            const userDocRef = doc(db, `artifacts/${appId}/users/${telegramUserId}`);
            const usdAmount = amount * RATE_PER_POINT;

            // Deduct points and balance in Firestore
            await updateDoc(userDocRef, {
                points: increment(-amount),
                balance: increment(-usdAmount)
            });
            console.log(`Deducted ${amount} points ($${usdAmount.toFixed(2)}) from user ${telegramUserId}.`);

            // Send withdrawal request to admin via Telegram Bot API
            const userInfo = telegramUsername ? `@${telegramUsername} (ID: ${telegramUserId})` : `User ID: ${telegramUserId}`;
            const messageToAdmin = `üí∏ *New Withdrawal Request*\n\nüë§ *User:* ${userInfo}\nüí∞ *Amount:* ${amount} points ($${usdAmount.toFixed(2)})\nüí≥ *Method:* ${methodNameDisplay}\n‚úâÔ∏è *Wallet Address:* \`${walletAddress}\`\n\n_Please process this request._`;

            sendWithdrawRequestToAdmin(messageToAdmin, telegramUserId, amount, usdAmount);

            showNotification("Your withdrawal request has been sent successfully!", 'success');
            addToHistory('withdraw', `Requested ${amount} points ($${usdAmount.toFixed(2)}) via ${methodNameDisplay}`);
            Telegram.WebApp.HapticFeedback.notificationOccurred('success');

            // Clear form fields
            withdrawAmountInput.value = '';
            walletAddressInput.value = '';

        } catch (error) {
            console.error("Error during withdrawal process:", error);
            showNotification(`Withdrawal failed: ${error.message}`, 'error');
            Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        }
    }

    function sendWithdrawRequestToAdmin(message, userId, pointsAmount, usdAmount) {
        // Callback data format: approve_withdraw_<user_id>_<points>_<usd>
        const callbackData = `approve_withdraw_${userId}_${pointsAmount}_${usdAmount.toFixed(2)}`;
        
        const inlineKeyboard = {
            inline_keyboard: [
                [{ text: "‚úÖ Approve Withdrawal", callback_data: callbackData }]
            ]
        };
        const replyMarkup = encodeURIComponent(JSON.stringify(inlineKeyboard));

        fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${ADMIN_USER_ID}&text=${encodeURIComponent(message)}&parse_mode=Markdown&reply_markup=${replyMarkup}`)
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    console.log('Telegram Bot API: Message with approval button sent to admin successfully.');
                } else {
                    console.error('Telegram Bot API Error: Failed to send message to Telegram:', data.description || JSON.stringify(data));
                    showNotification('Failed to notify admin about withdrawal.', 'error');
                }
            })
            .catch(error => {
                console.error('Telegram Bot API Error: Network error during fetch to Telegram API:', error);
                showNotification('Network error sending withdrawal notification.', 'error');
            });
    }

    // --- Share & Referral ---
    function updateReferralView() {
        referralPercentageEl.textContent = (REFERRAL_PERCENTAGE * 100).toFixed(0);
        referralLinkInput.value = generateReferralLink();
        totalReferralsEl.textContent = totalReferrals;
        earnedFromReferralsEl.textContent = earnedFromReferrals.toFixed(0);
    }

    function generateReferralLink() {
        const botUsername = "Easyearing99_bot"; // Replace with your bot's actual username
        if (telegramUserId) {
            return `https://t.me/${botUsername}?startapp=ref_${telegramUserId}`;
        }
        return "Loading referral link...";
    }

    window.copyReferralLink = function() {
        if (!isAppReady || !telegramUserId) {
            showNotification("App not ready to copy link. Please wait.", 'error');
            return;
        }
        referralLinkInput.select();
        document.execCommand('copy');
        showNotification("Referral link copied successfully!", 'success');
        Telegram.WebApp.HapticFeedback.notificationOccurred('success');
    }

    // This function is for the 'Share' button in the footer nav
    function shareApp() {
        if (!telegramUserId) {
            showNotification("Could not get user data from Telegram.", 'error');
            return;
        }
        const referralLink = generateReferralLink();
        const text = `üéâ Join this amazing bot and start earning! Use my link to get a special bonus:`;
        const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=${encodeURIComponent(text)}`;
        Telegram.WebApp.openTelegramLink(shareUrl);
    }

    // --- New AI-Powered Earning Tips Logic ---
    function updateEarningTipsView() {
        // Reset display when entering the view
        tipsDisplayEl.textContent = 'ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑÿ≤ÿ± ÿ£ÿØŸÜÿßŸá ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÜÿµÿßÿ¶ÿ≠ ŸÖÿÆÿµÿµÿ©!';
        tipsLoadingEl.classList.add('hidden');
    }

    window.showEarningTips = function() {
        showView('earning-tips-view');
    }

    window.generateEarningTips = async function() {
        if (!isAppReady || !telegramUserId) {
            showNotification("App not ready. Please wait.", 'error');
            return;
        }

        tipsDisplayEl.textContent = ''; // Clear previous tips
        tipsLoadingEl.classList.remove('hidden'); // Show loading indicator

        const prompt = `ÿ£ŸÜÿß ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä ÿ™ÿ∑ÿ®ŸäŸÇ ÿ±ÿ®ÿ≠ ÿßŸÑŸÜŸÇÿßÿ∑. ŸÑÿØŸä ÿ≠ÿßŸÑŸäŸãÿß ${points} ŸÜŸÇÿ∑ÿ© Ÿàÿ±ÿµŸäÿØŸä ÿ®ÿßŸÑÿØŸàŸÑÿßÿ± ŸáŸà ${balance.toFixed(2)} ÿØŸàŸÑÿßÿ±. ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ±ÿ®ÿ≠ ŸÖŸÜ ÿßŸÑÿ•ÿ≠ÿßŸÑÿßÿ™ ŸáŸä ${REFERRAL_PERCENTAGE * 100}%. ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ŸÑŸÑÿ≥ÿ≠ÿ® ÿ•ŸÑŸâ FaucetPay ŸáŸà ${MIN_WITHDRAW_POINTS_FAUCETPAY} ŸÜŸÇÿ∑ÿ©ÿå Ÿàÿ•ŸÑŸâ ÿ£Ÿä ŸÖÿ≠ŸÅÿ∏ÿ© ÿ£ÿÆÿ±Ÿâ ŸáŸà ${MIN_WITHDRAW_POINTS_OTHER_WALLET} ŸÜŸÇÿ∑ÿ©.
        ÿ£ÿπÿ∑ŸÜŸä 3 ŸÜÿµÿßÿ¶ÿ≠ ŸÖŸàÿ¨ÿ≤ÿ© ŸàŸÖÿ®ÿ™ŸÉÿ±ÿ© (ŸÅŸä ÿ¥ŸÉŸÑ ŸÜŸÇÿßÿ∑) ÿ≠ŸàŸÑ ŸÉŸäŸÅŸäÿ© ÿ≤ŸäÿßÿØÿ© ÿ£ÿ±ÿ®ÿßÿ≠Ÿä ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ. ÿ±ŸÉÿ≤ ÿπŸÑŸâ ÿßÿ≥ÿ™ÿ±ÿßÿ™Ÿäÿ¨Ÿäÿßÿ™ ÿßŸÑÿ±ÿ®ÿ≠ ŸÖŸÜ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ŸàÿßŸÑÿ•ÿ≠ÿßŸÑÿßÿ™. ÿßÿ¨ÿπŸÑ ÿßŸÑŸÜÿµÿßÿ¶ÿ≠ ÿπŸÖŸÑŸäÿ© ŸàŸÖÿ≠ŸÅÿ≤ÿ© ŸàŸÖÿ®ÿßÿ¥ÿ±ÿ©.`;

        try {
            const apiKey = ""; // Canvas will provide this at runtime
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }]
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                tipsDisplayEl.textContent = text;
                showNotification("ÿ™ŸÖ ÿ™ŸàŸÑŸäÿØ ÿßŸÑŸÜÿµÿßÿ¶ÿ≠ ÿ®ŸÜÿ¨ÿßÿ≠!", 'success');
            } else {
                tipsDisplayEl.textContent = "ÿπÿ∞ÿ±ÿßŸãÿå ŸÑŸÖ ÿ£ÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿ™ŸàŸÑŸäÿØ ŸÜÿµÿßÿ¶ÿ≠ ŸÅŸä ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ≠ÿßŸÑŸä. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.";
                showNotification("ŸÅÿ¥ŸÑ ÿ™ŸàŸÑŸäÿØ ÿßŸÑŸÜÿµÿßÿ¶ÿ≠.", 'error');
                console.error("Gemini API response structure unexpected:", result);
            }
        } catch (error) {
            tipsDisplayEl.textContent = "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿÆÿØŸÖÿ© ÿßŸÑŸÜÿµÿßÿ¶ÿ≠. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑŸÉ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ŸàÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.";
            showNotification("ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿÆÿØŸÖÿ© ÿßŸÑŸÜÿµÿßÿ¶ÿ≠.", 'error');
            console.error("Error calling Gemini API:", error);
        } finally {
            tipsLoadingEl.classList.add('hidden'); // Hide loading indicator
        }
    }
</script>

</body>
</html>
